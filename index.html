<!doctype html>
<html lang="th" class="h-full">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ú‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</title>

<script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Sarabun:ital,wght@0,300;0,400;0,500;0,600;0,700;0,800;1,400&display=swap" rel="stylesheet">

<style>
    /* ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏ä‡πâ‡∏ü‡∏≠‡∏ô‡∏ï‡πå Sarabun ‡∏Å‡∏±‡∏ö‡∏ó‡∏∏‡∏Å Elements ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö */
    * {
        font-family: 'Sarabun', sans-serif !important;
    }

    /* ‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÉ‡∏´‡πâ‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°‡πÅ‡∏•‡∏∞‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢ */
    body, html, input, textarea, select, button, table, th, td, span, div, p, h1, h2, h3, h4, h5, h6 {
        font-family: 'Sarabun', sans-serif !important;
    }

    /* ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÉ‡∏ô Input ‡πÑ‡∏°‡πà‡∏¢‡∏≠‡∏°‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡πÉ‡∏ô‡∏ö‡∏≤‡∏á Browser */
    input[type="number"], input[type="text"] {
        font-family: 'Sarabun', sans-serif !important;
        font-variant-numeric: tabular-nums; /* ‡∏à‡∏±‡∏î‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡πÅ‡∏ô‡∏ß‡∏Å‡∏±‡∏ô */
    }
    
    /* ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ü‡∏≠‡∏ô‡∏ï‡πå Mono ‡πÄ‡∏î‡∏¥‡∏° (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ) ‡πÉ‡∏´‡πâ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÉ‡∏ä‡πâ Sarabun */
    .font-mono {
        font-family: 'Sarabun', sans-serif !important;
    }
</style>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&amp;display=swap" rel="stylesheet">

<style>
body { box-sizing: border-box; font-family: 'Sarabun', sans-serif; background-color: #f0fdf4; color: #4b5563; -webkit-tap-highlight-color: transparent; }
.gradient-bg { background-color: #C6E686; } 
.btn-primary { background: linear-gradient(135deg, #fcd34d 0%, #fbbf24 100%); color: #78350f; transition: all 0.2s ease; cursor: pointer; }
.btn-primary:active { transform: scale(0.96); }
.card-hover { background-color: white; transition: all 0.3s ease; border: 1px solid #e5e7eb; }
.input-field { background-color: #f9fafb; border: 1px solid #e5e7eb; transition: all 0.2s ease; }
.input-field:focus { background-color: white; border-color: #C6E686; box-shadow: 0 0 0 3px rgba(198, 230, 134, 0.4); outline: none; }
.sidebar-btn { width: 100%; text-align: left; padding: 12px 16px; margin-bottom: 8px; border-radius: 12px; display: flex; align-items: center; gap: 12px; color: #4b5563; background: transparent; border: none; cursor: pointer; min-height: 48px; }
.sidebar-btn:active { background-color: #ecfdf5; }
.sidebar-btn.active { background-color: #eefad2; color: #5a7a1a; font-weight: 600; }
@media (hover: hover) { .sidebar-btn:hover { background-color: #f7fee7; color: #5a7a1a; } .card-hover:hover { transform: translateY(-3px); box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1); border-color: #C6E686; } .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(251, 191, 36, 0.4); } }
.clickable-name { cursor: pointer; font-weight: 600; color: #65a30d; text-decoration: underline; text-underline-offset: 2px; }
.modal-overlay { background-color: rgba(255, 255, 255, 0.6); backdrop-filter: blur(8px); }
#student-modal { transition: opacity 0.2s ease; z-index: 100; } 
body.modal-active { overflow: hidden !important; }
#alert-modal, #confirm-modal, #loading-modal { z-index: 200; transition: opacity 0.2s ease; }
.hidden-force { display: none !important; }
.tab-btn { border-bottom: 3px solid transparent; color: #9ca3af; padding: 12px 16px; transition: all 0.2s; white-space: nowrap; cursor: pointer; }
.tab-btn.active { border-bottom: 3px solid #84cc16; color: #4d7c0f; font-weight: bold; background-color: #f7fee7; }
/* ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏ü‡∏≠‡∏ô‡∏ï‡πå Sarabun ‡∏à‡∏≤‡∏Å Google Fonts (‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô TH Sarabun New ‡∏ö‡∏ô‡πÄ‡∏ß‡πá‡∏ö) */
@import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap');

/* --- ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå (PDF ‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£) --- */
@media print {
    @page { 
        size: A4 portrait; 
        margin: 2cm; /* ‡∏Ç‡∏≠‡∏ö‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô */
    }

    /* ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏µ‡πÅ‡∏•‡∏∞‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î */
    body, #app { 
        background-color: white !important; 
        font-family: 'Sarabun', sans-serif !important;
        color: black !important;
    }

    /* ‡∏ã‡πà‡∏≠‡∏ô UI ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô */
    #sidebar, #sidebar-overlay, .no-print, button, input, 
    .shadow-sm, .shadow-lg, .shadow-xl, .rounded-3xl, .rounded-xl {
        display: none !important; 
        box-shadow: none !important;
        border: none !important;
        border-radius: 0 !important;
    }

    /* ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á Header/Footer ‡∏Ç‡∏≠‡∏á‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏© */
    #print-header, .print-footer { display: block !important; }

    /* ‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏™‡πâ‡∏ô‡∏î‡∏≥ ‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£ */
    .bg-white { background-color: transparent !important; border: none !important; }
    .border-gray-100, .border-b { border: none !important; }
    
    table {
        width: 100% !important;
        border-collapse: collapse !important;
        border: 1px solid black !important;
        font-size: 14pt !important; /* ‡∏Ç‡∏ô‡∏≤‡∏î‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£ */
    }

    th {
        border: 1px solid black !important;
        background-color: transparent !important; /* ‡∏•‡∏ö‡∏™‡∏µ‡πÄ‡∏ó‡∏≤‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏≠‡∏≠‡∏Å */
        color: black !important;
        text-align: center !important;
        font-weight: bold !important;
        padding: 5px !important;
    }

    td {
        border: 1px solid black !important;
        padding: 5px !important;
        color: black !important;
        vertical-align: top !important;
    }

    /* ‡πÅ‡∏õ‡∏•‡∏á‡∏õ‡πâ‡∏≤‡∏¢‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (Badge) ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤ */
    .rounded-full {
        background-color: transparent !important;
        color: black !important;
        border: none !important;
        padding: 0 !important;
        font-weight: normal !important;
    }
    
    /* ‡∏•‡∏ö‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÅ‡∏ñ‡∏ß */
    tr.bg-green-50\/50, tr.hover\:bg-gray-100 {
        background-color: transparent !important;
    }
}
</style>

<script>
// -----------------------------------------------------------
// ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ URL ‡∏Ç‡∏≠‡∏á Google Apps Script Web App ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£ Deploy
// -----------------------------------------------------------
const API_URL = "https://script.google.com/macros/s/AKfycbzkDOBBuhB-erTc_36OJ3kqVpUE7mh1JpEmSwDfVJMXgpALiLPZ40c470dBODmPQZVOsA/exec"

async function callApi(action, data = {}) {
const body = JSON.stringify({ action, ...data });
const response = await fetch(API_URL, {
method: 'POST',
body: body,
// ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡πÉ‡∏ä‡πâ text/plain ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á CORS preflight issues ‡∏Ç‡∏≠‡∏á Google Apps Script
headers: { "Content-Type": "text/plain;charset=utf-8" } 
});
return await response.json();
}

window.dataSdk = {
init: async (handler) => { window.dataSdkHandler = handler; await window.dataSdk.refresh(); return { isOk: true }; },
refresh: async () => { 
try {
const res = await callApi('getAllStudents');
if (res.success) { 
const mappedData = res.students.map(s => ({ ...s, __backendId: s.id })); 
if (window.dataSdkHandler?.onDataChanged) window.dataSdkHandler.onDataChanged(mappedData); 
return { isOk: true, data: mappedData }; 
} 
return { isOk: false, error: { message: res.message } };
} catch(e) { return { isOk: false, error: { message: e.message } }; }
},
create: async (data) => {
try {
const res = await callApi('createStudent', { data });
if(res.success) { await window.dataSdk.refresh(); return { isOk: true }; }
return { isOk: false, error: { message: res.message } };
} catch(e) { return { isOk: false, error: { message: e.message } }; }
},
createBulk: async (dataArray) => {
try {
const res = await callApi('createStudentsBulk', { data: dataArray });
if(res.success) { await window.dataSdk.refresh(); return { isOk: true }; }
return { isOk: false, error: { message: res.message } };
} catch(e) { return { isOk: false, error: { message: e.message } }; }
},
updateScoresBulk: async (dataArray) => {
try {
const res = await callApi('updateScoresBulk', { data: dataArray });
if(res.success) { await window.dataSdk.refresh(); return { isOk: true, message: res.message }; }
return { isOk: false, error: { message: res.message } };
} catch(e) { return { isOk: false, error: { message: e.message } }; }
},
update: async (data) => {
try {
const updateData = { ...data, id: data.__backendId };
const res = await callApi('updateStudent', { data: updateData });
if(res.success) { await window.dataSdk.refresh(); return { isOk: true }; }
return { isOk: false, error: { message: res.message } };
} catch(e) { return { isOk: false, error: { message: e.message } }; }
},
delete: async (data) => {
try {
const res = await callApi('deleteStudent', { id: data.__backendId });
if(res.success) { await window.dataSdk.refresh(); return { isOk: true }; }
return { isOk: false, error: { message: res.message } };
} catch(e) { return { isOk: false, error: { message: e.message } }; }
},
deleteBulk: async (ids) => {
try {
const res = await callApi('deleteStudentsBulk', { ids });
if(res.success) { await window.dataSdk.refresh(); return { isOk: true }; }
return { isOk: false, error: { message: res.message } };
} catch(e) { return { isOk: false, error: { message: e.message } }; }
}
};
</script>
</head>
<body class="h-full">
<div id="app" class="h-full w-full"></div>

<div id="student-modal" class="hidden-force fixed inset-0 flex items-center justify-center z-[100]">
    <div class="modal-overlay absolute w-full h-full" onclick="closeModal()"></div>
    <div class="bg-white w-full h-full md:w-11/12 md:h-auto md:max-w-4xl md:max-h-[90vh] md:rounded-[2rem] shadow-2xl z-[101] flex flex-col border border-lime-100 relative transform transition-all">
        
        <div class="flex justify-between items-center px-6 py-4 bg-gradient-to-r from-lime-50 to-white border-b border-lime-100 shrink-0">
            <div class="flex items-center gap-3">
                <div class="p-2 bg-lime-100 rounded-full text-lime-600"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg></div>
                <p class="text-lg md:text-xl font-bold text-lime-800" id="modal-title">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>
            </div>
            <button type="button" class="text-gray-400 hover:text-red-500 p-2 rounded-full active:bg-gray-100" onclick="closeModal()"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
        </div>

        <div id="add-mode-tabs" class="flex px-4 border-b border-gray-100 bg-gray-50/50 hidden overflow-x-auto shrink-0">
            <button type="button" onclick="switchAddTab('single')" id="tab-single" class="tab-btn active flex-1 md:flex-none">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏µ‡∏•‡∏∞‡∏Ñ‡∏ô</button>
            <button type="button" onclick="switchAddTab('multiple')" id="tab-multiple" class="tab-btn flex-1 md:flex-none">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏•‡∏≤‡∏¢‡∏Ñ‡∏ô</button>
            <button type="button" onclick="switchAddTab('excel')" id="tab-excel" class="tab-btn flex-1 md:flex-none">Import ‡∏ä‡∏∑‡πà‡∏≠</button>
            <button type="button" onclick="switchAddTab('score')" id="tab-score" class="tab-btn flex-1 md:flex-none text-purple-600 font-bold">Import ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</button>
            <button type="button" onclick="switchAddTab('practical')" id="tab-practical" class="tab-btn flex-1 md:flex-none text-indigo-600 font-bold">Import ‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥</button>
        </div>

        <div class="overflow-y-auto p-4 md:p-8 flex-1 bg-white">

            <div id="view-single" class="block pb-20 md:pb-0">
                <form id="student-form" onsubmit="handleSingleSubmit(event)">
                    <input type="hidden" id="student-backend-id">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6 mb-4">
                        <div><label class="block text-gray-500 text-xs font-bold mb-2 uppercase">‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô (13 ‡∏´‡∏•‡∏±‡∏Å)</label><input type="text" id="form-national-id" class="w-full px-4 py-3 rounded-xl border-gray-200 focus:border-lime-400 input-field" placeholder="00xxxxxxxxxxx" required></div>
                        <div><label class="block text-gray-500 text-xs font-bold mb-2 uppercase">‡∏£‡∏´‡∏±‡∏™‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏™‡∏≠‡∏ö</label><input type="text" id="form-exam-id" class="w-full px-4 py-3 rounded-xl border-gray-200 input-field" required></div>
                        <div><label class="block text-gray-500 text-xs font-bold mb-2 uppercase">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô</label><select id="form-grade" class="w-full px-4 py-3 rounded-xl border-gray-200 input-field bg-white"><option value="p4">‡∏õ‡∏£‡∏∞‡∏ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà 4</option><option value="p5">‡∏õ‡∏£‡∏∞‡∏ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà 5</option><option value="p6">‡∏õ‡∏£‡∏∞‡∏ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà 6</option><option value="m1">‡∏°‡∏±‡∏ò‡∏¢‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà 1</option><option value="m3">‡∏°‡∏±‡∏ò‡∏¢‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà 3</option><option value="m4">‡∏°‡∏±‡∏ò‡∏¢‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà 4</option></select></div>
                        <div><label class="block text-gray-500 text-xs font-bold mb-2 uppercase">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label><input type="text" id="form-name" class="w-full px-4 py-3 rounded-xl border-gray-200 input-field" required></div>
                        <div class="md:col-span-2"><label class="block text-gray-500 text-xs font-bold mb-2 uppercase">‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</label><input type="text" id="form-school" class="w-full px-4 py-3 rounded-xl border-gray-200 input-field"></div>
                    </div>

                    <div class="bg-lime-50/50 p-4 rounded-2xl border border-lime-100 mb-4">
                        <h3 class="text-sm font-bold text-lime-700 mb-3 uppercase flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path></svg>
                            ‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                            <div>
                                <label class="text-[10px] text-gray-500 font-bold uppercase mb-1 block">‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö 1</label>
                                <select id="form-choice-1" class="w-full px-3 py-2 rounded-lg border-gray-200 text-sm input-field bg-white">
                                    <option value="">- ‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏ -</option>
                                    <optgroup label="‡∏°.1"><option value="S&M">S&M</option><option value="GATE">GATE</option><option value="EIS">EIS</option></optgroup>
                                    <optgroup label="‡∏°.4"><option value="SME">SME</option><option value="GATE">GATE</option></optgroup>
                                </select>
                            </div>
                            <div>
                                <label class="text-[10px] text-gray-500 font-bold uppercase mb-1 block">‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö 2</label>
                                <select id="form-choice-2" class="w-full px-3 py-2 rounded-lg border-gray-200 text-sm input-field bg-white">
                                    <option value="">- ‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏ -</option>
                                    <optgroup label="‡∏°.1"><option value="S&M">S&M</option><option value="GATE">GATE</option><option value="EIS">EIS</option></optgroup>
                                    <optgroup label="‡∏°.4"><option value="SME">SME</option><option value="GATE">GATE</option></optgroup>
                                </select>
                            </div>
                            <div>
                                <label class="text-[10px] text-gray-500 font-bold uppercase mb-1 block">‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö 3</label>
                                <select id="form-choice-3" class="w-full px-3 py-2 rounded-lg border-gray-200 text-sm input-field bg-white">
                                    <option value="">- ‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏ -</option>
                                    <optgroup label="‡∏°.1"><option value="S&M">S&M</option><option value="GATE">GATE</option><option value="EIS">EIS</option></optgroup>
                                    <optgroup label="‡∏°.4"><option value="SME">SME</option><option value="GATE">GATE</option></optgroup>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div id="score-section" class="bg-amber-50/50 p-4 md:p-6 rounded-2xl border border-amber-100">
                        <h3 class="text-sm font-bold text-amber-600 mb-4 uppercase">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏≠‡∏ö</h3>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-3 md:gap-4">
                            <div><label class="text-xs text-gray-500 font-semibold">‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå (40)</label><input type="number" step="0.01" id="score-science" class="w-full px-3 py-2 rounded-lg border-gray-200 text-center font-bold text-lime-600 input-field"></div>
                            <div><label class="text-xs text-gray-500 font-semibold">‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå (30)</label><input type="number" step="0.01" id="score-math" class="w-full px-3 py-2 rounded-lg border-gray-200 text-center font-bold text-lime-600 input-field"></div>
                            <div><label class="text-xs text-gray-500 font-semibold">‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏© (40)</label><input type="number" step="0.01" id="score-english" class="w-full px-3 py-2 rounded-lg border-gray-200 text-center font-bold text-lime-600 input-field"></div>
                        </div>
                    </div>

                    <div class="flex justify-end pt-6 gap-3 md:relative fixed bottom-0 left-0 w-full bg-white p-4 border-t border-gray-100 md:border-0 md:bg-transparent md:p-0 z-10">
                        <button type="button" onclick="closeModal()" class="flex-1 md:flex-none px-6 py-3 bg-gray-100 text-gray-600 rounded-xl font-bold">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                        <button type="submit" class="flex-1 md:flex-none px-8 py-3 btn-primary rounded-xl font-bold shadow-lg shadow-amber-200/50">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                    </div>
                </form>
            </div>

            <div id="view-multiple" class="hidden h-full flex flex-col">
                <div class="flex-1 overflow-auto border border-gray-100 rounded-xl mb-4 shadow-inner bg-gray-50/50">
                    <table class="w-full text-sm text-left text-gray-500" id="multiple-table"><thead class="text-xs text-gray-500 uppercase bg-gray-100 sticky top-0"><tr><th class="px-2 py-3">‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£</th><th class="px-2 py-3">‡∏£‡∏´‡∏±‡∏™</th><th class="px-2 py-3">‡∏ä‡∏∑‡πà‡∏≠</th><th class="px-2 py-3">‡∏ä‡∏±‡πâ‡∏ô</th><th class="px-2 py-3">‡∏£‡∏£.</th><th class="px-1 py-3">‡∏•‡∏ö</th></tr></thead><tbody id="multiple-tbody" class="bg-white"></tbody></table>
                </div>
                <div class="flex justify-between items-center bg-white p-2 rounded-lg gap-2">
                    <button type="button" onclick="addMultipleRow()" class="flex-1 text-lime-600 font-bold bg-lime-50 px-3 py-3 rounded-lg">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ñ‡∏ß</button>
                    <button type="button" onclick="handleMultipleSubmit()" class="flex-1 btn-primary px-3 py-3 rounded-lg font-bold text-yellow-900 shadow-md">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                </div>
            </div>

            <div id="view-excel" class="hidden">
                <div class="border-2 border-dashed border-lime-200 bg-lime-50/30 rounded-2xl p-6 md:p-10 text-center hover:bg-lime-50 transition-colors cursor-pointer" id="drop-zone-name">
                    <div class="w-16 h-16 bg-lime-100 text-lime-500 rounded-full flex items-center justify-center mx-auto mb-4"><svg class="h-8 w-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg></div>
                    <label for="excel-upload-name" class="cursor-pointer block"><span class="block text-lg font-bold text-lime-700">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel (‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠)</span><span class="block text-sm text-lime-500 mt-1">.xlsx ‡∏´‡∏£‡∏∑‡∏≠ .xls</span><input id="excel-upload-name" type="file" class="hidden" accept=".xlsx, .xls" onchange="handleExcelUpload(this, 'student')"></label>
                </div>
                <div class="mt-6 bg-amber-50 p-6 rounded-2xl border border-amber-100">
                    <h4 class="font-bold text-amber-700 mb-2">‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÑ‡∏ü‡∏•‡πå Excel</h4><ul class="text-sm text-amber-800 space-y-1 ml-7 list-disc"><li>A: ‡∏£‡∏´‡∏±‡∏™‡∏™‡∏≠‡∏ö</li><li>B: ‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏Ø (00 ‡πÑ‡∏î‡πâ)</li><li>C: ‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</li><li>D: ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô (p6, m3)</li><li>E: ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</li></ul>
                </div>
                <div id="excel-preview-area" class="mt-6 hidden">
                    <div class="flex justify-between items-center mb-3"><h4 class="font-bold text-gray-700 text-sm">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (<span id="excel-count">0</span> ‡∏Ñ‡∏ô)</h4><button type="button" onclick="confirmExcelImport('student')" class="px-4 py-2 btn-primary rounded-lg font-bold text-sm shadow-md">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button></div>
                    <div class="overflow-auto max-h-48 border border-gray-200 rounded-xl text-xs bg-white"><table class="w-full text-left" id="excel-preview-table"></table></div>
                </div>
            </div>

            <div id="view-score" class="hidden">
                <div class="border-2 border-dashed border-purple-200 bg-purple-50/30 rounded-2xl p-6 md:p-10 text-center hover:bg-purple-50 transition-colors cursor-pointer" id="drop-zone-score">
                    <div class="w-16 h-16 bg-purple-100 text-purple-500 rounded-full flex items-center justify-center mx-auto mb-4"><svg class="h-8 w-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg></div>
                    <label for="excel-upload-score" class="cursor-pointer block"><span class="block text-lg font-bold text-purple-700">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel (‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô)</span><span class="block text-sm text-purple-500 mt-1">.xlsx ‡∏´‡∏£‡∏∑‡∏≠ .xls</span><input id="excel-upload-score" type="file" class="hidden" accept=".xlsx, .xls" onchange="handleExcelUpload(this, 'score')"></label>
                </div>
                <div class="mt-6 bg-purple-50 p-6 rounded-2xl border border-purple-100">
                    <h4 class="font-bold text-purple-700 mb-2">‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÑ‡∏ü‡∏•‡πå‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</h4><ul class="text-sm text-purple-800 space-y-1 ml-7 list-disc"><li>A: ‡∏£‡∏´‡∏±‡∏™‡∏™‡∏≠‡∏ö (‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö)</li><li>B: ‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå (‡πÄ‡∏ï‡πá‡∏° 40)</li><li>C: ‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå (‡πÄ‡∏ï‡πá‡∏° 30)</li><li>D: ‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏© (‡πÄ‡∏ï‡πá‡∏° 30)</li></ul>
                </div>
                <div id="score-preview-area" class="mt-6 hidden">
                    <div class="flex justify-between items-center mb-3"><h4 class="font-bold text-gray-700 text-sm">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô (<span id="score-count">0</span> ‡∏Ñ‡∏ô)</h4><button type="button" onclick="confirmExcelImport('score')" class="px-4 py-2 bg-purple-500 text-white rounded-lg font-bold text-sm shadow-md hover:bg-purple-600">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</button></div>
                    <div class="overflow-auto max-h-48 border border-gray-200 rounded-xl text-xs bg-white"><table class="w-full text-left" id="score-preview-table"></table></div>
                </div>
            </div>

            <div id="view-practical" class="hidden">
                <div class="border-2 border-dashed border-indigo-200 bg-indigo-50/30 rounded-2xl p-6 md:p-10 text-center hover:bg-indigo-50 transition-colors cursor-pointer" id="drop-zone-practical">
                    <div class="w-16 h-16 bg-indigo-100 text-indigo-500 rounded-full flex items-center justify-center mx-auto mb-4">
                        <svg class="h-8 w-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    </div>
                    <label for="excel-upload-practical" class="cursor-pointer block">
                        <span class="block text-lg font-bold text-indigo-700">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel (‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥)</span>
                        <span class="block text-sm text-indigo-500 mt-1">.xlsx ‡∏´‡∏£‡∏∑‡∏≠ .xls</span>
                        <input id="excel-upload-practical" type="file" class="hidden" accept=".xlsx, .xls" onchange="handleExcelUpload(this, 'practical')">
                    </label>
                </div>
                <div class="mt-6 bg-indigo-50 p-6 rounded-2xl border border-indigo-100">
                    <h4 class="font-bold text-indigo-700 mb-2">‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÑ‡∏ü‡∏•‡πå Excel</h4>
                    <ul class="text-sm text-indigo-800 space-y-1 ml-7 list-disc">
                        <li>A: ‡∏£‡∏´‡∏±‡∏™‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏™‡∏≠‡∏ö (‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö)</li>
                        <li>B: ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏≠‡∏ö‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥ (‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç)</li>
                    </ul>
                </div>
                <div id="practical-preview-area" class="mt-6 hidden">
                    <div class="flex justify-between items-center mb-3">
                        <h4 class="font-bold text-gray-700 text-sm">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏û‡∏ö (<span id="practical-count">0</span> ‡∏Ñ‡∏ô)</h4>
                        <button type="button" onclick="confirmExcelImport('practical')" class="px-4 py-2 bg-indigo-600 text-white rounded-lg font-bold text-sm shadow-md hover:bg-indigo-700">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤</button>
                    </div>
                    <div class="overflow-auto max-h-48 border border-gray-200 rounded-xl text-xs bg-white">
                        <table class="w-full text-left" id="practical-preview-table"></table>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>
    <div id="alert-modal" class="hidden-force fixed inset-0 flex items-center justify-center z-[200]">
    <div class="absolute inset-0 bg-black/40 backdrop-blur-sm transition-opacity" onclick="closeAlert()"></div>
    <div class="bg-white rounded-2xl shadow-2xl p-6 w-11/12 max-w-sm text-center relative z-10 transform scale-100 transition-all border border-gray-100">
        <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4 text-red-500">
            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
        </div>
        <h3 id="alert-title" class="text-xl font-bold text-gray-800 mb-2">‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</h3>
        <p id="alert-message" class="text-gray-600 mb-6 text-sm">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</p>
        <button onclick="closeAlert()" class="w-full py-3 bg-gray-800 text-white rounded-xl font-bold hover:bg-gray-900 transition-all">‡∏ï‡∏Å‡∏•‡∏á</button>
    </div>
</div>

<div id="confirm-modal" class="hidden-force fixed inset-0 flex items-center justify-center z-[200]">
    <div class="absolute inset-0 bg-black/40 backdrop-blur-sm transition-opacity" onclick="closeConfirm()"></div>
    <div class="bg-white rounded-2xl shadow-2xl p-6 w-11/12 max-w-sm text-center relative z-10 transform scale-100 transition-all border border-gray-100">
        <div class="w-16 h-16 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-4 text-yellow-600">
            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
        </div>
        <h3 id="confirm-title" class="text-xl font-bold text-gray-800 mb-2">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</h3>
        <p id="confirm-message" class="text-gray-600 mb-6 text-sm">‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?</p>
        <div class="flex gap-3">
            <button onclick="closeConfirm()" class="flex-1 py-3 bg-gray-100 text-gray-600 rounded-xl font-bold hover:bg-gray-200 transition-all">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            <button onclick="confirmAction()" class="flex-1 py-3 bg-yellow-400 text-yellow-900 rounded-xl font-bold hover:bg-yellow-500 shadow-lg shadow-yellow-200 transition-all">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
        </div>
    </div>
</div>

<div id="loading-modal" class="hidden-force fixed inset-0 flex items-center justify-center z-[300]">
    <div class="absolute inset-0 bg-white/80 backdrop-blur-md transition-opacity"></div>
    <div class="bg-white rounded-2xl shadow-2xl p-8 flex flex-col items-center relative z-10 border border-gray-100">
        <div class="animate-spin rounded-full h-12 w-12 border-4 border-gray-200 border-t-lime-500 mb-4"></div>
        <p id="loading-message" class="text-gray-600 font-bold animate-pulse">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...</p>
    </div>
</div>
<script>
// Config ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ï‡∏±‡∏ß‡πÑ‡∏°‡πà‡∏´‡∏ô‡∏≤
const defaultConfig = { 
system_title: "‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ú‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô<br>‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏ä‡∏£‡∏£‡∏≤‡∏ä‡∏û‡∏§‡∏Å‡∏©‡πå<br><span class='text-sm font-normal'>‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ö‡∏≤‡∏á‡∏™‡∏∞‡∏û‡∏≤‡∏ô‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤ ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏õ‡∏£‡∏∞‡∏à‡∏ß‡∏ö‡∏Ñ‡∏µ‡∏£‡∏µ‡∏Ç‡∏±‡∏ô‡∏ò‡πå</span>", 
admission_year: "2569", 
primary_color: "#C6E686", 
secondary_color: "#fbbf24", 
background_color: "#f0fdf4", 
text_color: "#374151", 
surface_color: "#ffffff" 
};

let currentUser = null, currentView = 'login', adminTab = 'm1', studentsData = [], searchQuery = '', formMode = 'create', excelDataCache = [], scoreDataCache = [], confirmCallback = null, isSidebarOpen = false, checkedIds = new Set();
// --- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡πà‡∏≠‡∏à‡∏≤‡∏Å‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏î‡∏¥‡∏° ---
// adminViewMode: 'manage' (‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•), 'ranking' (‡∏î‡∏π‡∏ú‡∏•‡∏à‡∏±‡∏î‡∏•‡∏≥‡∏î‡∏±‡∏ö)
// rankingTab: 'all' (‡∏£‡∏ß‡∏°), 'sm', 'gate', 'eis' (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ‡∏°.1) ‡∏´‡∏£‡∏∑‡∏≠ 'sme', 'gate' (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ‡∏°.4)
let adminViewMode = 'manage', rankingTab = 'all';
// ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡∏ô‡∏µ‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ
let practicalDataCache = [];

// ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÇ‡∏Ñ‡∏ß‡∏ï‡∏≤‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£ (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà)
const quotas = {
    m1: { 'S&M': 80, 'GATE': 60, 'EIS': 60 },
    m4: { 'SME': 80, 'GATE': 60 } 
};

    // --- Global Variable: ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏¢‡πâ‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ (Manual Overrides) ---
// ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö: { 'backendId': 'ProgramName' } ‡πÄ‡∏ä‡πà‡∏ô { 'user123': 'S&M', 'user456': 'REMOVED' }
let interviewOverrides = JSON.parse(localStorage.getItem('admission_interview_overrides')) || {};
let interviewCheckedIds = new Set(); 
let addModalSelectedIds = new Set(); 

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Storage
function saveOverridesToStorage() {
    localStorage.setItem('admission_interview_overrides', JSON.stringify(interviewOverrides));
}

// ... (‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô addStudentToProject, confirmAddStudents, removeStudentFromProject ‡πÄ‡∏î‡∏¥‡∏° ‡∏Ñ‡∏á‡πÑ‡∏ß‡πâ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ...

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏•‡∏≤‡∏¢‡∏Ñ‡∏ô (Bulk Delete)
function deleteSelectedInterviews() {
    if (interviewCheckedIds.size === 0) return;
    if (confirm(`‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≠‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${interviewCheckedIds.size} ‡∏Ñ‡∏ô ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) {
        interviewCheckedIds.forEach(id => {
            interviewOverrides[id] = 'REMOVED';
        });
        saveOverridesToStorage();
        
        interviewCheckedIds.clear();
        renderAdminDashboard();
        showAlert('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
    }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Toggle ‡∏£‡∏≤‡∏¢‡∏Ñ‡∏ô
function toggleInterviewCheck(id) {
    if (interviewCheckedIds.has(id)) {
        interviewCheckedIds.delete(id);
    } else {
        interviewCheckedIds.add(id);
    }
    updateBulkDeleteButton();
    updateSelectAllCheckboxState(); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á
}

// üî• ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î üî•
function toggleSelectAllInterviews(source) {
    const checkboxes = document.querySelectorAll('.interview-checkbox');
    interviewCheckedIds.clear();

    if (source.checked) {
        checkboxes.forEach(cb => {
            // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà‡∏°‡∏≠‡∏á‡πÄ‡∏´‡πá‡∏ô‡∏≠‡∏¢‡∏π‡πà (‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏ì‡∏µ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏≠‡∏¢‡∏π‡πà)
            if (cb.closest('tr').style.display !== 'none') {
                cb.checked = true;
                interviewCheckedIds.add(cb.getAttribute('data-id'));
            }
        });
    } else {
        checkboxes.forEach(cb => {
            cb.checked = false;
        });
    }
    updateBulkDeleteButton();
}

// ‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Checkbox ‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á (‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏£‡∏ö‡πÉ‡∏´‡πâ‡∏ï‡∏¥‡πä‡∏Å‡∏ñ‡∏π‡∏Å)
function updateSelectAllCheckboxState() {
    const all = document.querySelectorAll('.interview-checkbox');
    const allCount = Array.from(all).filter(cb => cb.closest('tr').style.display !== 'none').length;
    const headerCheckbox = document.getElementById('select-all-interviews');
    
    if (headerCheckbox) {
        headerCheckbox.checked = (allCount > 0 && interviewCheckedIds.size === allCount);
    }
}

function updateBulkDeleteButton() {
    const btn = document.getElementById('btn-bulk-delete');
    if(btn) {
        if(interviewCheckedIds.size > 0) {
            btn.classList.remove('hidden');
            btn.innerHTML = `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg> ‡∏•‡∏ö ${interviewCheckedIds.size} ‡∏Ñ‡∏ô`;
        } else {
            btn.classList.add('hidden');
        }
    }
}

// --- ‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á Modal ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏ö‡∏ö‡∏´‡∏•‡∏≤‡∏¢‡∏Ñ‡∏ô ---

function showAddStudentModal(targetProgram) {
    addModalSelectedIds.clear(); // ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏´‡∏°‡πà
    
    // ‡∏•‡∏ö Modal ‡πÄ‡∏Å‡πà‡∏≤‡∏ñ‡πâ‡∏≤‡∏Ñ‡πâ‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà
    const existing = document.getElementById('add-student-modal');
    if(existing) existing.remove();

    const modalHtml = `
    <div id="add-student-modal" class="fixed inset-0 flex items-center justify-center z-[200] animate-fade-in px-4 font-sarabun">
        <div class="absolute w-full h-full bg-gray-900/60 backdrop-blur-sm transition-opacity" onclick="closeAddStudentModal()"></div>
        
        <div class="bg-white w-full max-w-2xl rounded-2xl shadow-2xl z-[201] overflow-hidden flex flex-col max-h-[85vh] relative transform scale-100 transition-transform">
            <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
                <h3 class="font-bold text-gray-700 flex items-center gap-2">
                    <svg class="w-5 h-5 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                    ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ ${targetProgram}
                </h3>
                <button onclick="closeAddStudentModal()" class="w-8 h-8 flex items-center justify-center rounded-full bg-white border border-gray-200 text-gray-400 hover:text-red-500 hover:bg-red-50 transition-all shadow-sm">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>

            <div class="p-4 border-b border-gray-100 bg-white shadow-sm z-10">
                <div class="relative">
                    <input type="text" id="search-student-add" onkeyup="searchStudentToAdd('${targetProgram}')" 
                        placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠ ‡∏´‡∏£‡∏∑‡∏≠ ‡∏£‡∏´‡∏±‡∏™‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏™‡∏≠‡∏ö..." 
                        class="w-full pl-10 pr-4 py-3 rounded-xl border border-gray-200 focus:ring-2 focus:ring-lime-500 outline-none transition-all text-gray-700">
                    <svg class="w-5 h-5 text-gray-400 absolute left-3 top-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto p-2 bg-gray-50 min-h-[300px]" id="search-results-list">
                <div class="flex flex-col items-center justify-center h-full text-gray-400 gap-2 opacity-60">
                    <svg class="w-12 h-12" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                    <span>‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≠‡∏ö</span>
                </div>
            </div>

            <div class="p-4 border-t border-gray-100 bg-white flex justify-between items-center shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] z-20">
                <span class="text-sm text-gray-500 font-bold" id="selected-count-text">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß 0 ‡∏Ñ‡∏ô</span>
                
                <button onclick="confirmAddStudents('${targetProgram}')" id="btn-confirm-add" disabled 
                    class="bg-lime-500 hover:bg-lime-600 disabled:bg-gray-300 disabled:cursor-not-allowed text-white px-6 py-2.5 rounded-xl font-bold shadow-md transition-all flex items-center gap-2 transform active:scale-95">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                    ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠
                </button>
            </div>
        </div>
    </div>`;
    
    const div = document.createElement('div');
    div.innerHTML = modalHtml;
    document.body.appendChild(div.firstElementChild);
    
    setTimeout(()=> {
        const input = document.getElementById('search-student-add');
        if(input) input.focus();
    }, 100);
}

// 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡∏û‡∏£‡πâ‡∏≠‡∏° Checkbox)
function searchStudentToAdd(program) {
    const query = document.getElementById('search-student-add').value.toLowerCase().trim();
    if(query.length < 2) return; // ‡∏ï‡πâ‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 2 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£

    const validGrades = adminTab === 'm1' ? ['p4','p5','p6','m1'] : ['m3','m4'];
    const candidates = studentsData.filter(s => 
        validGrades.includes(s.grade_level) && 
        (s.full_name.toLowerCase().includes(query) || s.exam_id.toLowerCase().includes(query))
    );

    const listHtml = candidates.map(s => {
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ñ‡∏π‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ß‡πâ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
        const isChecked = addModalSelectedIds.has(s.__backendId) ? 'checked' : '';
        
        return `
        <label class="bg-white p-3 rounded-xl border border-gray-100 mb-2 flex justify-between items-center shadow-sm hover:shadow-md transition-all cursor-pointer select-none group">
            <div class="flex items-center gap-3">
                <div class="relative flex items-center">
                    <input type="checkbox" class="w-6 h-6 rounded-md border-2 border-gray-300 text-lime-500 focus:ring-lime-500 transition-all checked:bg-lime-500 checked:border-lime-500" 
                        data-id="${s.__backendId}" ${isChecked} 
                        onchange="toggleModalAddCheck('${s.__backendId}')">
                </div>
                <div>
                    <div class="font-bold text-gray-800 group-hover:text-lime-700 transition-colors">${s.full_name}</div>
                    <div class="text-xs text-gray-500 flex gap-2 mt-1">
                        <span class="bg-gray-100 px-1.5 rounded text-gray-600 font-mono">${s.exam_id}</span>
                        <span class="text-gray-300">|</span>
                        <span>${s.previous_school}</span>
                    </div>
                </div>
            </div>
            <div class="text-right">
                <div class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-0.5">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏î‡∏¥‡∏ö</div>
                <div class="text-sm font-black text-lime-600 bg-lime-50 px-2 py-0.5 rounded-lg border border-lime-100">${s.total_score}</div>
            </div>
        </label>
        `;
    }).join('');

    document.getElementById('search-results-list').innerHTML = listHtml || '<div class="text-center text-gray-400 py-8 flex flex-col items-center"><svg class="w-8 h-8 mb-2 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô</div>';
}

// 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡πä‡∏Å‡∏ñ‡∏π‡∏Å (Toggle)
function toggleModalAddCheck(id) {
    if(addModalSelectedIds.has(id)) {
        addModalSelectedIds.delete(id);
    } else {
        addModalSelectedIds.add(id);
    }
    updateModalUI(); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
}

// 4. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏∏‡πà‡∏° (‡∏´‡∏±‡∏ß‡πÉ‡∏à‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤)
function updateModalUI() {
    const count = addModalSelectedIds.size;
    const label = document.getElementById('selected-count-text');
    const btn = document.getElementById('btn-confirm-add');

    if(label) label.innerText = `‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß ${count} ‡∏Ñ‡∏ô`;

    if(btn) {
        if(count > 0) {
            btn.disabled = false;
            btn.classList.remove('disabled:bg-gray-300', 'disabled:cursor-not-allowed');
            // ‡πÄ‡∏û‡∏¥‡πà‡∏° Animation ‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤‡∏Å‡∏î‡πÑ‡∏î‡πâ
            btn.classList.add('ring-2', 'ring-lime-200');
        } else {
            btn.disabled = true;
            btn.classList.add('disabled:bg-gray-300', 'disabled:cursor-not-allowed');
            btn.classList.remove('ring-2', 'ring-lime-200');
        }
    }
}

// 5. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏° (‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏•‡πâ‡∏ß‡∏°‡∏≤‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà)
function confirmAddStudents(program) {
    if(addModalSelectedIds.size === 0) return;
    
    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏´‡∏•‡∏±‡∏Å
    addModalSelectedIds.forEach(id => {
        interviewOverrides[id] = program;
    });
    
    saveOverridesToStorage(); // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á LocalStorage
    
    closeAddStudentModal();
    renderAdminDashboard(); // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏´‡∏•‡∏±‡∏Å
    showAlert('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', `‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ ${program} ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${addModalSelectedIds.size} ‡∏Ñ‡∏ô ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`);
    
    addModalSelectedIds.clear(); // ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤
}

// 6. ‡∏õ‡∏¥‡∏î Modal
function closeAddStudentModal() {
    const el = document.getElementById('add-student-modal');
    if(el) el.remove();
}
// --- 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞ (Weighted Score) ---
function getWeightedScore(student, program) {
    const sci = parseFloat(student.science_score) || 0;
    const math = parseFloat(student.math_score) || 0;
    const eng = parseFloat(student.english_score) || 0;
    const p = program.toLowerCase();

    // S&M / SME: ‡∏ß‡∏¥‡∏ó‡∏¢‡πå(x1.0) + ‡∏Ñ‡∏ì‡∏¥‡∏ï(x1.33) + ‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©(x0.5)
    if (p.includes('s&m') || p.includes('sme')) {
        return (sci * 1.0) + (math * (40/30)) + (eng * 0.5);
    }
    // GATE: ‡∏ß‡∏¥‡∏ó‡∏¢‡πå(x0.875) + ‡∏Ñ‡∏ì‡∏¥‡∏ï(x1.16) + ‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©(x0.75)
    else if (p.includes('gate')) {
        return (sci * 0.875) + (math * (35/30)) + (eng * 0.75);
    }
    // EIS: ‡∏ß‡∏¥‡∏ó‡∏¢‡πå(x0.75) + ‡∏Ñ‡∏ì‡∏¥‡∏ï(x1.0) + ‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©(x1.0)
    else if (p.includes('eis')) {
        return (sci * 0.75) + (math * 1.0) + (eng * 1.0);
    }
    return 0;
}

// --- 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏• Clearing House (‡∏´‡∏±‡∏ß‡πÉ‡∏à‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç) ---
function executeClearingHouse(students, quotaConfig) {
    let results = {}; 
    let seats = { ...quotaConfig }; // ‡πÇ‡∏Ñ‡∏ß‡∏ï‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏ï‡πâ‡∏ô
    let remainingStudents = [...students]; // ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ô

    // ‡∏ß‡∏ô‡∏•‡∏π‡∏õ 3 ‡∏£‡∏≠‡∏ö (‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö 1 -> 2 -> 3)
    for (let choiceRound = 1; choiceRound <= 3; choiceRound++) {
        
        const programs = Object.keys(seats); 

        // ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡∏ó‡∏µ‡∏•‡∏∞‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ (S&M, GATE, EIS...)
        programs.forEach(program => {
            
            // ‡∏ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á‡πÄ‡∏ï‡πá‡∏°‡πÅ‡∏•‡πâ‡∏ß (<=0) ‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏õ‡πÄ‡∏•‡∏¢ (‡πÑ‡∏°‡πà‡∏£‡∏±‡∏ö‡πÄ‡∏û‡∏¥‡πà‡∏°)
            if (seats[program] <= 0) return; 

            // A. ‡∏Ñ‡∏±‡∏î‡∏Å‡∏£‡∏≠‡∏á‡∏Ñ‡∏ô‡∏™‡∏°‡∏±‡∏Ñ‡∏£:
            // "‡πÉ‡∏Ñ‡∏£‡∏ö‡πâ‡∏≤‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ ‡πÉ‡∏ô‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤ (1, 2 ‡∏´‡∏£‡∏∑‡∏≠ 3) ‡πÅ‡∏•‡∏∞‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ô"
            let candidates = remainingStudents.filter(s => {
                const choice = choiceRound === 1 ? s.choice_1 : (choiceRound === 2 ? s.choice_2 : s.choice_3);
                return choice === program; // ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
            });

            // =========================================================
            // B. [‡∏à‡∏∏‡∏î‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç] ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÉ‡∏´‡∏°‡πà ‡∏ï‡∏≤‡∏°‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏Ç‡∏≠‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡πâ‡∏ô‡πÜ !!!
            // =========================================================
            // ‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏°‡∏≤‡∏à‡∏≤‡∏Å‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡πÑ‡∏´‡∏ô ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÉ‡∏´‡∏°‡πà‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ‡∏™‡∏π‡∏ï‡∏£‡∏Ç‡∏≠‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡πâ‡∏ô‡πÄ‡∏™‡∏°‡∏≠
            // ‡πÄ‡∏ä‡πà‡∏ô ‡∏ñ‡πâ‡∏≤‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤ GATE ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏™‡∏π‡∏ï‡∏£ GATE (‡∏ß‡∏¥‡∏ó‡∏¢‡πåx0.875...) ‡∏°‡∏≤‡∏Ñ‡∏¥‡∏î‡πÉ‡∏´‡πâ
            candidates = candidates.map(s => ({
                ...s,
                temp_score: getWeightedScore(s, program) // <--- ‡∏™‡πà‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏π‡∏ï‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì
            }));

            // C. ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏°‡∏≤‡∏Å -> ‡∏ô‡πâ‡∏≠‡∏¢ (‡∏ï‡∏≤‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏•‡πâ‡∏ß)
            candidates.sort((a, b) => b.temp_score - a.temp_score);

            // D. ‡∏ï‡∏±‡∏î‡πÇ‡∏Ñ‡∏ß‡∏ï‡∏≤ (Logic: ‡∏£‡∏±‡∏ö‡∏Ñ‡∏£‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô + ‡∏£‡∏±‡∏ö‡∏Ñ‡∏ô‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô)
            let winners = [];
            
            if (candidates.length === 0) {
                winners = [];
            } else if (candidates.length <= seats[program]) {
                // ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏ô‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏ß‡πà‡∏≤‡∏á -> ‡∏£‡∏±‡∏ö‡∏´‡∏°‡∏î
                winners = candidates;
            } else {
                // ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏ô‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÄ‡∏¢‡∏≠‡∏∞‡∏Å‡∏ß‡πà‡∏≤ -> ‡∏ï‡∏±‡∏î‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÇ‡∏Ñ‡∏ß‡∏ï‡∏≤
                const cutOffIndex = seats[program] - 1; 
                const cutOffScore = candidates[cutOffIndex].temp_score;

                // ‡∏£‡∏±‡∏ö‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô >= ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏à‡∏∏‡∏î‡∏ï‡∏±‡∏î
                winners = candidates.filter(c => c.temp_score >= cutOffScore);
            }

            // E. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏ô‡∏ï‡∏¥‡∏î
            winners.forEach(w => {
                results[w.__backendId] = {
                    program: program,
                    score: w.temp_score // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏ï‡∏¥‡∏î (‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô Weight ‡∏Ç‡∏≠‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡πâ‡∏ô)
                };
            });

            // ‡∏•‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á
            seats[program] -= winners.length;

            // ‡∏ï‡∏±‡∏î‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡∏ï‡∏¥‡∏î‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏Å‡∏≠‡∏á‡∏Å‡∏•‡∏≤‡∏á (‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡πÄ‡∏≠‡∏≤‡πÑ‡∏õ‡∏Ñ‡∏¥‡∏î‡πÉ‡∏ô‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‡∏´‡∏£‡∏∑‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏∑‡πà‡∏ô‡πÉ‡∏ô‡∏£‡∏≠‡∏ö‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô)
            const winnerIds = new Set(winners.map(w => w.__backendId));
            remainingStudents = remainingStudents.filter(s => !winnerIds.has(s.__backendId));
        });
    }

    return results;
}
function getThaiGrade(code) { const map = { 'p4': '‡∏õ‡∏£‡∏∞‡∏ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà 4', 'p5': '‡∏õ‡∏£‡∏∞‡∏ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà 5', 'p6': '‡∏õ‡∏£‡∏∞‡∏ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà 6', 'm3': '‡∏°‡∏±‡∏ò‡∏¢‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà 3' }; return map[code.toLowerCase()] || code; }
function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('sidebar-overlay');
    
    // ‡∏™‡∏•‡∏±‡∏ö‡∏Ñ‡∏•‡∏≤‡∏™‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏°‡∏ô‡∏π‡πÄ‡∏Ç‡πâ‡∏≤/‡∏≠‡∏≠‡∏Å
    if (sidebar) {
        sidebar.classList.toggle('-translate-x-full');
    }
    
    // ‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏™‡∏µ‡∏î‡∏≥‡∏à‡∏≤‡∏á‡πÜ
    if (overlay) {
        overlay.classList.toggle('hidden');
    }
}

function showAlert(t, m) { document.getElementById('alert-title').textContent = t; document.getElementById('alert-message').textContent = m; document.getElementById('alert-modal').classList.remove('hidden-force'); }
function closeAlert() { document.getElementById('alert-modal').classList.add('hidden-force'); }
function showConfirm(t, m, cb) { document.getElementById('confirm-title').textContent = t; document.getElementById('confirm-message').textContent = m; confirmCallback = cb; document.getElementById('confirm-modal').classList.remove('hidden-force'); }
function closeConfirm() { document.getElementById('confirm-modal').classList.add('hidden-force'); confirmCallback = null; }
function confirmAction() { if(confirmCallback) confirmCallback(); closeConfirm(); }
function showLoading(msg) { document.getElementById('loading-message').textContent = msg; document.getElementById('loading-modal').classList.remove('hidden-force'); }
function hideLoading() { document.getElementById('loading-modal').classList.add('hidden-force'); }
function openModal() { document.getElementById('student-modal').classList.remove('hidden-force'); document.body.classList.add('modal-active'); }
function closeModal() { document.getElementById('student-modal').classList.add('hidden-force'); document.body.classList.remove('modal-active'); }

const dataHandler = { onDataChanged(data) { studentsData = data.sort((a, b) => b.total_score - a.total_score); let m1 = studentsData.filter(s => ['p4','p5','p6','m1'].includes(s.grade_level)); let m4 = studentsData.filter(s => ['m3','m4'].includes(s.grade_level)); m1.forEach((s, i) => s.rank = i+1); m4.forEach((s, i) => s.rank = i+1); if (currentView === 'admin') renderAdminDashboard(); else if (currentView === 'student' && currentUser) { const u = studentsData.find(s => String(s.national_id) === String(currentUser.national_id)); if(u) currentUser = u; renderStudentView(); } } };
function render() { const app = document.getElementById('app'); if(currentView === 'login') renderLogin(); else if(currentView === 'admin') renderAdminDashboard(); else renderStudentView(); }

function toggleAllCheckboxes(source) { const checkboxes = document.querySelectorAll('.row-checkbox'); checkboxes.forEach(cb => { cb.checked = source.checked; if(source.checked) checkedIds.add(cb.value); else checkedIds.delete(cb.value); }); updateDeleteButton(); }
function toggleCheckbox(id) { const cb = document.querySelector(`.row-checkbox[value="${id}"]`); if(cb.checked) checkedIds.add(id); else checkedIds.delete(id); updateDeleteButton(); }
function updateDeleteButton() { const btn = document.getElementById('btn-bulk-delete'); if(checkedIds.size > 0) { btn.classList.remove('hidden'); document.getElementById('selected-count').textContent = checkedIds.size; } else { btn.classList.add('hidden'); } }
function executeBulkDelete() { if(checkedIds.size === 0) return; showConfirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏´‡∏°‡∏π‡πà', `‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ${checkedIds.size} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`, () => { showLoading(`‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö ${checkedIds.size} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£...`); window.dataSdk.deleteBulk(Array.from(checkedIds)).then(res => { setTimeout(() => { hideLoading(); checkedIds.clear(); if(res.isOk) { showAlert('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß'); } else { showAlert('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', res.error.message); } }, 500); }); }); }

// ---------------------------------------------
// RENDER LOGIN: ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á #B2B2B2 ‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î
// ---------------------------------------------
function renderLogin() {
const config = window.elementSdk?.config || defaultConfig;
document.getElementById('app').innerHTML = `
<div class="h-full w-full bg-[#B2B2B2] flex flex-col items-center justify-center p-4 overflow-auto">

<div class="w-full max-w-md bg-white rounded-[2rem] shadow-xl p-8 relative overflow-hidden shrink-0">

<div class="absolute -top-10 -right-10 w-32 h-32 bg-yellow-100 rounded-full opacity-50 blur-xl"></div>
<div class="absolute -bottom-10 -left-10 w-32 h-32 bg-green-100 rounded-full opacity-50 blur-xl"></div>

<div class="text-center mb-8 relative z-10">
<div class="mx-auto mb-6"><img src="https://img2.pic.in.th/pic/-69-1.png" alt="‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô" class="h-32 w-auto mx-auto object-contain drop-shadow-md"></div>

<div class="text-gray-900 font-bold text-lg md:text-xl whitespace-nowrap leading-tight">
‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ú‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
</div>

<div class="text-gray-900 font-bold whitespace-nowrap mt-1 leading-tight -mx-6 px-1
text-[13px] min-[360px]:text-[14.5px] min-[390px]:text-[16px] sm:text-xl sm:mx-0">
‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏ä‡∏£‡∏£‡∏≤‡∏ä‡∏û‡∏§‡∏Å‡∏©‡πå
</div>

<p class="text-gray-600 text-xs sm:text-sm font-normal mt-2">
‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ö‡∏≤‡∏á‡∏™‡∏∞‡∏û‡∏≤‡∏ô‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤ ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏õ‡∏£‡∏∞‡∏à‡∏ß‡∏ö‡∏Ñ‡∏µ‡∏£‡∏µ‡∏Ç‡∏±‡∏ô‡∏ò‡πå
</p>

<p class="text-gray-400 mt-4 text-sm">‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤ <span class="text-lime-600 font-bold">${config.admission_year}</span></p>
</div>

<div class="space-y-3 mb-6 relative z-10" id="login-buttons">
<button type="button" onclick="toggleLogin('student')" class="w-full py-4 px-6 rounded-2xl border-2 border-lime-300 text-lime-700 font-bold hover:bg-lime-50 active:scale-95 transition-all flex items-center justify-center gap-3 shadow-sm"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≠‡∏ö</button>
<button type="button" onclick="toggleLogin('admin')" class="w-full py-4 px-6 rounded-2xl border-2 border-amber-200 text-amber-500 font-bold hover:bg-amber-50 active:scale-95 transition-all flex items-center justify-center gap-3 shadow-sm"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</button>
</div>

<div id="login-form-container" class="hidden relative z-10 bg-gray-50/80 p-5 rounded-2xl border border-gray-100">
<form onsubmit="handleLogin(event)" class="space-y-4">
<div id="input-student" class="hidden"><label class="block text-xs font-bold text-gray-500 mb-2 uppercase">‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô 13 ‡∏´‡∏•‡∏±‡∏Å</label><input type="text" id="login-id" class="w-full px-4 py-3 rounded-xl border-gray-200 focus:border-lime-400 focus:ring-2 focus:ring-lime-100 outline-none transition-all input-field" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô"></div>
<div id="input-admin" class="hidden space-y-3">
<div><label class="block text-xs font-bold text-gray-500 mb-2 uppercase">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</label><input type="text" id="admin-user" class="w-full px-4 py-3 rounded-xl border-gray-200 focus:border-amber-300 focus:ring-2 focus:ring-amber-100 outline-none transition-all input-field" placeholder="Admin Username"></div>
<div><label class="block text-xs font-bold text-gray-500 mb-2 uppercase">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label><input type="password" id="admin-pass" class="w-full px-4 py-3 rounded-xl border-gray-200 focus:border-amber-300 focus:ring-2 focus:ring-amber-100 outline-none transition-all input-field" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></div>
</div>
<div class="flex gap-2 pt-2"><button type="button" onclick="resetLogin()" class="px-4 py-3 bg-gray-200 text-gray-600 rounded-xl font-bold text-sm">‡∏Å‡∏•‡∏±‡∏ö</button><button type="submit" class="flex-1 py-3 btn-primary rounded-xl font-bold shadow-lg shadow-amber-100 transition-all text-sm">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button></div>
</form>
</div>
</div>

<div class="mt-6 text-center animate-pulse">
<p class="text-xs text-white font-medium drop-shadow-md bg-black/10 px-3 py-1 rounded-full">‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡πÇ‡∏î‡∏¢ ‡∏Ñ‡∏£‡∏π‡∏≠‡∏≤‡∏ô‡∏ô‡∏ó‡πå ‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡πÅ‡∏Å‡πâ‡∏ß</p>
</div>

</div>
`;
}

function toggleLogin(mode) { document.getElementById('login-buttons').classList.add('hidden'); document.getElementById('login-form-container').classList.remove('hidden'); if(mode==='student'){document.getElementById('input-student').classList.remove('hidden');document.getElementById('input-admin').classList.add('hidden');}else{document.getElementById('input-student').classList.add('hidden');document.getElementById('input-admin').classList.remove('hidden');} }
function resetLogin() { document.getElementById('login-form-container').classList.add('hidden'); document.getElementById('login-buttons').classList.remove('hidden'); }
function handleLogin(e) { e.preventDefault(); const isStudent = !document.getElementById('input-student').classList.contains('hidden'); if(isStudent){ const id = document.getElementById('login-id').value.trim(); const user = studentsData.find(s => String(s.national_id).trim() === String(id)); if(user){currentUser = user; currentView = 'student'; render();}else showAlert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', '‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö'); }else{ if(document.getElementById('admin-user').value === 'admin' && document.getElementById('admin-pass').value === 'admin11275'){currentView='admin';render();}else showAlert('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ú‡∏¥‡∏î'); } }

function renderAdminDashboard() {
    // 1. ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô
    const m1 = studentsData.filter(s => ['p4','p5','p6','m1'].includes(s.grade_level));
    const m4 = studentsData.filter(s => ['m3','m4'].includes(s.grade_level));
    let activeData = adminTab === 'm1' ? m1 : m4;

    // --- ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥ ---
    const totalStudents = activeData.length;
    const allScores = activeData.map(s => (parseFloat(s.total_score)||0) + (parseFloat(s.practical_score)||0));
    const validScores = allScores.filter(score => score > 0);
    const maxScore = validScores.length > 0 ? Math.max(...validScores) : 0;
    const minScore = validScores.length > 0 ? Math.min(...validScores) : 0;

    // Logic ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤ Manage
    let displayData = activeData;
    if(adminViewMode === 'manage' && searchQuery) {
        displayData = displayData.filter(s => s.full_name.includes(searchQuery) || String(s.exam_id).includes(searchQuery) || String(s.national_id).includes(searchQuery));
    }
    checkedIds.clear();

    // 2. Render HTML
    document.getElementById('app').innerHTML = `
    <div class="h-screen flex bg-[#f8fafc] font-sarabun overflow-hidden relative">
        
        <aside id="sidebar" class="fixed inset-y-0 left-0 z-40 w-72 flex flex-col bg-white border-r border-gray-100 shadow-2xl transform -translate-x-full transition-transform duration-300 md:translate-x-0 md:static md:shadow-xl">
            <div class="h-20 flex items-center gap-3 px-6 border-b border-gray-50 shrink-0">
                <img src="https://img5.pic.in.th/file/secure-sv1/-69-1112b7dae5160e09f.png" class="w-10 h-10 drop-shadow-sm">
                <div><h1 class="text-lg font-bold text-gray-800 leading-tight">‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£</h1><p class="text-xs text-lime-600 font-bold">Admin Panel</p></div>
                <button onclick="toggleSidebar()" class="md:hidden ml-auto text-gray-400 hover:text-red-500"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
            </div>
            <div class="p-6 pb-2 shrink-0">
                <div class="bg-gradient-to-br from-lime-50 to-green-50 rounded-2xl p-4 border border-lime-100 flex items-center gap-3 shadow-sm">
                    <div class="w-10 h-10 rounded-full bg-white flex items-center justify-center text-lime-600 font-bold shadow-sm border border-lime-50">AD</div>
                    <div><p class="text-sm font-bold text-gray-700">‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö</p><p class="text-xs text-gray-400">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</p></div>
                </div>
            </div>
            <div class="flex-1 overflow-y-auto px-4 py-4 space-y-1">
                <p class="px-4 text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>
                <button onclick="adminTab='m1';renderAdminDashboard();toggleSidebar();" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all duration-200 ${adminTab==='m1' ? 'bg-lime-50 text-lime-700 font-bold border-l-4 border-lime-500 shadow-sm' : 'text-gray-500 hover:bg-gray-50 hover:text-gray-700 font-medium'}"><div class="w-2 h-2 rounded-full ${adminTab==='m1'?'bg-lime-500':'bg-gray-300'}"></div>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏°.1</button>
                <button onclick="adminTab='m4';renderAdminDashboard();toggleSidebar();" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all duration-200 ${adminTab==='m4' ? 'bg-lime-50 text-lime-700 font-bold border-l-4 border-lime-500 shadow-sm' : 'text-gray-500 hover:bg-gray-50 hover:text-gray-700 font-medium'}"><div class="w-2 h-2 rounded-full ${adminTab==='m4'?'bg-lime-500':'bg-gray-300'}"></div>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏°.4</button>
                <div class="h-px bg-gray-100 my-4 mx-2"></div>
                <p class="px-4 text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-2">‡πÄ‡∏°‡∏ô‡∏π‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</p>
                
                <button onclick="adminViewMode='manage';renderAdminDashboard();toggleSidebar();" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all duration-200 ${adminViewMode==='manage' ? 'bg-blue-50 text-blue-700 font-bold border-l-4 border-blue-500 shadow-sm' : 'text-gray-500 hover:bg-gray-50 hover:text-gray-700 font-medium'}"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£</button>
                
                <button onclick="adminViewMode='ranking';rankingTab='all';renderAdminDashboard();toggleSidebar();" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all duration-200 ${adminViewMode==='ranking' ? 'bg-amber-50 text-amber-700 font-bold border-l-4 border-amber-500 shadow-sm' : 'text-gray-500 hover:bg-gray-50 hover:text-gray-700 font-medium'}"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ú‡∏•/‡∏à‡∏±‡∏î‡∏•‡∏≥‡∏î‡∏±‡∏ö</button>

                <button onclick="adminViewMode='interview';rankingTab='all';renderAdminDashboard();toggleSidebar();" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all duration-200 ${adminViewMode==='interview' ? 'bg-purple-50 text-purple-700 font-bold border-l-4 border-purple-500 shadow-sm' : 'text-gray-500 hover:bg-gray-50 hover:text-gray-700 font-medium'}"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥</button>
            </div>
            <div class="p-4 border-t border-gray-100 shrink-0">
                <button onclick="showAddStudentForm();toggleSidebar()" class="w-full flex items-center justify-center gap-2 px-4 py-3 bg-gradient-to-r from-lime-500 to-green-600 hover:from-lime-600 hover:to-green-700 text-white rounded-xl font-bold shadow-lg shadow-lime-200 active:scale-95 transition-all mb-2"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≠‡∏ö</button>
                <button onclick="currentView='login';render()" class="w-full flex items-center justify-center gap-2 px-4 py-2 text-red-500 hover:bg-red-50 rounded-lg font-bold text-sm transition-all">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
            </div>
        </aside>
        <div id="sidebar-overlay" class="fixed inset-0 bg-black/30 z-30 hidden md:hidden backdrop-blur-sm transition-opacity" onclick="toggleSidebar()"></div>

        <main class="flex-1 flex flex-col h-full overflow-hidden w-full relative">
            <header class="h-16 bg-white border-b border-gray-100 flex items-center justify-between px-4 shrink-0 md:hidden z-20">
                <div class="flex items-center gap-3">
                    <img src="https://img5.pic.in.th/file/secure-sv1/-69-1112b7dae5160e09f.png" class="w-8 h-8">
                    <span class="font-bold text-gray-700">Admin Panel</span>
                </div>
                <button onclick="toggleSidebar()" class="p-2 text-gray-600 bg-gray-50 rounded-lg hover:bg-gray-100 active:scale-95 transition-transform"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg></button>
            </header>
            <div class="flex-1 overflow-y-auto p-4 md:p-8 bg-[#f8fafc]">
                ${adminViewMode === 'manage' ? `
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3 md:gap-6 mb-8">
                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 flex flex-col relative overflow-hidden group">
                        <div class="absolute right-0 top-0 w-16 h-16 bg-lime-50 rounded-bl-full -mr-2 -mt-2 transition-transform group-hover:scale-110"></div>
                        <span class="text-xs text-gray-400 font-bold uppercase tracking-wider z-10">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£</span>
                        <span class="text-3xl font-black text-gray-800 mt-1 z-10">${totalStudents} <span class="text-sm font-normal text-gray-400">‡∏Ñ‡∏ô</span></span>
                        <div class="w-8 h-1 bg-lime-500 rounded-full mt-3 z-10"></div>
                    </div>
                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 flex flex-col relative overflow-hidden group">
                        <div class="absolute right-0 top-0 w-16 h-16 bg-blue-50 rounded-bl-full -mr-2 -mt-2 transition-transform group-hover:scale-110"></div>
                        <span class="text-xs text-gray-400 font-bold uppercase tracking-wider z-10">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î</span>
                        <span class="text-3xl font-black text-gray-800 mt-1 z-10">${maxScore.toFixed(2)}</span>
                        <div class="w-8 h-1 bg-blue-500 rounded-full mt-3 z-10"></div>
                    </div>
                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 flex flex-col relative overflow-hidden group">
                        <div class="absolute right-0 top-0 w-16 h-16 bg-purple-50 rounded-bl-full -mr-2 -mt-2 transition-transform group-hover:scale-110"></div>
                        <span class="text-xs text-gray-400 font-bold uppercase tracking-wider z-10">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î</span>
                        <span class="text-3xl font-black text-gray-800 mt-1 z-10">${minScore.toFixed(2)}</span>
                        <div class="w-8 h-1 bg-purple-500 rounded-full mt-3 z-10"></div>
                    </div>
                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 flex flex-col relative overflow-hidden group">
                        <div class="absolute right-0 top-0 w-16 h-16 bg-orange-50 rounded-bl-full -mr-2 -mt-2 transition-transform group-hover:scale-110"></div>
                        <span class="text-xs text-gray-400 font-bold uppercase tracking-wider z-10">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô</span>
                        <span class="text-3xl font-black text-gray-800 mt-1 z-10">${adminTab.toUpperCase()}</span>
                        <div class="w-8 h-1 bg-orange-500 rounded-full mt-3 z-10"></div>
                    </div>
                </div>
                ` : ''}

                <div class="animate-fade-in pb-10">
                    ${ 
                        adminViewMode === 'manage' 
                        ? renderManageView(displayData, activeData.length) 
                        : (
                            adminViewMode === 'ranking' 
                            ? renderRankingView(activeData) 
                            : renderInterviewView(activeData) 
                        )
                    }
                </div>
            </div>
        </main>
    </div>
    `;
}

// --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏¢‡πà‡∏≠‡∏¢ 1: ‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏î‡∏¥‡∏°) ---
function renderManageView(data, totalCount) {
    return `
    <div class="flex flex-col md:flex-row justify-between md:items-end mb-6 gap-2">
        <div><h1 class="text-2xl md:text-3xl font-bold text-gray-800 mb-1">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ${adminTab==='m1'?'‡∏°.1':'‡∏°.4'}</h1><p class="text-gray-400 text-sm">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î <span class="font-bold text-lime-600">${totalCount}</span> ‡∏Ñ‡∏ô</p></div>
    </div>

    <div class="bg-white p-2 rounded-2xl shadow-sm mb-6 flex gap-2">
        <div class="relative flex-1"><input type="text" id="search-input" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠, ‡∏£‡∏´‡∏±‡∏™..." class="w-full pl-10 pr-4 py-3 rounded-xl border-none bg-gray-50 focus:bg-white focus:ring-2 focus:ring-lime-100 transition-all text-gray-600" value="${searchQuery}" onkeydown="if(event.key==='Enter') triggerSearch()"><svg class="w-5 h-5 text-gray-400 absolute left-3 top-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg></div>
        <button onclick="triggerSearch()" class="px-4 md:px-8 bg-lime-400 text-white rounded-xl font-bold shadow-lg shadow-lime-200">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
        <button id="btn-bulk-delete" onclick="executeBulkDelete()" class="hidden px-4 md:px-6 bg-red-400 hover:bg-red-500 text-white rounded-xl font-bold shadow-lg shadow-red-200 transition-all flex items-center gap-2"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg><span class="hidden md:inline">‡∏•‡∏ö (<span id="selected-count">0</span>)</span></button>
    </div>

    <div class="bg-white rounded-3xl shadow-sm overflow-hidden border border-gray-100">
        <div class="overflow-x-auto">
            <table class="w-full text-left min-w-[800px]">
                <thead class="bg-gray-50 text-gray-600 text-sm uppercase font-bold">
                    <tr>
                        <th class="px-4 py-4 w-10 text-center"><input type="checkbox" onchange="toggleAllCheckboxes(this)" class="custom-checkbox rounded text-lime-500 focus:ring-lime-400"></th>
                        <th class="px-4 py-4">‡∏£‡∏´‡∏±‡∏™</th>
                        <th class="px-4 py-4">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</th>
                        <th class="px-4 py-4 text-center">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°</th>
                        <th class="px-4 py-4">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö 1</th>
                        <th class="px-4 py-4 text-center">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-50 text-sm">
                    ${data.map(s => `
                    <tr class="hover:bg-gray-50 transition-colors">
                        <td class="px-4 py-4 text-center"><input type="checkbox" value="${s.__backendId}" onchange="toggleCheckbox('${s.__backendId}')" class="row-checkbox custom-checkbox rounded text-lime-500 focus:ring-lime-400"></td>
                        <td class="px-4 py-4 font-mono text-lime-600 font-bold">${s.exam_id}</td>
                        <td class="px-4 py-4 font-medium text-gray-700 cursor-pointer hover:text-lime-600" onclick="showEditForm('${s.__backendId}')">${s.full_name}</td>
                        <td class="px-4 py-4 text-center font-bold ${s.total_score>0?'text-amber-500':'text-gray-200'}">${s.total_score>0 ? s.total_score.toFixed(2) : '-'}</td>
                        <td class="px-4 py-4 text-gray-500">${s.choice_1 || '-'}</td>
                        <td class="px-4 py-4 text-center flex justify-center gap-2">
                            <button onclick="showEditForm('${s.__backendId}')" class="text-lime-500 bg-lime-50 p-2 rounded-lg hover:bg-lime-100"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg></button>
                            <button onclick="deleteStudent('${s.__backendId}')" class="text-red-400 bg-red-50 p-2 rounded-lg hover:bg-red-100"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>
                        </td>
                    </tr>`).join('')}
                </tbody>
            </table>
        </div>
    </div>`;
}

function getWeightedScore(student, program) {
    const sci = parseFloat(student.science_score) || 0;
    const math = parseFloat(student.math_score) || 0;
    const eng = parseFloat(student.english_score) || 0;

    // ‡πÅ‡∏õ‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏•‡πá‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏á‡πà‡∏≤‡∏¢‡πÜ
    const p = program.toLowerCase();

    // S&M / SME: ‡∏ß‡∏¥‡∏ó‡∏¢‡πå(x1.0) + ‡∏Ñ‡∏ì‡∏¥‡∏ï(x1.33) + ‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©(x0.5)
    if (p.includes('s&m') || p.includes('sme')) {
        return (sci * 1.0) + (math * (40/30)) + (eng * 0.5);
    }
    // GATE: ‡∏ß‡∏¥‡∏ó‡∏¢‡πå(x0.875) + ‡∏Ñ‡∏ì‡∏¥‡∏ï(x1.16) + ‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©(x0.75)
    else if (p.includes('gate')) {
        return (sci * 0.875) + (math * (35/30)) + (eng * 0.75);
    }
    // EIS: ‡∏ß‡∏¥‡∏ó‡∏¢‡πå(x0.75) + ‡∏Ñ‡∏ì‡∏¥‡∏ï(x1.0) + ‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©(x1.0)
    else if (p.includes('eis')) {
        return (sci * 0.75) + (math * 1.0) + (eng * 1.0);
    }
    return 0;
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡∏±‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (Clearing House Simulator)
function executeClearingHouse(students, quotaConfig) {
    let results = {}; 
    let seats = { ...quotaConfig }; 
    let remainingStudents = [...students]; 

    // ‡∏ß‡∏ô‡∏•‡∏π‡∏õ 3 ‡∏£‡∏≠‡∏ö (‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö 1 -> 2 -> 3)
    for (let choiceRound = 1; choiceRound <= 3; choiceRound++) {
        const programs = Object.keys(seats); 

        programs.forEach(program => {
            if (seats[program] <= 0) return; // ‡∏ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏ï‡πá‡∏°‡πÅ‡∏•‡πâ‡∏ß ‡∏Ç‡πâ‡∏≤‡∏°

            // A. ‡∏´‡∏≤‡∏Ñ‡∏ô‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ
            let candidates = remainingStudents.filter(s => {
                const choice = choiceRound === 1 ? s.choice_1 : (choiceRound === 2 ? s.choice_2 : s.choice_3);
                return choice === program;
            });

            // B. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞
            candidates = candidates.map(s => ({
                ...s,
                temp_score: getWeightedScore(s, program)
            }));

            // C. ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏°‡∏≤‡∏Å -> ‡∏ô‡πâ‡∏≠‡∏¢
            candidates.sort((a, b) => b.temp_score - a.temp_score);

            // D. ‡∏ï‡∏±‡∏î‡πÇ‡∏Ñ‡∏ß‡∏ï‡∏≤ (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡∏°‡πà: ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô)
            let winners = [];
            
            if (candidates.length <= seats[program]) {
                // ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏ô‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏ß‡πà‡∏≤‡∏á -> ‡∏£‡∏±‡∏ö‡∏´‡∏°‡∏î
                winners = candidates;
            } else {
                // ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏ô‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÄ‡∏¢‡∏≠‡∏∞‡∏Å‡∏ß‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏ß‡πà‡∏≤‡∏á -> ‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏±‡∏î‡∏ï‡∏±‡∏ß
                // ‡∏î‡∏π‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ç‡∏≠‡∏á "‡∏Ñ‡∏ô‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÇ‡∏Ñ‡∏ß‡∏ï‡∏≤"
                const cutOffIndex = seats[program] - 1; 
                const cutOffScore = candidates[cutOffIndex].temp_score;

                // ‡∏£‡∏±‡∏ö‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô ‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠ ‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏à‡∏∏‡∏î‡∏ï‡∏±‡∏î
                // (‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏¢‡∏≠‡∏î‡∏£‡∏±‡∏ö‡∏à‡∏£‡∏¥‡∏á‡∏≠‡∏≤‡∏à‡πÄ‡∏Å‡∏¥‡∏ô‡πÇ‡∏Ñ‡∏ß‡∏ï‡∏≤‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ ‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∏‡∏î‡∏ï‡∏±‡∏î)
                winners = candidates.filter(c => c.temp_score >= cutOffScore);
            }

            // E. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•
            winners.forEach(w => {
                results[w.__backendId] = {
                    program: program,
                    score: w.temp_score
                };
            });

            // ‡∏•‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á (‡∏≠‡∏≤‡∏à‡∏ï‡∏¥‡∏î‡∏•‡∏ö‡πÑ‡∏î‡πâ ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô‡πÄ‡∏¢‡∏≠‡∏∞ ‡∏ã‡∏∂‡πà‡∏á‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß)
            seats[program] -= winners.length;

            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠
            const winnerIds = new Set(winners.map(w => w.__backendId));
            remainingStudents = remainingStudents.filter(s => !winnerIds.has(s.__backendId));
        });
    }

    return results;
}
   
// --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏¢‡πà‡∏≠‡∏¢ 2: ‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏±‡∏î‡∏•‡∏≥‡∏î‡∏±‡∏ö (Ranking View) ---
// --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏¢‡πà‡∏≠‡∏¢ 2: ‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏±‡∏î‡∏•‡∏≥‡∏î‡∏±‡∏ö (Ranking View) ---
function renderRankingView(allStudents) {
    let processingData = allStudents;
    let isFilteredMode = false;
    let isPretestMode = false;

    // 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÇ‡∏´‡∏°‡∏î
    if (rankingTab === 'filtered') {
        if (adminTab === 'm1') processingData = allStudents.filter(s => !['p4', 'p5'].includes(s.grade_level));
        isFilteredMode = true;
    } else if (rankingTab.startsWith('pretest')) {
        // Logic Pre-test (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
        if (rankingTab === 'pretest') processingData = allStudents.filter(s => ['p4', 'p5'].includes(s.grade_level));
        else if (rankingTab === 'pretest_p4') processingData = allStudents.filter(s => s.grade_level === 'p4');
        else if (rankingTab === 'pretest_p5') processingData = allStudents.filter(s => s.grade_level === 'p5');
        else if (rankingTab === 'pretest_p6') processingData = allStudents.filter(s => s.grade_level === 'p6');
        isPretestMode = true;
    }

    // ‡∏£‡∏±‡∏ô‡∏£‡∏∞‡∏ö‡∏ö Clearing House ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏ß‡πà‡∏≤‡πÉ‡∏Ñ‡∏£‡∏ï‡∏¥‡∏î‡∏ó‡∏µ‡πà‡πÑ‡∏´‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏ö‡πâ‡∏≤‡∏á
    const allocationResult = executeClearingHouse(processingData, quotas[adminTab]);
    
    let renderList = [];
    let showQuota = 0;
    let scoreLabel = "‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°";
    let subScoreType = "(‡∏î‡∏¥‡∏ö)";
    let title = "‡∏à‡∏±‡∏î‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô (Raw Data)";
    
    if (isFilteredMode) title = "‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Ñ‡∏±‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (‡∏ï‡∏±‡∏î Pre-test)";
    if (rankingTab.startsWith('pretest')) title = "‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô Pre-test";

    // Helper: ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏ï‡∏¥‡∏î‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏´‡∏°
    const gotHigherChoice = (student, currentProgram) => {
        const result = allocationResult[student.__backendId];
        if (!result) return false; // ‡πÑ‡∏°‡πà‡∏ï‡∏¥‡∏î‡∏ó‡∏µ‡πà‡πÑ‡∏´‡∏ô‡πÄ‡∏•‡∏¢
        
        // ‡∏ñ‡πâ‡∏≤‡∏ï‡∏¥‡∏î‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô -> ‡πÑ‡∏°‡πà‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡∏ï‡∏¥‡∏î‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤ (‡∏Ñ‡∏∑‡∏≠‡∏ï‡∏¥‡∏î‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡πÅ‡∏´‡∏•‡∏∞)
        if (result.program === currentProgram) return false;

        // ‡∏´‡∏≤ Priority ‡∏Ç‡∏≠‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡∏¥‡∏î‡∏à‡∏£‡∏¥‡∏á
        let winPriority = 99;
        if (student.choice_1 === result.program) winPriority = 1;
        else if (student.choice_2 === result.program) winPriority = 2;
        else if (student.choice_3 === result.program) winPriority = 3;

        // ‡∏´‡∏≤ Priority ‡∏Ç‡∏≠‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏π‡∏≠‡∏¢‡∏π‡πà (currentProgram)
        let currentPriority = 99;
        if (student.choice_1 === currentProgram) currentPriority = 1;
        else if (student.choice_2 === currentProgram) currentPriority = 2;
        else if (student.choice_3 === currentProgram) currentPriority = 3;

        // ‡∏ñ‡πâ‡∏≤ Priority ‡∏ó‡∏µ‡πà‡∏ï‡∏¥‡∏î‡∏à‡∏£‡∏¥‡∏á ‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤ (‡∏î‡∏µ‡∏Å‡∏ß‡πà‡∏≤) ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô -> ‡πÅ‡∏õ‡∏•‡∏ß‡πà‡∏≤‡∏ï‡∏¥‡∏î‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤‡πÅ‡∏•‡πâ‡∏ß
        return winPriority < currentPriority;
    };

    if (['all', 'filtered', 'pretest', 'pretest_p4', 'pretest_p5', 'pretest_p6'].includes(rankingTab)) {
        // === ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏° (‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏î‡∏¥‡∏ö) ===
        scoreLabel = "‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏° (110)";
        subScoreType = "(‡∏î‡∏¥‡∏ö)";
        renderList = [...processingData].sort((a,b) => b.total_score - a.total_score).map((s, i) => {
            const result = allocationResult[s.__backendId];
            return {
                ...s,
                show_sci: s.science_score, show_math: s.math_score, show_eng: s.english_score,
                display_score: s.total_score,
                status_text: result ? `‡∏ï‡∏¥‡∏î ${result.program}` : '‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå',
                got_program: result ? result.program : '-'
            };
        });
        // ‡∏£‡∏±‡∏ô‡πÄ‡∏•‡∏Ç‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°
        let currentRank = 1;
        for (let i = 0; i < renderList.length; i++) {
            if (i > 0 && Math.abs(renderList[i].display_score - renderList[i-1].display_score) < 0.001) renderList[i].rank = renderList[i-1].rank;
            else { currentRank++; renderList[i].rank = currentRank; }
            
            // ‡∏™‡∏µ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
            renderList[i].status_type = renderList[i].status_text.includes('‡∏ï‡∏¥‡∏î') ? 'pass' : 'fail';
        }

    } else {
        // === ‡πÅ‡∏¢‡∏Å‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ (‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÉ‡∏´‡∏°‡πà‡∏ï‡∏≤‡∏°‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô) ===
        const targetProgram = { 'sm': 'S&M', 'gate': 'GATE', 'eis': 'EIS', 'sme': 'SME' }[rankingTab];
        showQuota = (quotas[adminTab] && quotas[adminTab][targetProgram]) || 0;
        scoreLabel = "‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞";
        subScoreType = "(Weight)";

        // 1. ‡∏î‡∏∂‡∏á‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ ‡πÅ‡∏•‡∏∞ ‡πÑ‡∏°‡πà‡∏ï‡∏¥‡∏î‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤)
        renderList = processingData.filter(s => {
            // ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ
            const choseThis = (s.choice_1 === targetProgram || s.choice_2 === targetProgram || s.choice_3 === targetProgram);
            if (!choseThis) return false;

            // ‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏ï‡∏¥‡∏î‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏î‡∏µ‡∏Å‡∏ß‡πà‡∏≤ (‡πÄ‡∏ä‡πà‡∏ô ‡∏î‡∏π GATE ‡πÅ‡∏ï‡πà‡∏ï‡∏¥‡∏î S&M ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß -> ‡πÑ‡∏°‡πà‡πÄ‡∏≠‡∏≤‡∏°‡∏≤‡πÅ‡∏™‡∏î‡∏á)
            if (gotHigherChoice(s, targetProgram)) return false;

            return true;
        });

        // 2. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ï‡∏≤‡∏°‡∏™‡∏π‡∏ï‡∏£‡∏Ç‡∏≠‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ (Target Program)
        renderList = renderList.map(s => {
            const w_score = getWeightedScore(s, targetProgram); // ‡πÉ‡∏ä‡πâ‡∏™‡∏π‡∏ï‡∏£‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô
            const result = allocationResult[s.__backendId];
            const isPass = result && result.program === targetProgram;

            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏¢‡πà‡∏≠‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
            let w_sci=0, w_math=0, w_eng=0;
            const p = targetProgram.toLowerCase();
            const sci=parseFloat(s.science_score)||0, math=parseFloat(s.math_score)||0, eng=parseFloat(s.english_score)||0;
            
            if (p.includes('s&m') || p.includes('sme')) { w_sci=sci*1; w_math=math*(40/30); w_eng=eng*0.5; }
            else if (p.includes('gate')) { w_sci=sci*0.875; w_math=math*(35/30); w_eng=eng*0.75; }
            else if (p.includes('eis')) { w_sci=sci*0.75; w_math=math*1; w_eng=eng*1; }

            return {
                ...s,
                show_sci: w_sci, show_math: w_math, show_eng: w_eng,
                display_score: w_score,
                is_pass: isPass,
                status_text: isPass ? '‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£' : '‡∏™‡∏≥‡∏£‡∏≠‡∏á'
            };
        });

        // 3. ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ï‡∏≤‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏ô‡∏µ‡πâ (‡∏°‡∏≤‡∏Å -> ‡∏ô‡πâ‡∏≠‡∏¢)
        renderList.sort((a, b) => b.display_score - a.display_score);

        // 4. ‡∏£‡∏±‡∏ô‡πÄ‡∏•‡∏Ç‡∏•‡∏≥‡∏î‡∏±‡∏ö
        let currentRank = 1;
        for (let i = 0; i < renderList.length; i++) {
            if (i > 0) {
                if (Math.abs(renderList[i].display_score - renderList[i-1].display_score) < 0.00001) {
                    renderList[i].rank = renderList[i-1].rank;
                } else {
                    currentRank++;
                    renderList[i].rank = currentRank;
                }
            } else {
                renderList[i].rank = 1;
            }
            renderList[i].status_type = renderList[i].is_pass ? 'pass' : 'reserve';
        }
    }

    let tabs = [];
    if (adminTab === 'm1') {
        tabs = [
            { id: 'all', label: '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (Raw)' },
            { id: 'filtered', label: '‡∏ï‡∏±‡∏î ‡∏õ.4-5' },
            { id: 'pretest', label: 'Pre-test (‡∏£‡∏ß‡∏°)' },
            { id: 'pretest_p4', label: 'Pre-test (‡∏õ.4)' },
            { id: 'pretest_p5', label: 'Pre-test (‡∏õ.5)' },
            { id: 'pretest_p6', label: 'Pre-test (‡∏õ.6)' },
            { id: 'sm', label: 'S&M' },
            { id: 'gate', label: 'GATE' },
            { id: 'eis', label: 'EIS' }
        ];
    } else {
        tabs = [{ id: 'all', label: '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (Raw)' }, { id: 'sme', label: 'SME' }, { id: 'gate', label: 'GATE' }];
    }

    return `
    <div class="mb-6 flex flex-col md:flex-row justify-between items-start md:items-end gap-4">
        <div>
            <h1 class="text-2xl md:text-3xl font-bold text-gray-800 mb-2">${title} ${adminTab==='m1'?'‡∏°.1':'‡∏°.4'}</h1>
            <p class="text-sm text-gray-500">
                ${(isPretestMode || rankingTab === 'all' || rankingTab === 'filtered') 
                    ? '‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏î‡∏¥‡∏ö‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤ (‡πÄ‡∏ï‡πá‡∏° 40, 30, 40 ‡∏£‡∏ß‡∏° 110)' 
                    : '‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô <span class="font-bold text-lime-600">‡∏ï‡∏≤‡∏°‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ (Weighted Score)</span> ‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÉ‡∏´‡∏°‡πà'
                }
            </p>
            <div class="flex flex-wrap gap-2 mt-2">
                ${tabs.map(t => `<button onclick="rankingTab='${t.id}';renderAdminDashboard();" class="px-4 py-2 rounded-xl text-sm font-bold transition-all border ${rankingTab===t.id ? 'bg-teal-500 text-white border-teal-500 shadow-lg shadow-teal-200' : 'bg-white text-gray-500 border-gray-200 hover:bg-gray-50'}">${t.label}</button>`).join('')}
            </div>
        </div>
        
        <div class="flex gap-2">
            <button onclick="exportRankingToExcel()" class="flex items-center gap-2 px-3 py-3 bg-green-600 hover:bg-green-700 text-white rounded-xl font-bold shadow-lg shadow-green-200 transition-all active:scale-95 text-xs md:text-sm">Excel</button>
            <button onclick="exportToWord()" class="flex items-center gap-2 px-3 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-xl font-bold shadow-lg shadow-blue-200 transition-all active:scale-95 text-xs md:text-sm">Word</button>
        </div>
    </div>

    <div class="bg-white rounded-3xl shadow-sm overflow-hidden border border-gray-100">
        <div class="p-4 bg-gray-50 border-b border-gray-100 flex justify-between items-center">
            <h3 class="font-bold text-gray-700">${(isPretestMode || rankingTab === 'all' || rankingTab === 'filtered') ? '‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≠‡∏ö' : '‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡πÅ‡∏•‡∏∞‡∏™‡∏≥‡∏£‡∏≠‡∏á (‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô)'}</h3>
            <div class="text-xs font-bold text-gray-400">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: ${renderList.length} ‡∏Ñ‡∏ô ${(!isPretestMode && rankingTab!=='all' && rankingTab!=='filtered') ? `/ ‡∏£‡∏±‡∏ö ${showQuota}` : ''}</div>
        </div>
        <div class="overflow-x-auto">
            <table class="w-full text-left border-collapse">
                <thead class="bg-white text-gray-600 text-sm uppercase font-bold border-b border-gray-100">
                    <tr>
                        <th class="px-4 py-3 w-16 text-center">‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
                        <th class="px-4 py-3">‡∏£‡∏´‡∏±‡∏™-‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏Å‡∏∏‡∏•</th>
                        <th class="px-2 py-3 text-center text-blue-600">‡∏ß‡∏¥‡∏ó‡∏¢‡πå<br><span class="text-[10px] text-gray-400">${subScoreType}</span></th>
                        <th class="px-2 py-3 text-center text-red-600">‡∏Ñ‡∏ì‡∏¥‡∏ï<br><span class="text-[10px] text-gray-400">${subScoreType}</span></th>
                        <th class="px-2 py-3 text-center text-purple-600">‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©<br><span class="text-[10px] text-gray-400">${subScoreType}</span></th>
                        <th class="px-4 py-3 text-center font-black text-gray-700 bg-gray-50">${scoreLabel}</th>
                        <th class="px-4 py-3">‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</th>
                        <th class="px-4 py-3 text-center">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-50 text-sm">
                    ${renderList.length > 0 ? renderList.map(s => `
                    <tr class="hover:bg-gray-50 transition-colors ${s.status_type === 'pass' ? 'bg-green-50/30' : ''}">
                        <td class="px-4 py-3 text-center font-bold text-gray-500">#${s.rank}</td>
                        <td class="px-4 py-3">
                            <div class="font-bold text-gray-700">${s.exam_id}</div>
                            <div class="text-xs text-gray-500">${s.full_name}</div>
                        </td>
                        <td class="px-2 py-3 text-center font-medium text-gray-600">${s.show_sci.toFixed(2)}</td>
                        <td class="px-2 py-3 text-center font-medium text-gray-600">${s.show_math.toFixed(2)}</td>
                        <td class="px-2 py-3 text-center font-medium text-gray-600">${s.show_eng.toFixed(2)}</td>
                        <td class="px-4 py-3 text-center font-bold text-gray-800 bg-gray-50/50">${s.display_score.toFixed(2)}</td>
                        
                        <td class="px-4 py-3 text-xs text-gray-500 space-y-1">
                            ${[s.choice_1, s.choice_2, (adminTab!=='m4'?s.choice_3:null)].filter(c=>c).map((c,i)=>`
                                <div class="${c.includes({sm:'S&M',gate:'GATE',eis:'EIS',sme:'SME'}[rankingTab]) ? 'font-bold text-teal-600 underline' : ''}">${i+1}. ${c}</div>
                            `).join('')}
                        </td>
                        <td class="px-4 py-3 text-center">
                             ${s.status_type === 'pass'
                                ? `<span class="px-3 py-1 rounded-full bg-green-100 text-green-700 font-bold text-xs shadow-sm">${s.status_text}</span>`
                                : `<span class="px-3 py-1 rounded-full bg-orange-100 text-orange-700 font-bold text-xs shadow-sm">${s.status_text}</span>`
                            }
                        </td>
                    </tr>`).join('') : `<tr><td colspan="8" class="text-center py-8 text-gray-400">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>`}
                </tbody>
            </table>
        </div>
    </div>
    `;
}
// --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ü‡∏•‡πå Word (.doc) ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£ ---
function exportToWord() {
    const m1 = studentsData.filter(s => ['p4','p5','p6','m1'].includes(s.grade_level));
    const m4 = studentsData.filter(s => ['m3','m4'].includes(s.grade_level));
    let activeData = adminTab === 'm1' ? m1 : m4;

    let isFilteredMode = false;
    let isPretestMode = false;

    if (rankingTab === 'filtered') {
        if (adminTab === 'm1') activeData = activeData.filter(s => !['p4', 'p5'].includes(s.grade_level));
        isFilteredMode = true;
    } else if (rankingTab === 'pretest') {
        if (adminTab === 'm1') activeData = activeData.filter(s => ['p4', 'p5'].includes(s.grade_level));
        isPretestMode = true;
    } else if (rankingTab === 'pretest_p4') {
        if (adminTab === 'm1') activeData = activeData.filter(s => s.grade_level === 'p4');
        isPretestMode = true;
    } else if (rankingTab === 'pretest_p5') {
        if (adminTab === 'm1') activeData = activeData.filter(s => s.grade_level === 'p5');
        isPretestMode = true;
    } else if (rankingTab === 'pretest_p6') {
        if (adminTab === 'm1') activeData = activeData.filter(s => s.grade_level === 'p6');
        isPretestMode = true;
    }

    const allocationResult = executeClearingHouse(activeData, quotas[adminTab]);
    let dataList = [];
    let titleProgram = "";

    if (rankingTab === 'all' || isFilteredMode || isPretestMode) {
        dataList = [...activeData].sort((a,b) => b.total_score - a.total_score).map((s, i) => ({
            ...s, 
            score_to_show: s.total_score,
            raw_sci: parseFloat(s.science_score)||0,
            raw_math: parseFloat(s.math_score)||0,
            raw_eng: parseFloat(s.english_score)||0
        }));
        
        titleProgram = `‡∏™‡∏£‡∏∏‡∏õ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏° ${isFilteredMode ? '(‡∏Ñ‡∏±‡∏î‡∏Å‡∏£‡∏≠‡∏á)' : '(‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)'}`;
        if(rankingTab === 'pretest') titleProgram = "‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô Pre-test (‡∏£‡∏ß‡∏° ‡∏õ.4-5)";
        if(rankingTab === 'pretest_p4') titleProgram = "‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô Pre-test (‡πÄ‡∏â‡∏û‡∏≤‡∏∞ ‡∏õ.4)";
        if(rankingTab === 'pretest_p5') titleProgram = "‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô Pre-test (‡πÄ‡∏â‡∏û‡∏≤‡∏∞ ‡∏õ.5)";
        if(rankingTab === 'pretest_p6') titleProgram = "‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô Pre-test (‡πÄ‡∏â‡∏û‡∏≤‡∏∞ ‡∏õ.6)";

    } else {
        const targetProgram = { 'sm': 'S&M', 'gate': 'GATE', 'eis': 'EIS', 'sme': 'SME' }[rankingTab];
        const getChoiceRank = (student, prog) => { if (student.choice_1 === prog) return 1; if (student.choice_2 === prog) return 2; if (student.choice_3 === prog) return 3; return 99; };
        
        dataList = activeData.filter(s => {
            const targetRank = getChoiceRank(s, targetProgram);
            if (targetRank === 99) return false;
            const officialResult = allocationResult[s.__backendId];
            if (officialResult && officialResult.program === targetProgram) return true;
            const officialRank = officialResult ? getChoiceRank(s, officialResult.program) : 99;
            return targetRank < officialRank; 
        });

        dataList = dataList.map(s => {
            const officialResult = allocationResult[s.__backendId];
            const isReal = officialResult && officialResult.program === targetProgram;
            return { ...s, score_to_show: getWeightedScore(s, targetProgram), is_real: isReal, official_result: officialResult, choice_priority: getChoiceRank(s, targetProgram) };
        });

        // üî• ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ üî•
        dataList.sort((a, b) => {
            if (a.is_real && !b.is_real) return -1; if (!a.is_real && b.is_real) return 1;
            return b.score_to_show - a.score_to_show;
        });
        titleProgram = targetProgram;
    }

    if (dataList.length === 0) return showAlert('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô');

    let currentRank = 1;
    for (let i = 0; i < dataList.length; i++) {
        if (i > 0) {
            const scoreSame = Math.abs(dataList[i].score_to_show - dataList[i-1].score_to_show) < 0.00001;
            const statusSame = (!isPretestMode && !isFilteredMode && rankingTab !== 'all') ? (dataList[i].is_real === dataList[i-1].is_real) : true;
            if (scoreSame && statusSame) dataList[i].rank = dataList[i-1].rank;
            else { currentRank++; dataList[i].rank = currentRank; }
        } else { dataList[i].rank = 1; }
        
        if (!isPretestMode && !isFilteredMode && rankingTab !== 'all') {
            if (dataList[i].is_real) dataList[i].status_text = '‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£';
            else {
                const other = dataList[i].official_result;
                dataList[i].status_text = other ? `‡∏™‡∏≥‡∏£‡∏≠‡∏á (‡∏ï‡∏¥‡∏î ${other.program})` : '‡∏™‡∏≥‡∏£‡∏≠‡∏á';
            }
        }
    }

    let tableHeader = "";
    let tableBody = "";

    if (isPretestMode) {
        tableHeader = `
            <tr>
                <th width="8%">‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
                <th width="15%">‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏™‡∏≠‡∏ö</th>
                <th width="25%">‡∏ä‡∏∑‡πà‡∏≠ - ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
                <th width="20%">‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</th>
                <th width="8%">‡∏ß‡∏¥‡∏ó‡∏¢‡πå</th>
                <th width="8%">‡∏Ñ‡∏ì‡∏¥‡∏ï</th>
                <th width="8%">‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©</th>
                <th width="8%">‡∏£‡∏ß‡∏°</th>
            </tr>
        `;
        tableBody = dataList.map(s => `
            <tr>
                <td style="text-align:center;">${s.rank}</td>
                <td style="text-align:center;">${s.exam_id}</td>
                <td>${s.full_name}</td>
                <td>${s.previous_school || '-'}</td>
                <td style="text-align:center;">${s.raw_sci}</td>
                <td style="text-align:center;">${s.raw_math}</td>
                <td style="text-align:center;">${s.raw_eng}</td>
                <td style="text-align:center; font-weight:bold;">${s.score_to_show.toFixed(2)}</td>
            </tr>
        `).join('');
    } else {
        tableHeader = `
            <tr>
                <th width="8%">‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
                <th width="15%">‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏™‡∏≠‡∏ö</th>
                <th width="35%">‡∏ä‡∏∑‡πà‡∏≠ - ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
                <th width="27%">‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</th>
                <th width="15%">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
            </tr>
        `;
        tableBody = dataList.map(s => `
            <tr>
                <td style="text-align:center;">${s.rank}</td>
                <td style="text-align:center;">${s.exam_id}</td>
                <td>${s.full_name}</td>
                <td>${s.previous_school || '-'}</td>
                <td></td>
            </tr>
        `).join('');
    }

    const docContent = `
        <html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'>
        <head><meta charset='utf-8'><title>${titleProgram}</title>
        <style>
            body { font-family: 'TH Sarabun New', 'Angsana New', sans-serif; font-size: 16pt; }
            table { border-collapse: collapse; width: 100%; margin-top: 10px; }
            td, th { border: 1px solid #000; padding: 5px; vertical-align: middle; }
            th { background-color: #f0f0f0; text-align: center; font-weight: bold; }
            .header { text-align: center; margin-bottom: 20px; }
        </style>
        </head><body>
        
        <div class="header">
            <img src="https://img2.pic.in.th/pic/d73e30e222a61a2282bfaff6919fa6ec.png" width="80" height="auto"><br>
            <b>‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ö‡∏≤‡∏á‡∏™‡∏∞‡∏û‡∏≤‡∏ô‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤</b><br>
            ${isPretestMode ? '‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö (Pre-test)' : '‡πÅ‡∏ö‡∏ö‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏™‡∏≠‡∏ö‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥'} ${titleProgram}<br>
            ‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏ó‡∏≤‡∏á‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏ä‡∏£‡∏£‡∏≤‡∏ä‡∏û‡∏§‡∏Å‡∏©‡πå ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤ 2569
        </div>

        <table>
            <thead>${tableHeader}</thead>
            <tbody>${tableBody}</tbody>
        </table>
        </body></html>
    `;

    const blob = new Blob(['\ufeff', docContent], { type: 'application/msword' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `${titleProgram}.doc`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}
    
function triggerSearch() { searchQuery = document.getElementById('search-input').value.trim(); renderAdminDashboard(); }

function renderStudentView() {
    if(!currentUser) return;

    // --- 1. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏ï‡πá‡∏° (‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î) ---
    const maxSci = 40; 
    const maxMath = 30; 
    const maxEng = 40; 
    const maxTotal = 110;

    const sSci = parseFloat(currentUser.science_score)||0;
    const sMath = parseFloat(currentUser.math_score)||0;
    const sEng = parseFloat(currentUser.english_score)||0;
    const sTotal = sSci + sMath + sEng;

    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì % ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏Å‡∏±‡∏ö‡∏´‡∏•‡∏≠‡∏î‡∏û‡∏•‡∏±‡∏á (Progress Bar) ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô (‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç %)
    const pSci = (sSci/maxSci)*100;
    const pMath = (sMath/maxMath)*100;
    const pEng = (sEng/maxEng)*100;

    const thaiGrade = getThaiGrade(currentUser.grade_level);
    const grade = currentUser.grade_level.toLowerCase();

    const showProjectsSection = !['p4', 'p5'].includes(grade); 
    const showRank3 = !['m3', 'm4'].includes(grade); 

    // --- 2. Render HTML ---
    document.getElementById('app').innerHTML = `
    <div class="h-full bg-[#fdfbf7] overflow-auto font-sarabun">
        <div class="gradient-bg h-48 w-full absolute top-0 left-0 z-0 rounded-b-[3rem] shadow-lg opacity-90"></div>
        <div class="relative z-10 max-w-4xl mx-auto p-4 pt-8 pb-10">

            <div class="bg-white rounded-[2rem] p-8 mb-4 md:mb-6 shadow-xl relative overflow-hidden border border-lime-100 text-center">
                <div class="relative z-10 flex flex-col items-center">
                    <img src="https://img5.pic.in.th/file/secure-sv1/-69-1112b7dae5160e09f.png" alt="Logo" class="w-56 h-auto mb-6 drop-shadow-md hover:scale-105 transition-transform duration-500">
                    <h1 class="text-xl md:text-2xl font-bold text-lime-900 leading-tight mb-2">
                        ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ú‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏ä‡∏£‡∏£‡∏≤‡∏ä‡∏û‡∏§‡∏Å‡∏©‡πå
                    </h1>
                    <h2 class="text-lg md:text-xl font-bold text-lime-900 leading-tight mb-2">
                        ‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤ 2569
                    </h2>
                    <p class="text-lime-800 font-medium text-lg">
                        ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ö‡∏≤‡∏á‡∏™‡∏∞‡∏û‡∏≤‡∏ô‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤ ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏õ‡∏£‡∏∞‡∏à‡∏ß‡∏ö‡∏Ñ‡∏µ‡∏£‡∏µ‡∏Ç‡∏±‡∏ô‡∏ò‡πå
                    </p>
                </div>

                <div class="hidden md:block absolute bottom-4 right-4 z-20">
                    <button onclick="currentView='login';render()" class="bg-red-50 hover:bg-red-500 text-red-500 hover:text-white px-4 py-2 rounded-full text-xs font-bold transition-all border border-red-100 flex items-center gap-2 shadow-sm">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                        ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
                    </button>
                </div>
            </div>

            <div class="md:hidden flex justify-end mb-6 px-2">
                <button onclick="currentView='login';render()" class="bg-white text-red-500 hover:bg-red-50 px-5 py-2.5 rounded-full text-sm font-bold transition-all border border-red-100 shadow-md flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                    ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
                </button>
            </div>

            <div class="bg-white rounded-[2rem] p-6 shadow-xl mb-6 relative overflow-hidden border border-lime-100">
                <div class="absolute top-0 right-0 w-32 h-32 bg-lime-50 rounded-full -mr-10 -mt-10 opacity-60"></div>
                <div class="flex flex-col md:flex-row items-center gap-6 relative z-10">
                    <div class="flex-1 text-center md:text-left w-full">
                        <h2 class="text-2xl font-bold text-gray-800 mb-1">${currentUser.full_name}</h2>
                        <p class="text-lime-600 font-medium mb-4 text-sm">${thaiGrade}</p>
                        <div class="grid grid-cols-1 gap-3 text-gray-600 text-sm">
                            <div class="bg-gray-50 px-4 py-3 rounded-xl border border-gray-100 flex justify-between"><span>‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏™‡∏≠‡∏ö</span><span class="font-bold text-gray-800">${currentUser.exam_id}</span></div>
                            <div class="bg-gray-50 px-4 py-3 rounded-xl border border-gray-100 flex justify-between"><span>‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</span><span class="font-bold text-gray-800 truncate max-w-[150px]">${currentUser.previous_school}</span></div>
                        </div>
                    </div>
                </div>
            </div>

            ${showProjectsSection ? `
            <div class="mb-8">
                <h3 class="text-gray-600 font-bold text-lg mb-4 ml-2 flex items-center gap-2">
                    <svg class="w-5 h-5 text-lime-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path></svg>
                    ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                    <div class="bg-white border-2 border-lime-100 p-4 rounded-2xl flex items-center gap-4 shadow-sm relative overflow-hidden">
                        <div class="bg-lime-500 text-white w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm shrink-0 shadow-md">1</div>
                        <div class="flex flex-col z-10"><span class="text-[10px] text-gray-400 font-bold uppercase">‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà 1</span><span class="font-bold text-gray-700 text-lg">${currentUser.choice_1 || '-'}</span></div>
                        <div class="absolute right-[-10px] bottom-[-10px] text-lime-50 opacity-50 font-black text-6xl pointer-events-none">1</div>
                    </div>
                    <div class="bg-white border-2 border-lime-100 p-4 rounded-2xl flex items-center gap-4 shadow-sm relative overflow-hidden">
                        <div class="bg-lime-400 text-white w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm shrink-0 shadow-md">2</div>
                        <div class="flex flex-col z-10"><span class="text-[10px] text-gray-400 font-bold uppercase">‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà 2</span><span class="font-bold text-gray-700 text-lg">${currentUser.choice_2 || '-'}</span></div>
                        <div class="absolute right-[-10px] bottom-[-10px] text-lime-50 opacity-50 font-black text-6xl pointer-events-none">2</div>
                    </div>
                    ${showRank3 ? `
                    <div class="bg-white border-2 border-lime-100 p-4 rounded-2xl flex items-center gap-4 shadow-sm relative overflow-hidden ${!currentUser.choice_3 ? 'opacity-50 grayscale' : ''}">
                        <div class="bg-lime-300 text-white w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm shrink-0 shadow-md">3</div>
                        <div class="flex flex-col z-10"><span class="text-[10px] text-gray-400 font-bold uppercase">‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà 3</span><span class="font-bold text-gray-700 text-lg">${currentUser.choice_3 || '-'}</span></div>
                        <div class="absolute right-[-10px] bottom-[-10px] text-lime-50 opacity-50 font-black text-6xl pointer-events-none">3</div>
                    </div>` : ''}
                </div>
            </div>` : ''}

            <h3 class="text-gray-600 font-bold text-lg mb-4 ml-2 flex items-center gap-2"><svg class="w-5 h-5 text-lime-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤</h3>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 flex flex-col gap-2 relative overflow-hidden group hover:shadow-md transition-shadow">
                    <div class="absolute right-0 top-0 w-16 h-16 bg-blue-50 rounded-bl-full -mr-2 -mt-2 transition-transform group-hover:scale-110"></div>
                    <div class="flex justify-between items-center mb-1 relative z-10">
                        <div class="flex items-center gap-2">
                            <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center text-blue-500"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path></svg></div>
                            <span class="text-gray-600 text-xs font-bold uppercase tracking-wider">‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå</span>
                        </div>
                        <span class="text-[10px] text-gray-400 font-bold bg-gray-50 px-2 py-0.5 rounded-full border border-gray-100">‡πÄ‡∏ï‡πá‡∏° ${maxSci}</span>
                    </div>
                    
                    <div class="flex justify-between items-center mt-2 relative z-10">
                        <span class="text-sm text-gray-500 font-bold">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ</span>
                        <span class="text-3xl font-bold text-gray-800">${sSci}</span>
                    </div>
                    
                    <div class="w-full bg-gray-100 h-2 rounded-full overflow-hidden mt-3 relative z-10"><div class="bg-blue-400 h-2 rounded-full" style="width: ${pSci}%"></div></div>
                </div>

                <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 flex flex-col gap-2 relative overflow-hidden group hover:shadow-md transition-shadow">
                    <div class="absolute right-0 top-0 w-16 h-16 bg-red-50 rounded-bl-full -mr-2 -mt-2 transition-transform group-hover:scale-110"></div>
                    <div class="flex justify-between items-center mb-1 relative z-10">
                        <div class="flex items-center gap-2">
                            <div class="w-8 h-8 bg-red-100 rounded-full flex items-center justify-center text-red-500"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg></div>
                            <span class="text-gray-600 text-xs font-bold uppercase tracking-wider">‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå</span>
                        </div>
                        <span class="text-[10px] text-gray-400 font-bold bg-gray-50 px-2 py-0.5 rounded-full border border-gray-100">‡πÄ‡∏ï‡πá‡∏° ${maxMath}</span>
                    </div>
                    
                    <div class="flex justify-between items-center mt-2 relative z-10">
                        <span class="text-sm text-gray-500 font-bold">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ</span>
                        <span class="text-3xl font-bold text-gray-800">${sMath}</span>
                    </div>

                    <div class="w-full bg-gray-100 h-2 rounded-full overflow-hidden mt-3 relative z-10"><div class="bg-red-400 h-2 rounded-full" style="width: ${pMath}%"></div></div>
                </div>

                <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 flex flex-col gap-2 relative overflow-hidden group hover:shadow-md transition-shadow">
                    <div class="absolute right-0 top-0 w-16 h-16 bg-purple-50 rounded-bl-full -mr-2 -mt-2 transition-transform group-hover:scale-110"></div>
                    <div class="flex justify-between items-center mb-1 relative z-10">
                        <div class="flex items-center gap-2">
                            <div class="w-8 h-8 bg-purple-100 rounded-full flex items-center justify-center text-purple-500"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129"></path></svg></div>
                            <span class="text-gray-600 text-xs font-bold uppercase tracking-wider">‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©</span>
                        </div>
                        <span class="text-[10px] text-gray-400 font-bold bg-gray-50 px-2 py-0.5 rounded-full border border-gray-100">‡πÄ‡∏ï‡πá‡∏° ${maxEng}</span>
                    </div>
                    
                    <div class="flex justify-between items-center mt-2 relative z-10">
                        <span class="text-sm text-gray-500 font-bold">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ</span>
                        <span class="text-3xl font-bold text-gray-800">${sEng}</span>
                    </div>

                    <div class="w-full bg-gray-100 h-2 rounded-full overflow-hidden mt-3 relative z-10"><div class="bg-purple-400 h-2 rounded-full" style="width: ${pEng}%"></div></div>
                </div>
            </div>

            <div class="bg-gradient-to-br from-amber-50 via-orange-50 to-white rounded-3xl p-6 border border-amber-100 text-center relative overflow-hidden shadow-sm">
                <div class="absolute top-0 left-0 w-full h-full bg-[url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAiIGhlaWdodD0iMjAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGNpcmNsZSBjeD0iMSIgY3k9IjEiIHI9IjEiIGZpbGw9IiNmYmJmMjQiIGZpbGwtb3BhY2l0eT0iMC4yIi8+PC9zdmc+')] opacity-30"></div>
                <div class="relative z-10 flex flex-col items-center">
                    <p class="text-amber-700 font-bold uppercase tracking-widest text-xs mb-2">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏° 3 ‡∏ß‡∏¥‡∏ä‡∏≤ (‡πÄ‡∏ï‡πá‡∏° ${maxTotal})</p>
                    <div class="flex items-baseline gap-2">
                        <p class="text-5xl font-black text-amber-500 drop-shadow-sm tracking-tight">${sTotal.toFixed(2)}</p>
                    </div>
                    <span class="text-xs font-bold text-amber-700 bg-amber-100/50 px-4 py-1.5 rounded-full mt-3 border border-amber-200">‡∏Ñ‡∏¥‡∏î‡πÄ‡∏õ‡πá‡∏ô‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞ ${((sTotal/maxTotal)*100).toFixed(1)}</span>
                </div>
            </div>

            <div class="mt-8 mb-4 text-center border-t border-gray-200/50 pt-4">
                <p class="text-xs text-gray-400 font-medium">‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡πÇ‡∏î‡∏¢ ‡∏Ñ‡∏£‡∏π‡∏≠‡∏≤‡∏ô‡∏ô‡∏ó‡πå ‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡πÅ‡∏Å‡πâ‡∏ß</p>
            </div>

        </div>
    </div>
    `;
}
  
function switchAddTab(tabName) { 
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active')); 
    document.getElementById(`tab-${tabName}`).classList.add('active'); 
    // ‡πÄ‡∏û‡∏¥‡πà‡∏° 'practical' ‡πÉ‡∏ô list ‡∏ô‡∏µ‡πâ
    ['single','multiple','excel','score','practical'].forEach(v => document.getElementById(`view-${v}`).classList.add('hidden')); 
    document.getElementById(`view-${tabName}`).classList.remove('hidden'); 
    if(tabName==='multiple') { document.getElementById('multiple-tbody').innerHTML=''; addMultipleRow(); } 
}
function showAddStudentForm() { formMode = 'create'; document.getElementById('modal-title').textContent = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≠‡∏ö‡πÉ‡∏´‡∏°‡πà'; document.getElementById('add-mode-tabs').classList.remove('hidden'); document.getElementById('score-section').classList.add('hidden'); switchAddTab('single'); document.getElementById('student-form').reset(); openModal(); }
function showEditForm(id) {
    formMode = 'update';
    document.getElementById('modal-title').textContent = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
    document.getElementById('add-mode-tabs').classList.add('hidden');
    ['single','multiple','excel','score'].forEach(v => document.getElementById(`view-${v}`).classList.add('hidden'));
    document.getElementById('view-single').classList.remove('hidden');
    document.getElementById('score-section').classList.remove('hidden');
    
    const s = studentsData.find(x => x.__backendId === id);
    if(!s) return;
    
    document.getElementById('student-backend-id').value = s.__backendId;
    document.getElementById('form-national-id').value = s.national_id || '';
    document.getElementById('form-exam-id').value = s.exam_id;
    document.getElementById('form-grade').value = s.grade_level;
    document.getElementById('form-name').value = s.full_name;
    document.getElementById('form-school').value = s.previous_school;
    
    // -- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ --
    document.getElementById('form-choice-1').value = s.choice_1 || '';
    document.getElementById('form-choice-2').value = s.choice_2 || '';
    document.getElementById('form-choice-3').value = s.choice_3 || '';
    // -------------------------

    document.getElementById('score-science').value = s.science_score;
    document.getElementById('score-math').value = s.math_score;
    document.getElementById('score-english').value = s.english_score;
    
    openModal();
}

function handleSingleSubmit(e) {
    e.preventDefault();
    const scores = [
        0, 
        parseFloat(document.getElementById('score-math').value)||0, 
        parseFloat(document.getElementById('score-science').value)||0, 
        parseFloat(document.getElementById('score-english').value)||0, 
        0
    ];
    
    const data = {
        exam_id: document.getElementById('form-exam-id').value,
        national_id: document.getElementById('form-national-id').value,
        grade_level: document.getElementById('form-grade').value,
        full_name: document.getElementById('form-name').value,
        previous_school: document.getElementById('form-school').value,
        // -- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ --
        choice_1: document.getElementById('form-choice-1').value,
        choice_2: document.getElementById('form-choice-2').value,
        choice_3: document.getElementById('form-choice-3').value,
        // -----------------------------
        thai_score: scores[0],
        math_score: scores[1],
        science_score: scores[2],
        english_score: scores[3],
        aptitude_score: scores[4],
        total_score: scores.reduce((a,b)=>a+b,0)
    };
    
    showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...');
    const action = formMode === 'create' ? window.dataSdk.create(data) : (data.__backendId = document.getElementById('student-backend-id').value, window.dataSdk.update(data));
    
    action.then(res => {
        setTimeout(() => {
            hideLoading();
            if(res.isOk) {
                closeModal();
                showAlert('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
            } else {
                showAlert('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', res.error.message);
            }
        }, 500);
    });
}
function addMultipleRow() { const tr = document.createElement('tr'); tr.className = 'bg-white border-b hover:bg-gray-50'; tr.innerHTML = `<td class="p-2"><input type="text" class="w-full border rounded px-2 py-1 multi-national-id text-xs" placeholder="‡∏ö‡∏±‡∏ï‡∏£‡∏Ø"></td><td class="p-2"><input type="text" class="w-full border rounded px-2 py-1 multi-exam-id text-xs" placeholder="‡∏£‡∏´‡∏±‡∏™"></td><td class="p-2"><input type="text" class="w-full border rounded px-2 py-1 multi-name text-xs" placeholder="‡∏ä‡∏∑‡πà‡∏≠"></td><td class="p-2"><select class="w-full border rounded px-2 py-1 multi-grade text-xs"><option value="p6">‡∏õ.6</option><option value="p5">‡∏õ.5</option><option value="p4">‡∏õ.4</option><option value="m3">‡∏°.3</option></select></td><td class="p-2"><input type="text" class="w-full border rounded px-2 py-1 multi-school text-xs" placeholder="‡∏£‡∏£."></td><td class="p-2 text-center"><button type="button" onclick="this.closest('tr').remove()" class="text-red-500 font-bold">x</button></td>`; document.getElementById('multiple-tbody').appendChild(tr); }
function handleMultipleSubmit() { const rows = document.querySelectorAll('#multiple-tbody tr'); const bulkData = []; rows.forEach(row => { const nid = row.querySelector('.multi-national-id').value.trim(); const id = row.querySelector('.multi-exam-id').value.trim(); const name = row.querySelector('.multi-name').value.trim(); if(id && name) bulkData.push({ exam_id: id, national_id: nid, full_name: name, grade_level: row.querySelector('.multi-grade').value, previous_school: row.querySelector('.multi-school').value.trim(), thai_score:0, math_score:0, science_score:0, english_score:0, aptitude_score:0, total_score:0, rank:0 }); }); if(bulkData.length === 0) return showAlert('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£'); showConfirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô', `‡πÄ‡∏û‡∏¥‡πà‡∏° ${bulkData.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£?`, () => { showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...'); window.dataSdk.createBulk(bulkData).then(res => { setTimeout(() => { hideLoading(); if(res.isOk) { closeModal(); showAlert('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢'); } else { showAlert('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', res.error.message); } }, 500); }); }); }
function handleExcelUpload(input, type) {
    if(!input.files[0]) return;
    const reader = new FileReader();
    reader.onload = (e) => {
        const workbook = XLSX.read(new Uint8Array(e.target.result), {type: 'array'});
        const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], {header: 1, raw: false, defval: ""});
        
        if(type === 'student') {
            // ... (‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏°) ...
            excelDataCache = [];
            for(let i=1; i<jsonData.length; i++) {
                const row = jsonData[i];
                if(row[0] && row[2]) {
                    excelDataCache.push({
                        exam_id: String(row[0]),
                        national_id: String(row[1]||''),
                        full_name: String(row[2]),
                        grade_level: String(row[3]||'m3').toLowerCase(),
                        previous_school: String(row[4]||''),
                        choice_1: String(row[5]||'').trim(),
                        choice_2: String(row[6]||'').trim(),
                        choice_3: String(row[7]||'').trim(),
                        thai_score:0, math_score:0, science_score:0, english_score:0, aptitude_score:0, total_score:0, rank:0, practical_score:0
                    });
                }
            }
            document.getElementById('excel-count').textContent = excelDataCache.length;
            document.getElementById('excel-preview-area').classList.remove('hidden');
            document.getElementById('excel-preview-table').innerHTML = 
                `<thead><tr class="bg-gray-100"><th>‡∏£‡∏´‡∏±‡∏™</th><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å 1</th></tr></thead><tbody>` + 
                excelDataCache.slice(0,5).map(p=>`<tr><td>${p.exam_id}</td><td>${p.full_name}</td><td>${p.choice_1}</td></tr>`).join('') + 
                `</tbody>`;
        
        } else if(type === 'score') {
            // ... (‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏°) ...
            scoreDataCache = [];
            for(let i=1; i<jsonData.length; i++) {
                const row = jsonData[i];
                if(row[0]) scoreDataCache.push({ exam_id: String(row[0]), science_score: row[1]||0, math_score: row[2]||0, english_score: row[3]||0 });
            }
            document.getElementById('score-count').textContent = scoreDataCache.length;
            document.getElementById('score-preview-area').classList.remove('hidden');
            document.getElementById('score-preview-table').innerHTML = `<thead><tr class="bg-gray-100"><th>‡∏£‡∏´‡∏±‡∏™</th><th>‡∏ß‡∏¥‡∏ó‡∏¢‡πå</th><th>‡∏Ñ‡∏ì‡∏¥‡∏ï</th><th>‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©</th></tr></thead><tbody>` + scoreDataCache.slice(0,5).map(p=>`<tr><td>${p.exam_id}</td><td>${p.science_score}</td><td>${p.math_score}</td><td>${p.english_score}</td></tr>`).join('') + `</tbody>`;
        
        } else if (type === 'practical') {
            // >>> ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥ <<<
            practicalDataCache = [];
            for(let i=1; i<jsonData.length; i++) {
                const row = jsonData[i];
                const examId = String(row[0]).trim();
                const score = parseFloat(row[1]);

                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏£‡∏¥‡∏á‡πÑ‡∏´‡∏°
                const student = studentsData.find(s => String(s.exam_id) === examId);
                
                if(examId && !isNaN(score) && student) {
                    practicalDataCache.push({ 
                        __backendId: student.__backendId, // ‡πÄ‡∏Å‡πá‡∏ö ID ‡∏à‡∏£‡∏¥‡∏á‡πÑ‡∏ß‡πâ‡πÉ‡∏ä‡πâ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï
                        exam_id: examId, 
                        full_name: student.full_name,
                        practical_score: score,
                        original_data: student // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏ß‡πâ‡∏Å‡∏±‡∏ô‡πÄ‡∏´‡∏ô‡∏µ‡∏¢‡∏ß
                    });
                }
            }
            document.getElementById('practical-count').textContent = practicalDataCache.length;
            document.getElementById('practical-preview-area').classList.remove('hidden');
            document.getElementById('practical-preview-table').innerHTML = 
                `<thead><tr class="bg-indigo-50 text-indigo-900"><th>‡∏£‡∏´‡∏±‡∏™</th><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥</th></tr></thead><tbody>` + 
                practicalDataCache.slice(0,5).map(p=>`<tr><td>${p.exam_id}</td><td>${p.full_name}</td><td class="font-bold text-indigo-700">${p.practical_score}</td></tr>`).join('') + 
                `</tbody>`;
        }
    };
    reader.readAsArrayBuffer(input.files[0]);
}
function confirmExcelImport(type) { 
    if(type === 'student' && excelDataCache.length > 0) { 
        showConfirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô', `‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ ${excelDataCache.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£?`, () => { 
            showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤...'); 
            window.dataSdk.createBulk(excelDataCache).then(res => { 
                setTimeout(() => { 
                    hideLoading(); 
                    if(res.isOk) { closeModal(); showAlert('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢'); } 
                    else { showAlert('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', res.error.message); } 
                }, 500); 
            }); 
        }); 
    } else if(type === 'score' && scoreDataCache.length > 0) { 
        showConfirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô', `‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô ${scoreDataCache.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£?`, () => { 
            showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô...'); 
            window.dataSdk.updateScoresBulk(scoreDataCache).then(res => { 
                setTimeout(() => { 
                    hideLoading(); 
                    if(res.isOk) { closeModal(); showAlert('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', res.message); } 
                    else { showAlert('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', res.error.message); } 
                }, 500); 
            }); 
        }); 
    } else if (type === 'practical' && practicalDataCache.length > 0) {
        // >>> ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà <<<
        showConfirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô', `‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥ ${practicalDataCache.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£?`, () => {
            showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥... (‡∏´‡πâ‡∏≤‡∏°‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠)');
            
            // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á (Merge ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏° + ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÉ‡∏´‡∏°‡πà)
            const updates = practicalDataCache.map(item => ({
                ...item.original_data, // ‡πÄ‡∏≠‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                practical_score: item.practical_score // ‡∏ó‡∏±‡∏ö‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÉ‡∏´‡∏°‡πà
            }));

            // ‡πÉ‡∏ä‡πâ Promise.all ‡∏¢‡∏¥‡∏á update ‡∏ó‡∏µ‡∏•‡∏∞‡∏Ñ‡∏ô (‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏™‡∏∏‡∏î)
            const promises = updates.map(u => window.dataSdk.update(u));

            Promise.all(promises)
                .then(() => {
                    setTimeout(() => {
                        hideLoading();
                        closeModal();
                        showAlert('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
                        window.dataSdk.refresh().then(() => renderAdminDashboard());
                    }, 1500);
                })
                .catch(err => {
                    hideLoading();
                    showAlert('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + err.message);
                });
        });
    }
}
function deleteStudent(id) { showConfirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö', '‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?', () => { showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö...'); window.dataSdk.delete({__backendId: id}).then(res => { setTimeout(() => { hideLoading(); if(res.isOk) showAlert('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏•‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢'); else showAlert('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', res.error.message); }, 500); }); }); }
// --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î Modal ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏• ---
function showInterviewForm(id, maxScore, programName) {
    const s = studentsData.find(x => x.__backendId === id);
    if (!s) return;

    // Helper: ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ñ‡πà‡∏ß‡∏á‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å
    const getSubScore = (score, subject, program) => {
        const val = parseFloat(score) || 0;
        const p = program.toLowerCase();
        if (p.includes('s&m') || p.includes('sme')) {
            if (subject === 'sci') return val * 1.0;
            if (subject === 'math') return val * (40/30);
            if (subject === 'eng') return val * 0.5;
        } else if (p.includes('gate')) {
            if (subject === 'sci') return val * 0.875;
            if (subject === 'math') return val * (35/30);
            if (subject === 'eng') return val * 0.75;
        } else if (p.includes('eis')) {
            if (subject === 'sci') return val * 0.75;
            if (subject === 'math') return val * 1.0;
            if (subject === 'eng') return val * 1.0;
        }
        return val;
    };

    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô Modal
    const w_sci = getSubScore(s.science_score, 'sci', programName);
    const w_math = getSubScore(s.math_score, 'math', programName);
    const w_eng = getSubScore(s.english_score, 'eng', programName);
    
    // ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô (‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞)
    const written = w_sci + w_math + w_eng;
    
    const practical = parseFloat(s.practical_score) || 0;

    const modalHtml = `
    <div id="interview-modal" class="fixed inset-0 flex items-center justify-center z-[150] animate-fade-in px-4">
        
        <style>
            #input-score-modal::-webkit-outer-spin-button,
            #input-score-modal::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
            #input-score-modal { -moz-appearance: textfield; }
        </style>

        <div class="absolute w-full h-full bg-gray-900/60 backdrop-blur-sm transition-opacity" onclick="closeInterviewModal()"></div>
        <div class="bg-white w-full max-w-lg rounded-[2rem] shadow-2xl z-[151] overflow-hidden transform scale-100 transition-all relative">
            
            <div class="bg-gradient-to-r from-lime-400 to-lime-500 p-6 pt-8 pb-10 text-white relative overflow-hidden">
                <div class="absolute top-0 right-0 w-32 h-32 bg-white opacity-10 rounded-full -mr-10 -mt-10"></div>
                <button onclick="closeInterviewModal()" class="absolute top-4 right-4 text-white/80 hover:text-white bg-black/10 hover:bg-black/20 rounded-full p-1 transition-all">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
                <div class="text-center relative z-10">
                    <div class="inline-block px-3 py-1 bg-white/20 rounded-full text-xs font-bold mb-2 border border-white/30">
                        ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ ${programName}
                    </div>
                    <h2 class="text-2xl font-bold mb-1 drop-shadow-md">${s.full_name}</h2>
                    <p class="text-lime-50 font-medium opacity-90">‡∏£‡∏´‡∏±‡∏™‡∏™‡∏≠‡∏ö: <span class="font-mono font-bold text-white text-lg">${s.exam_id}</span></p>
                </div>
            </div>

            <div class="p-6 -mt-6 bg-white rounded-t-[2rem] relative z-20">
                <div class="mb-2 text-xs font-bold text-gray-400 uppercase tracking-wider ml-1">‡∏ú‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô (‡∏Ñ‡∏¥‡∏î‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞)</div>
                <div class="grid grid-cols-3 gap-3 mb-4">
                    <div class="bg-blue-50 p-3 rounded-xl text-center border border-blue-100"><div class="text-xs text-blue-400 font-bold mb-1">‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå</div><div class="text-xl font-black text-blue-600">${w_sci.toFixed(2)}</div></div>
                    <div class="bg-red-50 p-3 rounded-xl text-center border border-red-100"><div class="text-xs text-red-400 font-bold mb-1">‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå</div><div class="text-xl font-black text-red-600">${w_math.toFixed(2)}</div></div>
                    <div class="bg-purple-50 p-3 rounded-xl text-center border border-purple-100"><div class="text-xs text-purple-400 font-bold mb-1">‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©</div><div class="text-xl font-black text-purple-600">${w_eng.toFixed(2)}</div></div>
                </div>

                <div class="bg-gray-50 rounded-xl p-4 border border-gray-200 flex justify-between items-center mb-6 shadow-inner">
                    <span class="text-sm font-bold text-gray-500">‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô (100)</span>
                    <span class="text-3xl font-black text-lime-600">${written.toFixed(2)}</span>
                </div>

                <div class="border-t border-gray-100 my-4"></div>

                <label class="block text-sm font-bold text-lime-700 mb-2 pl-1">
                    ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏≠‡∏ö‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥ <span class="text-gray-400 font-normal">(‡πÄ‡∏ï‡πá‡∏° ${maxScore})</span>
                </label>
                <div class="relative">
                    <input type="number" id="input-score-modal" 
                        class="w-full px-4 py-4 text-center text-3xl font-black text-lime-600 border-2 border-lime-200 rounded-2xl focus:border-lime-500 focus:ring-4 focus:ring-lime-100 outline-none transition-all bg-white"
                        value="${practical > 0 ? practical : ''}" 
                        placeholder="0"
                        min="0" max="${maxScore}" step="0.01"
                        oninput="if(parseFloat(this.value) > ${maxScore}) this.value = ${maxScore}; if(parseFloat(this.value) < 0) this.value = 0;"
                        onkeydown="if(event.key==='Enter') saveSingleInterviewScore('${id}', ${maxScore})"
                    >
                    <div class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 text-sm font-bold">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</div>
                </div>

                <button onclick="saveSingleInterviewScore('${id}', ${maxScore})" 
                    class="w-full mt-6 py-4 btn-primary text-yellow-900 rounded-2xl font-bold shadow-lg shadow-orange-200/50 active:scale-95 transition-all flex justify-center items-center gap-2 text-lg">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                    ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                </button>
            </div>
        </div>
    </div>
    `;

    const div = document.createElement('div');
    div.id = 'temp-interview-modal-wrapper';
    div.innerHTML = modalHtml;
    document.body.appendChild(div);
    
    setTimeout(() => document.getElementById('input-score-modal').focus(), 100);
}
function closeInterviewModal() {
    const el = document.getElementById('temp-interview-modal-wrapper');
    if (el) el.remove();
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (Logic ‡πÄ‡∏î‡∏¥‡∏° ‡πÅ‡∏ï‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ Spinner ‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ò‡∏µ‡∏°)
function saveSingleInterviewScore(id, maxScore) {
    const input = document.getElementById('input-score-modal');
    let score = parseFloat(input.value);
    
    if (isNaN(score)) score = 0;
    if (score < 0) score = 0;
    if (score > maxScore) {
        alert(`‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏Å‡∏¥‡∏ô ${maxScore} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô`);
        return;
    }

    const studentIndex = studentsData.findIndex(s => s.__backendId === id);
    if (studentIndex === -1) return;

    // *** ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏Å‡πâ‡∏≠‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏≤‡∏¢ ***
    const student = studentsData[studentIndex];
    const updateData = {
        ...student,             
        practical_score: score  
    };

    const btn = document.querySelector('#interview-modal button');
    const originalText = btn.innerHTML;
    // Spinner ‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•‡πÄ‡∏Ç‡πâ‡∏° (‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏™‡πâ‡∏°)
    btn.innerHTML = `<svg class="animate-spin h-5 w-5 text-yellow-900" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...`;
    btn.disabled = true;

    window.dataSdk.update(updateData).then(res => {
        if (res.isOk) {
            studentsData[studentIndex].practical_score = score;
            closeInterviewModal();
            renderAdminDashboard();
        } else {
            alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + res.error.message);
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    });
}

function closeInterviewModal() {
    const el = document.getElementById('temp-interview-modal-wrapper');
    if (el) el.remove();
}

function saveSingleInterviewScore(id, maxScore) {
    const input = document.getElementById('input-score-modal');
    let score = parseFloat(input.value);
    
    if (isNaN(score)) score = 0;
    if (score < 0) score = 0;
    if (score > maxScore) {
        alert(`‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏Å‡∏¥‡∏ô ${maxScore} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô`);
        return;
    }

    const studentIndex = studentsData.findIndex(s => s.__backendId === id);
    if (studentIndex === -1) return;

    // 1. ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏ï‡πâ‡∏≠‡∏á‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏ó‡∏±‡πâ‡∏á‡∏Å‡πâ‡∏≠‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏≤‡∏¢)
    const student = studentsData[studentIndex];
    const updateData = {
        ...student,             // Copy ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏ä‡∏∑‡πà‡∏≠, ‡∏£‡∏´‡∏±‡∏™, ‡πÄ‡∏Å‡∏£‡∏î ‡∏Ø‡∏•‡∏Ø)
        practical_score: score  // ‡∏ó‡∏±‡∏ö‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÉ‡∏´‡∏°‡πà
    };

    // 2. ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏µ‡πà‡∏õ‡∏∏‡πà‡∏°
    const btn = document.querySelector('#interview-modal button');
    const originalText = btn.innerHTML;
    btn.innerHTML = `<svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...`;
    btn.disabled = true;

    // 3. ‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
    window.dataSdk.update(updateData).then(res => {
        if (res.isOk) {
            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô Local State
            studentsData[studentIndex].practical_score = score;
            
            // ‡∏õ‡∏¥‡∏î Modal
            closeInterviewModal();
            
            // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏´‡∏•‡∏±‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÉ‡∏´‡∏°‡πà
            renderAdminDashboard();
            
            // ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏•‡πá‡∏Å‡πÜ (Optional)
            // showAlert('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢'); 
        } else {
            alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + res.error.message);
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    });
}
// --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Export Excel ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ú‡∏•/‡∏à‡∏±‡∏î‡∏•‡∏≥‡∏î‡∏±‡∏ö ---
function exportRankingToExcel() {
    const m1 = studentsData.filter(s => ['p4','p5','p6','m1'].includes(s.grade_level));
    const m4 = studentsData.filter(s => ['m3','m4'].includes(s.grade_level));
    let activeData = adminTab === 'm1' ? m1 : m4;

    let isFilteredMode = false;
    let isPretestMode = rankingTab.startsWith('pretest');

    if (rankingTab === 'filtered') {
        if (adminTab === 'm1') activeData = activeData.filter(s => !['p4', 'p5'].includes(s.grade_level));
        isFilteredMode = true;
    } else if (isPretestMode) {
        if (rankingTab === 'pretest') activeData = activeData.filter(s => ['p4', 'p5'].includes(s.grade_level));
        else if (rankingTab === 'pretest_p4') activeData = activeData.filter(s => s.grade_level === 'p4');
        else if (rankingTab === 'pretest_p5') activeData = activeData.filter(s => s.grade_level === 'p5');
        else if (rankingTab === 'pretest_p6') activeData = activeData.filter(s => s.grade_level === 'p6');
    }

    const allocationResult = executeClearingHouse(activeData, quotas[adminTab]);
    let dataList = [];
    let fileName = "";

    // Helper: ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏ï‡∏¥‡∏î‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤‡πÑ‡∏´‡∏°
    const gotHigherChoice = (student, currentProgram) => {
        const result = allocationResult[student.__backendId];
        if (!result) return false;
        if (result.program === currentProgram) return false;
        
        let winPriority = 99;
        if (student.choice_1 === result.program) winPriority = 1;
        else if (student.choice_2 === result.program) winPriority = 2;
        else if (student.choice_3 === result.program) winPriority = 3;

        let currentPriority = 99;
        if (student.choice_1 === currentProgram) currentPriority = 1;
        else if (student.choice_2 === currentProgram) currentPriority = 2;
        else if (student.choice_3 === currentProgram) currentPriority = 3;

        return winPriority < currentPriority;
    };

    if (rankingTab === 'all' || isFilteredMode || isPretestMode) {
        // Mode: Raw Data
        dataList = [...activeData].sort((a,b) => b.total_score - a.total_score).map((s, i) => ({
            ...s, 
            score_to_show: s.total_score,
            raw_sci: parseFloat(s.science_score)||0,
            raw_math: parseFloat(s.math_score)||0,
            raw_eng: parseFloat(s.english_score)||0,
            status_text: allocationResult[s.__backendId] ? `‡∏ï‡∏¥‡∏î ${allocationResult[s.__backendId].program}` : '‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå'
        }));
        
        let suffix = "RawData";
        if(isFilteredMode) suffix = "‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡∏±‡∏î‡∏Å‡∏£‡∏≠‡∏á";
        if(rankingTab === 'pretest') suffix = "Pre-test(‡∏£‡∏ß‡∏°)";
        if(rankingTab === 'pretest_p4') suffix = "Pre-test(‡∏õ.4)";
        if(rankingTab === 'pretest_p5') suffix = "Pre-test(‡∏õ.5)";
        if(rankingTab === 'pretest_p6') suffix = "Pre-test(‡∏õ.6)";
        fileName = `‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ú‡∏•_${adminTab}_${suffix}.xlsx`;

    } else {
        // Mode: ‡πÅ‡∏¢‡∏Å‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ (‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÉ‡∏´‡∏°‡πà)
        const targetProgram = { 'sm': 'S&M', 'gate': 'GATE', 'eis': 'EIS', 'sme': 'SME' }[rankingTab];
        
        // 1. ‡∏Å‡∏£‡∏≠‡∏á‡∏Ñ‡∏ô
        dataList = activeData.filter(s => {
            const choseThis = (s.choice_1 === targetProgram || s.choice_2 === targetProgram || s.choice_3 === targetProgram);
            if (!choseThis) return false;
            // ‡∏ï‡∏±‡∏î‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏î‡∏µ‡∏Å‡∏ß‡πà‡∏≤‡∏≠‡∏≠‡∏Å
            if (gotHigherChoice(s, targetProgram)) return false;
            return true;
        });

        // 2. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
        dataList = dataList.map(s => {
            const result = allocationResult[s.__backendId];
            const isPass = result && result.program === targetProgram;
            return {
                ...s, 
                score_to_show: getWeightedScore(s, targetProgram), // ‡πÉ‡∏ä‡πâ‡∏™‡∏π‡∏ï‡∏£‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ
                is_pass: isPass,
                status_text: isPass ? '‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£' : '‡∏™‡∏≥‡∏£‡∏≠‡∏á'
            };
        });

        // 3. ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
        dataList.sort((a, b) => b.score_to_show - a.score_to_show);
        
        fileName = `‡πÉ‡∏ö‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠_${adminTab}_${targetProgram}.xlsx`;
    }

    if (dataList.length === 0) return showAlert('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');

    // ‡∏£‡∏±‡∏ô‡πÄ‡∏•‡∏Ç
    let currentRank = 1;
    for (let i = 0; i < dataList.length; i++) {
        if (i > 0) {
            const scoreSame = Math.abs(dataList[i].score_to_show - dataList[i-1].score_to_show) < 0.00001;
            if (scoreSame) dataList[i].rank = dataList[i-1].rank;
            else { currentRank++; dataList[i].rank = currentRank; }
        } else { dataList[i].rank = 1; }
    }

    let excelRows = [];
    if (isPretestMode) {
        excelRows = dataList.map(s => ({
            '‡∏•‡∏≥‡∏î‡∏±‡∏ö': s.rank, '‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏™‡∏≠‡∏ö': s.exam_id, '‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•': s.full_name, '‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô': s.previous_school,
            '‡∏ß‡∏¥‡∏ó‡∏¢‡πå': s.raw_sci, '‡∏Ñ‡∏ì‡∏¥‡∏ï': s.raw_math, '‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©': s.raw_eng, '‡∏£‡∏ß‡∏°': s.score_to_show.toFixed(2)
        }));
    } else {
        excelRows = dataList.map(s => ({
            '‡∏•‡∏≥‡∏î‡∏±‡∏ö': s.rank, '‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏™‡∏≠‡∏ö': s.exam_id, '‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•': s.full_name, '‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô': s.previous_school, '‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏': ''
        }));
    }

    const ws = XLSX.utils.json_to_sheet(excelRows);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, isPretestMode ? "ScoreSheet" : "SignatureSheet");
    XLSX.writeFile(wb, fileName);
}
window.addEventListener('load', () => { window.dataSdk.init(dataHandler); render(); });
// --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏¢‡πà‡∏≠‡∏¢ 3: ‡∏´‡∏ô‡πâ‡∏≤‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥/‡∏™‡∏±‡∏°‡∏†‡∏≤‡∏©‡∏ì‡πå (‡∏â‡∏ö‡∏±‡∏ö‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á: ‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏° + ‡πÇ‡∏ä‡∏ß‡πå‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏î‡∏¥‡∏ö + ‡πÅ‡∏Å‡πâ‡∏ö‡∏±‡πä‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏≤‡∏¢) ---
// --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏¢‡πà‡∏≠‡∏¢ 3: ‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏™‡∏≠‡∏ö‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥ (‡∏ò‡∏µ‡∏°‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß/‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏•‡∏±‡∏Å) ---
function filterInterviewTable() {
    const input = document.getElementById('interview-search');
    const filter = input.value.toLowerCase().trim();
    const rows = document.querySelectorAll('.interview-row'); // ‡πÅ‡∏ñ‡∏ß‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á

    rows.forEach(row => {
        const name = row.getAttribute('data-name').toLowerCase();
        const id = row.getAttribute('data-id').toLowerCase();
        
        // ‡∏ñ‡πâ‡∏≤‡∏ä‡∏∑‡πà‡∏≠ ‡∏´‡∏£‡∏∑‡∏≠ ‡∏£‡∏´‡∏±‡∏™ ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á
        if (name.includes(filter) || id.includes(filter)) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}
function renderInterviewView(allStudents) {
    const allocationResult = executeClearingHouse(allStudents, quotas[adminTab]);
    
    const availablePrograms = adminTab === 'm1' ? ['sm', 'gate', 'eis'] : ['sme', 'gate'];
    if (rankingTab === 'all' || rankingTab === 'filtered' || !availablePrograms.includes(rankingTab)) {
        rankingTab = availablePrograms[0];
    }

    const targetProgramName = { 'sm': 'S&M', 'gate': 'GATE', 'eis': 'EIS', 'sme': 'SME' }[rankingTab];
    const practicalQuota = 40; 
    const maxPractical = (targetProgramName === 'S&M') ? 20 : 100;
    const maxTotal = 100 + maxPractical;
    
    const getSubScore = (score, subject, program) => {
        const s = parseFloat(score) || 0;
        const p = program.toLowerCase();
        if (p.includes('s&m') || p.includes('sme')) {
            if (subject === 'sci') return s * 1.0;
            if (subject === 'math') return s * (40/30);
            if (subject === 'eng') return s * 0.5;
        } else if (p.includes('gate')) {
            if (subject === 'sci') return s * 0.875;
            if (subject === 'math') return s * (35/30);
            if (subject === 'eng') return s * 0.75;
        } else if (p.includes('eis')) {
            if (subject === 'sci') return s * 0.75;
            if (subject === 'math') return s * 1.0;
            if (subject === 'eng') return s * 1.0;
        }
        return s;
    };

    let interviewList = allStudents.filter(s => {
        const id = s.__backendId;
        if (interviewOverrides[id]) {
            if (interviewOverrides[id] === targetProgramName) return true;
            return false;
        }
        const result = allocationResult[id];
        return result && result.program === targetProgramName;
    });

    interviewList = interviewList.map(s => {
        const w_sci = getSubScore(s.science_score, 'sci', targetProgramName);
        const w_math = getSubScore(s.math_score, 'math', targetProgramName);
        const w_eng = getSubScore(s.english_score, 'eng', targetProgramName);
        const written = w_sci + w_math + w_eng;
        const practical = parseFloat(s.practical_score) || 0;
        return { 
            ...s, w_sci, w_math, w_eng, 
            written_score: written,
            practical_score: practical, 
            grand_total: written + practical,
            is_manual: !!interviewOverrides[s.__backendId]
        };
    }).sort((a, b) => b.grand_total - a.grand_total);

    let currentRank = 1;
    for (let i = 0; i < interviewList.length; i++) {
        if (i > 0) {
            if (Math.abs(interviewList[i].grand_total - interviewList[i-1].grand_total) < 0.00001) {
                interviewList[i].final_rank = interviewList[i-1].final_rank;
            } else {
                currentRank = i + 1;
                interviewList[i].final_rank = currentRank;
            }
        } else {
            interviewList[i].final_rank = 1;
        }

        if (interviewList[i].final_rank <= practicalQuota) {
            interviewList[i].final_status = '‡∏ï‡∏±‡∏ß‡∏à‡∏£‡∏¥‡∏á';
            interviewList[i].is_pass = true;
        } else {
            const reserveRank = interviewList[i].final_rank - practicalQuota;
            interviewList[i].final_status = `‡∏™‡∏≥‡∏£‡∏≠‡∏á ${reserveRank}`;
            interviewList[i].is_pass = false;
        }
    }

    const tabs = adminTab === 'm1' 
        ? [{ id: 'sm', label: 'S&M' }, { id: 'gate', label: 'GATE' }, { id: 'eis', label: 'EIS' }]
        : [{ id: 'sme', label: 'SME' }, { id: 'gate', label: 'GATE' }];

    return `
    <div class="mb-6 flex flex-col md:flex-row justify-between items-start md:items-end gap-4">
        <div>
            <h1 class="text-2xl md:text-3xl font-bold text-gray-800 mb-2">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥ ${adminTab==='m1'?'‡∏°.1':'‡∏°.4'}</h1>
            <p class="text-sm text-gray-500">‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ <span class="font-bold text-lime-600">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°/‡∏•‡∏ö ‡∏´‡∏•‡∏≤‡∏¢‡∏Ñ‡∏ô</span> ‡πÑ‡∏î‡πâ ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</p>
            <div class="flex flex-wrap gap-2 mt-2">
                ${tabs.map(t => `<button onclick="rankingTab='${t.id}';interviewCheckedIds.clear();renderAdminDashboard();" class="px-5 py-2.5 rounded-xl text-sm font-bold transition-all border shadow-sm ${rankingTab===t.id ? 'bg-lime-500 text-white border-lime-500 shadow-lg shadow-lime-200' : 'bg-white text-gray-500 border-gray-200 hover:bg-gray-50'}">${t.label}</button>`).join('')}
            </div>
        </div>
        
        <div class="flex flex-col md:flex-row gap-3 items-end">
            <button onclick="deleteSelectedInterviews()" id="btn-bulk-delete" class="hidden flex items-center gap-2 px-4 py-3 bg-red-500 hover:bg-red-600 text-white rounded-xl font-bold shadow-lg shadow-red-200 transition-all active:scale-95 text-xs md:text-sm">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                ‡∏•‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
            </button>

            <button onclick="showAddStudentModal('${targetProgramName}')" class="flex items-center gap-2 px-4 py-3 bg-amber-500 hover:bg-amber-600 text-white rounded-xl font-bold shadow-lg shadow-amber-200 transition-all active:scale-95 text-xs md:text-sm">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠
            </button>

            <div class="relative">
                <input type="text" id="interview-search" onkeyup="filterInterviewTable()" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á..." class="pl-9 pr-4 py-3 rounded-xl border border-gray-200 text-sm focus:ring-2 focus:ring-lime-500 outline-none shadow-sm w-full md:w-48">
                <svg class="w-4 h-4 text-gray-400 absolute left-3 top-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
            </div>

            <div class="flex gap-2">
                <button onclick="exportInterviewToExcel()" class="flex items-center gap-2 px-3 py-3 bg-green-600 hover:bg-green-700 text-white rounded-xl font-bold shadow-lg shadow-green-200 transition-all active:scale-95 text-xs md:text-sm">Excel</button>
                <button onclick="exportInterviewToWord()" class="flex items-center gap-2 px-3 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-xl font-bold shadow-lg shadow-blue-200 transition-all active:scale-95 text-xs md:text-sm">Word</button>
            </div>
        </div>
    </div>

    <div class="bg-white rounded-[2rem] shadow-sm border border-gray-100 overflow-hidden">
        <div class="p-6 bg-lime-50/50 border-b border-lime-100 flex justify-between items-center">
            <div>
                <h3 class="font-bold text-lime-800 text-lg flex items-center gap-2"><span class="w-2 h-6 bg-lime-500 rounded-full inline-block"></span> ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ ${targetProgramName}</h3>
                <p class="text-xs text-lime-600 mt-1 pl-4">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏ï‡πá‡∏°: ‡∏Ç‡πâ‡∏≠‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô (100) + ‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥ (${maxPractical}) = ${maxTotal} | ‡∏ï‡∏±‡∏ß‡∏à‡∏£‡∏¥‡∏á: ${practicalQuota} ‡∏Ñ‡∏ô</p>
            </div>
            <div class="text-sm font-bold text-gray-500 bg-white px-4 py-2 rounded-xl shadow-sm">‡∏ú‡∏π‡πâ‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏™‡∏≠‡∏ö: <span class="text-lime-600 text-lg">${interviewList.length}</span> ‡∏Ñ‡∏ô</div>
        </div>
        
        <div class="overflow-x-auto">
            <table class="w-full text-left border-collapse">
                <thead>
                    <tr class="bg-gray-50 text-gray-500 text-xs uppercase font-bold tracking-wider">
                        <th class="px-4 py-4 w-10 text-center border-b border-gray-100">
                            <input type="checkbox" id="select-all-interviews" onclick="toggleSelectAllInterviews(this)" 
                                class="w-4 h-4 rounded border-gray-300 text-red-500 focus:ring-red-500 cursor-pointer">
                        </th>
                        <th class="px-2 py-4 w-12 text-center border-b border-gray-100">‡∏ó‡∏µ‡πà</th>
                        <th class="px-4 py-4 border-b border-gray-100">‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≠‡∏ö</th>
                        <th class="px-2 py-4 text-center border-b border-gray-100 text-blue-500">‡∏ß‡∏¥‡∏ó‡∏¢‡πå<br><span class="text-[10px] opacity-70">(Weight)</span></th>
                        <th class="px-2 py-4 text-center border-b border-gray-100 text-red-500">‡∏Ñ‡∏ì‡∏¥‡∏ï<br><span class="text-[10px] opacity-70">(Weight)</span></th>
                        <th class="px-2 py-4 text-center border-b border-gray-100 text-purple-500">‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©<br><span class="text-[10px] opacity-70">(Weight)</span></th>
                        <th class="px-2 py-4 text-center border-b border-gray-100 bg-gray-50">‡∏Ç‡πâ‡∏≠‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô<br>(100)</th>
                        <th class="px-2 py-4 text-center border-b border-lime-100 bg-lime-50 text-lime-700">‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥<br>(${maxPractical})</th>
                        <th class="px-2 py-4 text-center border-b border-gray-100">‡∏£‡∏ß‡∏°<br>(${maxTotal})</th>
                        <th class="px-2 py-4 text-center border-b border-gray-100">‡∏ú‡∏•</th>
                        <th class="px-4 py-4 text-center border-b border-gray-100">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-50 text-sm">
                    ${interviewList.length > 0 ? interviewList.map((s, i) => `
                    <tr class="hover:bg-lime-50/30 transition-colors group interview-row ${s.is_manual ? 'bg-yellow-50' : ''}" data-name="${s.full_name}" data-id="${s.exam_id}">
                        <td class="px-4 py-4 text-center">
                            <input type="checkbox" class="w-4 h-4 rounded border-gray-300 text-red-500 focus:ring-red-500 interview-checkbox cursor-pointer" 
                                data-id="${s.__backendId}" 
                                onclick="toggleInterviewCheck('${s.__backendId}')"
                                ${interviewCheckedIds.has(s.__backendId) ? 'checked' : ''}>
                        </td>
                        <td class="px-2 py-4 text-center font-bold text-gray-400 group-hover:text-lime-600">#${s.final_rank}</td>
                        <td class="px-4 py-4">
                            <div class="font-bold text-gray-800 flex items-center gap-2">
                                ${s.full_name}
                                ${s.is_manual ? '<span class="text-[10px] bg-yellow-100 text-yellow-600 px-1.5 py-0.5 rounded border border-yellow-200">‡πÄ‡∏û‡∏¥‡πà‡∏°</span>' : ''}
                            </div>
                            <div class="text-xs text-gray-400 font-mono mt-0.5">${s.exam_id}</div>
                        </td>
                        <td class="px-2 py-4 text-center font-medium text-gray-500">${s.w_sci.toFixed(2)}</td>
                        <td class="px-2 py-4 text-center font-medium text-gray-500">${s.w_math.toFixed(2)}</td>
                        <td class="px-2 py-4 text-center font-medium text-gray-500">${s.w_eng.toFixed(2)}</td>
                        <td class="px-2 py-4 text-center font-bold text-gray-700 bg-gray-50 group-hover:bg-lime-50/20">${s.written_score.toFixed(2)}</td>
                        <td class="px-2 py-4 text-center font-bold text-lime-700 bg-lime-50/20">${s.practical_score > 0 ? s.practical_score.toFixed(2) : '-'}</td>
                        <td class="px-2 py-4 text-center font-black text-gray-800">${s.grand_total.toFixed(2)}</td>
                        <td class="px-2 py-4 text-center">
                            ${s.is_pass 
                                ? `<span class="inline-block px-2 py-1 rounded-full bg-green-100 text-green-700 font-bold text-[10px] shadow-sm whitespace-nowrap">‡∏ï‡∏±‡∏ß‡∏à‡∏£‡∏¥‡∏á</span>` 
                                : `<span class="inline-block px-2 py-1 rounded-full bg-orange-100 text-orange-700 font-bold text-[10px] shadow-sm whitespace-nowrap">${s.final_status}</span>`
                            }
                        </td>
                        <td class="px-4 py-4 text-center">
                            <div class="flex justify-center gap-1">
                                <button onclick="showInterviewForm('${s.__backendId}', ${maxPractical}, '${targetProgramName}')" class="p-2 bg-lime-100 hover:bg-lime-200 text-lime-700 rounded-lg shadow-sm" title="‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                                </button>
                                <button onclick="removeStudentFromProject('${s.__backendId}')" class="p-2 bg-red-50 hover:bg-red-100 text-red-500 rounded-lg shadow-sm" title="‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                </button>
                            </div>
                        </td>
                    </tr>`).join('') : `<tr><td colspan="11" class="text-center py-12 text-gray-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>`}
                </tbody>
            </table>
        </div>
    </div>
    <div id="interview-modal-container"></div>
    `;
}
// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥ (‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡∏ô‡∏ó‡∏µ)
function updatePracticalScore(id, value, max) {
    let score = parseFloat(value);
    if (isNaN(score)) score = 0;
    if (score < 0) score = 0;
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡πà‡∏≤‡πÄ‡∏Å‡∏¥‡∏ô
    if (score > max) {
        alert(`‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏Å‡∏¥‡∏ô ${max} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô`);
        // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô input ‡πÉ‡∏´‡πâ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤ max (‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏≤ element ‡πÉ‡∏´‡πâ‡πÄ‡∏à‡∏≠ ‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏•‡πà‡∏≠‡∏¢‡πÉ‡∏´‡πâ render ‡πÉ‡∏´‡∏°‡πà‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£)
        score = max;
    }

    const studentIndex = studentsData.findIndex(s => s.__backendId === id);
    if (studentIndex !== -1) {
        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô RAM
        studentsData[studentIndex].practical_score = score;
        
        // ‡∏™‡∏±‡πà‡∏á‡∏ß‡∏≤‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏∞‡∏Ç‡∏¢‡∏±‡∏ö‡∏Ç‡∏∂‡πâ‡∏ô‡∏•‡∏á‡∏ï‡∏≤‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÉ‡∏´‡∏°‡πà)
        renderAdminDashboard(); 
        
        // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏µ‡πà Google Sheets (Backend)
        window.dataSdk.update({ 
            __backendId: id, 
            practical_score: score 
        }).then(res => {
            if(!res.isOk) console.error('Auto-save failed:', res.error);
        });
    }
}
// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥ (‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏™‡∏£‡πá‡∏à)
function updatePracticalScore(id, value, max) {
    let score = parseFloat(value);
    if (isNaN(score)) score = 0;
    if (score < 0) score = 0;
    if (score > max) {
        alert(`‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏Å‡∏¥‡∏ô ${max} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö`);
        score = max;
    }

    // 1. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏Ç‡∏¢‡∏±‡∏ö‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÄ‡∏•‡∏¢)
    const studentIndex = studentsData.findIndex(s => s.__backendId === id);
    if (studentIndex !== -1) {
        studentsData[studentIndex].practical_score = score;
        
        // ‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡πâ‡∏ß‡∏≤‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÉ‡∏´‡∏°‡πà (Re-render) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏¢‡∏≠‡∏∞‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ‡∏Ç‡πâ‡∏≤‡∏á‡∏ö‡∏ô
        renderAdminDashboard(); 
        
        // 2. ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡πÄ‡∏Å‡πá‡∏ö‡∏ó‡∏µ‡πà Server (Google Sheets)
        window.dataSdk.update({ 
            __backendId: id, 
            practical_score: score 
        }).then(res => {
            if(!res.isOk) console.error('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:', res.error);
        });
    }
}
    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡∏û‡∏¥‡∏°‡∏û‡πå (Frontend Only) ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà
function calculateRow(input, maxTotal, maxScore) {
    let val = parseFloat(input.value);
    
    // ‡∏ñ‡πâ‡∏≤‡∏•‡∏ö‡∏à‡∏ô‡∏ß‡πà‡∏≤‡∏á ‡πÉ‡∏´‡πâ‡∏ñ‡∏∑‡∏≠‡πÄ‡∏õ‡πá‡∏ô 0
    if (input.value === '') {
        val = 0;
    }

    if (isNaN(val)) val = 0;
    if (val < 0) {
        val = 0;
        input.value = 0;
    }

    // *** ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡πà‡∏≤‡πÄ‡∏Å‡∏¥‡∏ô (Logic ‡πÉ‡∏´‡∏°‡πà) ***
    if (val > maxScore) {
        // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á Alert ‡πÉ‡∏´‡πâ‡∏£‡∏≥‡∏Ñ‡∏≤‡∏ç‡πÉ‡∏à ‡πÅ‡∏ï‡πà‡πÅ‡∏Å‡πâ‡∏Ñ‡πà‡∏≤‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô Max ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
        val = maxScore;
        input.value = maxScore; 
    }

    const row = input.closest('tr');
    // ‡∏î‡∏∂‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ç‡πâ‡∏≠‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏à‡∏≤‡∏Å attribute data-written ‡∏ó‡∏µ‡πà‡∏ù‡∏±‡∏á‡πÑ‡∏ß‡πâ (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≤‡∏Å cell)
    // ‡πÅ‡∏ï‡πà‡πÉ‡∏ô renderInterviewView ‡πÄ‡∏£‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ù‡∏±‡∏á data-written ‡πÑ‡∏ß‡πâ‡πÉ‡∏ô <td> 
    // ‡∏î‡∏±‡∏á‡∏ô‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å cell ‡∏ó‡∏µ‡πà 5 (‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô)
    // ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥ ‡∏ú‡∏°‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ data-written ‡πÉ‡∏ô tr ‡∏ó‡∏µ‡πà‡∏ú‡∏°‡πÉ‡∏™‡πà‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤
    // ‡∏´‡∏£‡∏∑‡∏≠‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å innerText ‡∏Ç‡∏≠‡∏á cell ‡∏Å‡πá‡πÑ‡∏î‡πâ
    
    // ‡∏ß‡∏¥‡∏ò‡∏µ‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å Cell ‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô (Column index 5 - ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏ö‡∏à‡∏≤‡∏Å 0)
    const cells = row.getElementsByTagName('td');
    const writtenText = cells[5].innerText; // ‡∏ä‡πà‡∏≠‡∏á‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô
    const written = parseFloat(writtenText) || 0;
    
    const total = written + val;

    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏£‡∏ß‡∏°‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    // ‡∏ä‡πà‡∏≠‡∏á‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥‡∏Ñ‡∏∑‡∏≠ cells[7]
    if(cells[7]) cells[7].textContent = total.toFixed(2);
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß)
function savePracticalScores() {
    const inputs = document.querySelectorAll('.input-practical');
    const updates = [];
    
    // 1. ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ó‡∏∏‡∏Å‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏Å
    inputs.forEach(input => {
        const row = input.closest('tr');
        const id = row.dataset.id; // Backend ID
        let score = parseFloat(input.value);
        
        // Validation: ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç ‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡∏¥‡∏î‡∏•‡∏ö ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô 0
        if (isNaN(score)) score = 0;
        if (score < 0) score = 0;

        // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏ô‡∏ô‡∏±‡πâ‡∏ô‡∏à‡∏≤‡∏Å Memory (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô)
        const originalStudent = studentsData.find(s => s.__backendId === id);
        
        if (originalStudent) {
            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏•‡∏á‡πÉ‡∏ô Memory
            originalStudent.practical_score = score;

            // *** ‡∏à‡∏∏‡∏î‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ***
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á Object ‡πÉ‡∏´‡∏°‡πà‡πÇ‡∏î‡∏¢‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (...) ‡πÅ‡∏•‡πâ‡∏ß‡∏ó‡∏±‡∏ö‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÉ‡∏´‡∏°‡πà
            // ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ Exam_ID, Name, Grade ‡∏Ø‡∏•‡∏Ø ‡∏ï‡∏¥‡∏î‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢ ‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô undefined
            const payload = {
                ...originalStudent,      // Copy ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (Exam ID, Name, etc.)
                practical_score: score   // ‡πÄ‡∏≠‡∏≤‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡∏ö‡∏•‡∏á‡πÑ‡∏õ
            };

            updates.push(payload);
        }
    });

    if (updates.length === 0) {
        showAlert('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å');
        return;
    }

    // 2. ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ Google Apps Script (Batch Update)
    showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô... (‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà)');
    
    // ‡πÉ‡∏ä‡πâ Promise.all ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏¥‡∏á Update ‡∏ó‡∏µ‡∏•‡∏∞‡∏Ñ‡∏ô (‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Google Apps Script ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ)
    const promises = updates.map(u => window.dataSdk.update(u));

    Promise.all(promises)
        .then(() => {
            setTimeout(() => {
                hideLoading();
                showAlert('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏≠‡∏ö‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
                // ‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
                window.dataSdk.refresh().then(() => {
                    renderAdminDashboard();
                });
            }, 1500);
        })
        .catch(err => {
            hideLoading();
            showAlert('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å: ' + err.message);
            console.error(err);
        });
}
    // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡πÄ‡∏õ‡πá‡∏ô Word (‡πÅ‡∏ö‡∏ö‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î) ---
function exportInterviewToExcel() {
    // 1. ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠)
    const m1 = studentsData.filter(s => ['p4','p5','p6','m1'].includes(s.grade_level));
    const m4 = studentsData.filter(s => ['m3','m4'].includes(s.grade_level));
    let activeData = adminTab === 'm1' ? m1 : m4;

    const availablePrograms = adminTab === 'm1' ? ['sm', 'gate', 'eis'] : ['sme', 'gate'];
    if (rankingTab === 'all' || rankingTab === 'filtered' || !availablePrograms.includes(rankingTab)) {
        rankingTab = availablePrograms[0];
    }

    const allocationResult = executeClearingHouse(activeData, quotas[adminTab]);
    const targetProgramName = { 'sm': 'S&M', 'gate': 'GATE', 'eis': 'EIS', 'sme': 'SME' }[rankingTab];
    
    const practicalQuota = 40; 
    const maxPractical = (targetProgramName === 'S&M') ? 20 : 100;
    const maxTotal = 100 + maxPractical;

    // Helper ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Weight
    const getSubScore = (score, subject, program) => {
        const s = parseFloat(score) || 0;
        const p = program.toLowerCase();
        if (p.includes('s&m') || p.includes('sme')) {
            if (subject === 'sci') return s * 1.0;
            if (subject === 'math') return s * (40/30);
            if (subject === 'eng') return s * 0.5;
        } else if (p.includes('gate')) {
            if (subject === 'sci') return s * 0.875;
            if (subject === 'math') return s * (35/30);
            if (subject === 'eng') return s * 0.75;
        } else if (p.includes('eis')) {
            if (subject === 'sci') return s * 0.75;
            if (subject === 'math') return s * 1.0;
            if (subject === 'eng') return s * 1.0;
        }
        return s;
    };

    // 2. ‡∏Å‡∏£‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ (‡πÉ‡∏ä‡πâ Logic Overrides)
    let interviewList = activeData.filter(s => {
        const id = s.__backendId;
        if (interviewOverrides[id]) {
            if (interviewOverrides[id] === targetProgramName) return true;
            return false;
        }
        const result = allocationResult[id];
        return result && result.program === targetProgramName;
    });

    // 3. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÉ‡∏´‡∏°‡πà
    interviewList = interviewList.map(s => {
        const w_sci = getSubScore(s.science_score, 'sci', targetProgramName);
        const w_math = getSubScore(s.math_score, 'math', targetProgramName);
        const w_eng = getSubScore(s.english_score, 'eng', targetProgramName);
        
        const written = w_sci + w_math + w_eng;
        const practical = parseFloat(s.practical_score) || 0;
        
        return { 
            ...s, w_sci, w_math, w_eng, 
            written_score: written,
            practical_score: practical, 
            grand_total: written + practical
        };
    }).sort((a, b) => b.grand_total - a.grand_total);

    // 4. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
    let currentRank = 1;
    for (let i = 0; i < interviewList.length; i++) {
        if (i > 0) {
            if (Math.abs(interviewList[i].grand_total - interviewList[i-1].grand_total) < 0.00001) {
                interviewList[i].final_rank = interviewList[i-1].final_rank;
            } else {
                currentRank = i + 1;
                interviewList[i].final_rank = currentRank;
            }
        } else {
            interviewList[i].final_rank = 1;
        }

        if (interviewList[i].final_rank <= practicalQuota) {
            interviewList[i].final_status = '‡∏ï‡∏±‡∏ß‡∏à‡∏£‡∏¥‡∏á';
        } else {
            const reserveRank = interviewList[i].final_rank - practicalQuota;
            interviewList[i].final_status = `‡∏™‡∏≥‡∏£‡∏≠‡∏á ${reserveRank}`;
        }
    }

    if(interviewList.length === 0) return showAlert('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');

    // 5. ‡∏™‡∏£‡πâ‡∏≤‡∏á Excel Rows (‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô)
    const excelRows = interviewList.map(s => ({
        '‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà': s.final_rank,
        '‡∏£‡∏´‡∏±‡∏™‡∏™‡∏≠‡∏ö': s.exam_id,
        '‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•': s.full_name,
        '‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô': s.previous_school || '-', // üî• ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡∏Ñ‡∏£‡∏±‡∏ö üî•
        '‡∏ß‡∏¥‡∏ó‡∏¢‡πå (Weight)': s.w_sci.toFixed(2),
        '‡∏Ñ‡∏ì‡∏¥‡∏ï (Weight)': s.w_math.toFixed(2),
        '‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏© (Weight)': s.w_eng.toFixed(2),
        '‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô (100)': s.written_score.toFixed(2),
        [`‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥ (${maxPractical})`]: s.practical_score.toFixed(2),
        [`‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ (${maxTotal})`]: s.grand_total.toFixed(2),
        '‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡∏±‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å': s.final_status
    }));

    const ws = XLSX.utils.json_to_sheet(excelRows);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Scores");
    XLSX.writeFile(wb, `‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏≠‡∏ö‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥_${targetProgramName}_${adminTab}.xlsx`);
}
</script>
</body>
</html>
