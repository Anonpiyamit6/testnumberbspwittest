<!doctype html>
<html lang="th" class="h-full">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ระบบประกาศผลคะแนน</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Sarabun:ital,wght@0,300;0,400;0,500;0,600;0,700;0,800;1,400&display=swap" rel="stylesheet">

<style>
    /* Global Styles & Fonts */
    * { font-family: 'Sarabun', sans-serif !important; }
    body, html, input, textarea, select, button, table, th, td, span, div, p, h1, h2, h3, h4, h5, h6 { font-family: 'Sarabun', sans-serif !important; }
    input[type="number"], input[type="text"] { font-variant-numeric: tabular-nums; }
    
    /* Custom UI Classes from Part 1 */
    body { box-sizing: border-box; background-color: #f0fdf4; color: #4b5563; -webkit-tap-highlight-color: transparent; }
    .gradient-bg { background-color: #C6E686; } 
    .btn-primary { background: linear-gradient(135deg, #fcd34d 0%, #fbbf24 100%); color: #78350f; transition: all 0.2s ease; cursor: pointer; }
    .btn-primary:active { transform: scale(0.96); }
    .card-hover { background-color: white; transition: all 0.3s ease; border: 1px solid #e5e7eb; }
    .input-field { background-color: #f9fafb; border: 1px solid #e5e7eb; transition: all 0.2s ease; }
    .input-field:focus { background-color: white; border-color: #C6E686; box-shadow: 0 0 0 3px rgba(198, 230, 134, 0.4); outline: none; }
    .sidebar-btn { width: 100%; text-align: left; padding: 12px 16px; margin-bottom: 8px; border-radius: 12px; display: flex; align-items: center; gap: 12px; color: #4b5563; background: transparent; border: none; cursor: pointer; min-height: 48px; }
    .sidebar-btn:active { background-color: #ecfdf5; }
    .sidebar-btn.active { background-color: #eefad2; color: #5a7a1a; font-weight: 600; }
    .clickable-name { cursor: pointer; font-weight: 600; color: #65a30d; text-decoration: underline; text-underline-offset: 2px; }
    .modal-overlay { background-color: rgba(255, 255, 255, 0.6); backdrop-filter: blur(8px); }
    #student-modal { transition: opacity 0.2s ease; z-index: 100; } 
    body.modal-active { overflow: hidden !important; }
    #alert-modal, #confirm-modal, #loading-modal { z-index: 200; transition: opacity 0.2s ease; }
    .hidden-force { display: none !important; }
    .tab-btn { border-bottom: 3px solid transparent; color: #9ca3af; padding: 12px 16px; transition: all 0.2s; white-space: nowrap; cursor: pointer; }
    .tab-btn.active { border-bottom: 3px solid #84cc16; color: #4d7c0f; font-weight: bold; background-color: #f7fee7; }

    @media (hover: hover) { 
        .sidebar-btn:hover { background-color: #f7fee7; color: #5a7a1a; } 
        .card-hover:hover { transform: translateY(-3px); box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1); border-color: #C6E686; } 
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(251, 191, 36, 0.4); } 
    }

    /* Print Settings */
    @media print {
        @page { size: A4 portrait; margin: 2cm; }
        body, #app { background-color: white !important; color: black !important; }
        #sidebar, #sidebar-overlay, .no-print, button, input, .shadow-sm, .shadow-lg, .shadow-xl, .rounded-3xl, .rounded-xl { display: none !important; box-shadow: none !important; border: none !important; border-radius: 0 !important; }
        #print-header, .print-footer { display: block !important; }
        .bg-white { background-color: transparent !important; border: none !important; }
        .border-gray-100, .border-b { border: none !important; }
        table { width: 100% !important; border-collapse: collapse !important; border: 1px solid black !important; font-size: 14pt !important; }
        th { border: 1px solid black !important; background-color: transparent !important; color: black !important; text-align: center !important; font-weight: bold !important; padding: 5px !important; }
        td { border: 1px solid black !important; padding: 5px !important; color: black !important; vertical-align: top !important; }
        .rounded-full { background-color: transparent !important; color: black !important; border: none !important; padding: 0 !important; font-weight: normal !important; }
        tr.bg-green-50\/50, tr.hover\:bg-gray-100 { background-color: transparent !important; }
    }
</style>

<script>
// --- API SDK Configuration ---
const API_URL = "https://script.google.com/macros/s/AKfycbzkDOBBuhB-erTc_36OJ3kqVpUE7mh1JpEmSwDfVJMXgpALiLPZ40c470dBODmPQZVOsA/exec";

async function callApi(action, data = {}) {
    const body = JSON.stringify({ action, ...data });
    const response = await fetch(API_URL, {
        method: 'POST', body: body, headers: { "Content-Type": "text/plain;charset=utf-8" } 
    });
    return await response.json();
}

window.dataSdk = {
    init: async (handler) => { window.dataSdkHandler = handler; await window.dataSdk.refresh(); return { isOk: true }; },
    refresh: async () => { 
        try {
            const res = await callApi('getAllStudents');
            if (res.success) { 
                const mappedData = res.students.map(s => ({ ...s, __backendId: s.id })); 
                if (window.dataSdkHandler?.onDataChanged) window.dataSdkHandler.onDataChanged(mappedData); 
                return { isOk: true, data: mappedData }; 
            } 
            return { isOk: false, error: { message: res.message } };
        } catch(e) { return { isOk: false, error: { message: e.message } }; }
    },
    create: async (data) => {
        try { const res = await callApi('createStudent', { data }); if(res.success) { await window.dataSdk.refresh(); return { isOk: true }; } return { isOk: false, error: { message: res.message } }; } catch(e) { return { isOk: false, error: { message: e.message } }; }
    },
    createBulk: async (dataArray) => {
        try { const res = await callApi('createStudentsBulk', { data: dataArray }); if(res.success) { await window.dataSdk.refresh(); return { isOk: true }; } return { isOk: false, error: { message: res.message } }; } catch(e) { return { isOk: false, error: { message: e.message } }; }
    },
    updateScoresBulk: async (dataArray) => {
        try { const res = await callApi('updateScoresBulk', { data: dataArray }); if(res.success) { await window.dataSdk.refresh(); return { isOk: true, message: res.message }; } return { isOk: false, error: { message: res.message } }; } catch(e) { return { isOk: false, error: { message: e.message } }; }
    },
    update: async (data) => {
        try { const updateData = { ...data, id: data.__backendId }; const res = await callApi('updateStudent', { data: updateData }); if(res.success) { await window.dataSdk.refresh(); return { isOk: true }; } return { isOk: false, error: { message: res.message } }; } catch(e) { return { isOk: false, error: { message: e.message } }; }
    },
    delete: async (data) => {
        try { const res = await callApi('deleteStudent', { id: data.__backendId }); if(res.success) { await window.dataSdk.refresh(); return { isOk: true }; } return { isOk: false, error: { message: res.message } }; } catch(e) { return { isOk: false, error: { message: e.message } }; }
    },
    deleteBulk: async (ids) => {
        try { const res = await callApi('deleteStudentsBulk', { ids }); if(res.success) { await window.dataSdk.refresh(); return { isOk: true }; } return { isOk: false, error: { message: res.message } }; } catch(e) { return { isOk: false, error: { message: e.message } }; }
    }
};
</script>
</head>
<body class="h-full">

<!-- Main Application Container -->
<div id="app" class="h-full w-full"></div>

<!-- Student Modal (Add/Edit) - Full Form from Part 1 -->
<div id="student-modal" class="hidden-force fixed inset-0 flex items-center justify-center z-[100]">
    <div class="modal-overlay absolute w-full h-full" onclick="closeModal()"></div>
    <div class="bg-white w-full h-full md:w-11/12 md:h-auto md:max-w-4xl md:max-h-[90vh] md:rounded-[2rem] shadow-2xl z-[101] flex flex-col border border-lime-100 relative transform transition-all">
        
        <div class="flex justify-between items-center px-6 py-4 bg-gradient-to-r from-lime-50 to-white border-b border-lime-100 shrink-0">
            <div class="flex items-center gap-3">
                <div class="p-2 bg-lime-100 rounded-full text-lime-600"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg></div>
                <p class="text-lg md:text-xl font-bold text-lime-800" id="modal-title">จัดการข้อมูล</p>
            </div>
            <button type="button" class="text-gray-400 hover:text-red-500 p-2 rounded-full active:bg-gray-100" onclick="closeModal()"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
        </div>

        <div id="add-mode-tabs" class="flex px-4 border-b border-gray-100 bg-gray-50/50 hidden overflow-x-auto shrink-0">
            <button type="button" onclick="switchAddTab('single')" id="tab-single" class="tab-btn active flex-1 md:flex-none">เพิ่มทีละคน</button>
            <button type="button" onclick="switchAddTab('multiple')" id="tab-multiple" class="tab-btn flex-1 md:flex-none">เพิ่มหลายคน</button>
            <button type="button" onclick="switchAddTab('excel')" id="tab-excel" class="tab-btn flex-1 md:flex-none">Import ชื่อ</button>
            <button type="button" onclick="switchAddTab('score')" id="tab-score" class="tab-btn flex-1 md:flex-none text-purple-600 font-bold">Import คะแนน</button>
            <button type="button" onclick="switchAddTab('practical')" id="tab-practical" class="tab-btn flex-1 md:flex-none text-indigo-600 font-bold">Import ปฏิบัติ</button>
        </div>

        <div class="overflow-y-auto p-4 md:p-8 flex-1 bg-white">
            <!-- View Single -->
            <div id="view-single" class="block pb-20 md:pb-0">
                <form id="student-form" onsubmit="handleSingleSubmit(event)">
                    <input type="hidden" id="student-backend-id">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6 mb-4">
                        <div><label class="block text-gray-500 text-xs font-bold mb-2 uppercase">เลขบัตรประชาชน (13 หลัก)</label><input type="text" id="form-national-id" class="w-full px-4 py-3 rounded-xl border-gray-200 focus:border-lime-400 input-field" placeholder="00xxxxxxxxxxx"></div>
                        <div><label class="block text-gray-500 text-xs font-bold mb-2 uppercase">รหัสประจำตัวสอบ</label><input type="text" id="form-exam-id" class="w-full px-4 py-3 rounded-xl border-gray-200 input-field" required></div>
                        <div><label class="block text-gray-500 text-xs font-bold mb-2 uppercase">ระดับชั้น</label><select id="form-grade" class="w-full px-4 py-3 rounded-xl border-gray-200 input-field bg-white"><option value="p4">ประถมศึกษาปีที่ 4</option><option value="p5">ประถมศึกษาปีที่ 5</option><option value="p6">ประถมศึกษาปีที่ 6</option><option value="m1">มัธยมศึกษาปีที่ 1</option><option value="m3">มัธยมศึกษาปีที่ 3</option><option value="m4">มัธยมศึกษาปีที่ 4</option></select></div>
                        <div><label class="block text-gray-500 text-xs font-bold mb-2 uppercase">ชื่อ-นามสกุล</label><input type="text" id="form-name" class="w-full px-4 py-3 rounded-xl border-gray-200 input-field" required></div>
                        <div class="md:col-span-2"><label class="block text-gray-500 text-xs font-bold mb-2 uppercase">โรงเรียนปัจจุบัน</label><input type="text" id="form-school" class="w-full px-4 py-3 rounded-xl border-gray-200 input-field"></div>
                    </div>

                    <div class="bg-lime-50/50 p-4 rounded-2xl border border-lime-100 mb-4">
                        <h3 class="text-sm font-bold text-lime-700 mb-3 uppercase flex items-center gap-2"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path></svg> ลำดับโครงการที่เลือก</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                            <div><label class="text-[10px] text-gray-500 font-bold uppercase mb-1 block">อันดับ 1</label><select id="form-choice-1" class="w-full px-3 py-2 rounded-lg border-gray-200 text-sm input-field bg-white"><option value="">- ไม่ระบุ -</option><optgroup label="ม.1"><option value="S&M">S&M</option><option value="GATE">GATE</option><option value="EIS">EIS</option></optgroup><optgroup label="ม.4"><option value="SME">SME</option><option value="GATE">GATE</option></optgroup></select></div>
                            <div><label class="text-[10px] text-gray-500 font-bold uppercase mb-1 block">อันดับ 2</label><select id="form-choice-2" class="w-full px-3 py-2 rounded-lg border-gray-200 text-sm input-field bg-white"><option value="">- ไม่ระบุ -</option><optgroup label="ม.1"><option value="S&M">S&M</option><option value="GATE">GATE</option><option value="EIS">EIS</option></optgroup><optgroup label="ม.4"><option value="SME">SME</option><option value="GATE">GATE</option></optgroup></select></div>
                            <div><label class="text-[10px] text-gray-500 font-bold uppercase mb-1 block">อันดับ 3</label><select id="form-choice-3" class="w-full px-3 py-2 rounded-lg border-gray-200 text-sm input-field bg-white"><option value="">- ไม่ระบุ -</option><optgroup label="ม.1"><option value="S&M">S&M</option><option value="GATE">GATE</option><option value="EIS">EIS</option></optgroup><optgroup label="ม.4"><option value="SME">SME</option><option value="GATE">GATE</option></optgroup></select></div>
                        </div>
                    </div>

                    <div id="score-section" class="bg-amber-50/50 p-4 md:p-6 rounded-2xl border border-amber-100">
                        <h3 class="text-sm font-bold text-amber-600 mb-4 uppercase">คะแนนสอบ</h3>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-3 md:gap-4">
                            <div><label class="text-xs text-gray-500 font-semibold">วิทยาศาสตร์ (40)</label><input type="number" step="0.01" id="score-science" class="w-full px-3 py-2 rounded-lg border-gray-200 text-center font-bold text-lime-600 input-field"></div>
                            <div><label class="text-xs text-gray-500 font-semibold">คณิตศาสตร์ (30)</label><input type="number" step="0.01" id="score-math" class="w-full px-3 py-2 rounded-lg border-gray-200 text-center font-bold text-lime-600 input-field"></div>
                            <div><label class="text-xs text-gray-500 font-semibold">ภาษาอังกฤษ (30)</label><input type="number" step="0.01" id="score-english" class="w-full px-3 py-2 rounded-lg border-gray-200 text-center font-bold text-lime-600 input-field"></div>
                        </div>
                    </div>

                    <div class="flex justify-end pt-6 gap-3 md:relative fixed bottom-0 left-0 w-full bg-white p-4 border-t border-gray-100 md:border-0 md:bg-transparent md:p-0 z-10">
                        <button type="button" onclick="closeModal()" class="flex-1 md:flex-none px-6 py-3 bg-gray-100 text-gray-600 rounded-xl font-bold">ยกเลิก</button>
                        <button type="submit" class="flex-1 md:flex-none px-8 py-3 btn-primary rounded-xl font-bold shadow-lg shadow-amber-200/50">บันทึก</button>
                    </div>
                </form>
            </div>

            <!-- View Multiple -->
            <div id="view-multiple" class="hidden h-full flex flex-col">
                <div class="flex-1 overflow-auto border border-gray-100 rounded-xl mb-4 shadow-inner bg-gray-50/50">
                    <table class="w-full text-sm text-left text-gray-500"><thead class="text-xs text-gray-500 uppercase bg-gray-100 sticky top-0"><tr><th class="px-2 py-3">เลขบัตร</th><th class="px-2 py-3">รหัส</th><th class="px-2 py-3">ชื่อ</th><th class="px-2 py-3">ชั้น</th><th class="px-2 py-3">รร.</th><th class="px-1 py-3">ลบ</th></tr></thead><tbody id="multiple-tbody" class="bg-white"></tbody></table>
                </div>
                <div class="flex justify-between items-center bg-white p-2 rounded-lg gap-2">
                    <button type="button" onclick="addMultipleRow()" class="flex-1 text-lime-600 font-bold bg-lime-50 px-3 py-3 rounded-lg">+ เพิ่มแถว</button>
                    <button type="button" onclick="handleMultipleSubmit()" class="flex-1 btn-primary px-3 py-3 rounded-lg font-bold text-yellow-900 shadow-md">บันทึก</button>
                </div>
            </div>

            <!-- View Excel (Student) -->
            <div id="view-excel" class="hidden">
                <div class="border-2 border-dashed border-lime-200 bg-lime-50/30 rounded-2xl p-6 md:p-10 text-center hover:bg-lime-50 transition-colors cursor-pointer" onclick="document.getElementById('excel-upload-name').click()">
                    <span class="block text-lg font-bold text-lime-700">เลือกไฟล์ Excel (รายชื่อ)</span>
                    <input id="excel-upload-name" type="file" class="hidden" accept=".xlsx, .xls" onchange="handleExcelUpload(this, 'student')">
                </div>
                <div id="excel-preview-area" class="mt-6 hidden">
                    <div class="flex justify-between items-center mb-3"><h4 class="font-bold text-gray-700 text-sm">ข้อมูล (<span id="excel-count">0</span> คน)</h4><button type="button" onclick="confirmExcelImport('student')" class="px-4 py-2 btn-primary rounded-lg font-bold text-sm shadow-md">ยืนยัน</button></div>
                    <div class="overflow-auto max-h-48 border border-gray-200 rounded-xl text-xs bg-white"><table class="w-full text-left" id="excel-preview-table"></table></div>
                </div>
            </div>

            <!-- View Excel (Score) -->
            <div id="view-score" class="hidden">
                <div class="border-2 border-dashed border-purple-200 bg-purple-50/30 rounded-2xl p-6 md:p-10 text-center hover:bg-purple-50 transition-colors cursor-pointer" onclick="document.getElementById('excel-upload-score').click()">
                    <span class="block text-lg font-bold text-purple-700">เลือกไฟล์ Excel (คะแนนข้อเขียน)</span>
                    <input id="excel-upload-score" type="file" class="hidden" accept=".xlsx, .xls" onchange="handleExcelUpload(this, 'score')">
                </div>
                <div id="score-preview-area" class="mt-6 hidden">
                    <div class="flex justify-between items-center mb-3"><h4 class="font-bold text-gray-700 text-sm">ข้อมูลคะแนน (<span id="score-count">0</span> คน)</h4><button type="button" onclick="confirmExcelImport('score')" class="px-4 py-2 bg-purple-500 text-white rounded-lg font-bold text-sm shadow-md hover:bg-purple-600">อัปเดตคะแนน</button></div>
                    <div class="overflow-auto max-h-48 border border-gray-200 rounded-xl text-xs bg-white"><table class="w-full text-left" id="score-preview-table"></table></div>
                </div>
            </div>

            <!-- View Excel (Practical) -->
            <div id="view-practical" class="hidden">
                <div class="border-2 border-dashed border-indigo-200 bg-indigo-50/30 rounded-2xl p-6 md:p-10 text-center hover:bg-indigo-50 transition-colors cursor-pointer" onclick="document.getElementById('excel-upload-practical').click()">
                    <span class="block text-lg font-bold text-indigo-700">เลือกไฟล์ Excel (คะแนนปฏิบัติ)</span>
                    <input id="excel-upload-practical" type="file" class="hidden" accept=".xlsx, .xls" onchange="handleExcelUpload(this, 'practical')">
                </div>
                <div id="practical-preview-area" class="mt-6 hidden">
                    <div class="flex justify-between items-center mb-3"><h4 class="font-bold text-gray-700 text-sm">รายการที่พบ (<span id="practical-count">0</span> คน)</h4><button type="button" onclick="confirmExcelImport('practical')" class="px-4 py-2 bg-indigo-600 text-white rounded-lg font-bold text-sm shadow-md hover:bg-indigo-700">ยืนยันนำเข้า</button></div>
                    <div class="overflow-auto max-h-48 border border-gray-200 rounded-xl text-xs bg-white"><table class="w-full text-left" id="practical-preview-table"></table></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Helper Modals -->
<div id="alert-modal" class="hidden-force fixed inset-0 flex items-center justify-center z-[200]">
    <div class="absolute w-full h-full bg-black/40 backdrop-blur-sm"></div>
    <div class="bg-white p-6 rounded-2xl shadow-xl z-[201] max-w-sm w-full mx-4 text-center">
        <h3 id="alert-title" class="text-lg font-bold text-gray-800 mb-2">แจ้งเตือน</h3>
        <p id="alert-message" class="text-gray-600 mb-6">ข้อความ</p>
        <button onclick="closeAlert()" class="w-full py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 font-bold rounded-xl">ตกลง</button>
    </div>
</div>

<div id="confirm-modal" class="hidden-force fixed inset-0 flex items-center justify-center z-[200]">
    <div class="absolute w-full h-full bg-black/40 backdrop-blur-sm"></div>
    <div class="bg-white p-6 rounded-2xl shadow-xl z-[201] max-w-sm w-full mx-4 text-center">
        <h3 id="confirm-title" class="text-lg font-bold text-gray-800 mb-2">ยืนยัน</h3>
        <p id="confirm-message" class="text-gray-600 mb-6">ข้อความ</p>
        <div class="flex gap-3">
            <button onclick="closeConfirm()" class="flex-1 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 font-bold rounded-xl">ยกเลิก</button>
            <button onclick="confirmAction()" class="flex-1 py-2 bg-lime-500 hover:bg-lime-600 text-white font-bold rounded-xl">ยืนยัน</button>
        </div>
    </div>
</div>

<div id="loading-modal" class="hidden-force fixed inset-0 flex items-center justify-center z-[200]">
    <div class="absolute w-full h-full bg-white/80 backdrop-blur-md"></div>
    <div class="z-[201] flex flex-col items-center">
        <div class="w-12 h-12 border-4 border-lime-200 border-t-lime-500 rounded-full animate-spin mb-4"></div>
        <p id="loading-message" class="text-lime-700 font-bold animate-pulse">กำลังทำงาน...</p>
    </div>
</div>

<script>
// --- Config & Global Variables ---
const defaultConfig = { 
    system_title: "ระบบประกาศผลคะแนน", 
    admission_year: "2569" 
};
const quotas = {
    m1: { 'S&M': 80, 'GATE': 60, 'EIS': 60 },
    m4: { 'SME': 80, 'GATE': 60 }
};
const practicalMaxScores = { 'S&M': 20, 'GATE': 100, 'EIS': 100, 'SME': 100 };

let currentUser = null, currentView = 'login', adminTab = 'm1', studentsData = [], searchQuery = '', formMode = 'create', excelDataCache = [], scoreDataCache = [], practicalDataCache = [], confirmCallback = null, isSidebarOpen = false, checkedIds = new Set();
let adminViewMode = 'manage', rankingTab = 'all';

// --- Helper Functions ---
function getThaiGrade(code) { const map = { 'p4': 'ประถมศึกษาปีที่ 4', 'p5': 'ประถมศึกษาปีที่ 5', 'p6': 'ประถมศึกษาปีที่ 6', 'm1': 'มัธยมศึกษาปีที่ 1', 'm3': 'มัธยมศึกษาปีที่ 3', 'm4': 'มัธยมศึกษาปีที่ 4' }; return map[code.toLowerCase()] || code; }
function toggleSidebar() { const sidebar = document.getElementById('sidebar'); if(sidebar) sidebar.classList.toggle('-translate-x-full'); const overlay = document.getElementById('sidebar-overlay'); if(overlay) overlay.classList.toggle('hidden'); }
function showAlert(t, m) { document.getElementById('alert-title').textContent = t; document.getElementById('alert-message').textContent = m; document.getElementById('alert-modal').classList.remove('hidden-force'); }
function closeAlert() { document.getElementById('alert-modal').classList.add('hidden-force'); }
function showConfirm(t, m, cb) { document.getElementById('confirm-title').textContent = t; document.getElementById('confirm-message').textContent = m; confirmCallback = cb; document.getElementById('confirm-modal').classList.remove('hidden-force'); }
function closeConfirm() { document.getElementById('confirm-modal').classList.add('hidden-force'); confirmCallback = null; }
function confirmAction() { if(confirmCallback) confirmCallback(); closeConfirm(); }
function showLoading(msg) { document.getElementById('loading-message').textContent = msg; document.getElementById('loading-modal').classList.remove('hidden-force'); }
function hideLoading() { document.getElementById('loading-modal').classList.add('hidden-force'); }
function openModal() { document.getElementById('student-modal').classList.remove('hidden-force'); document.body.classList.add('modal-active'); }
function closeModal() { document.getElementById('student-modal').classList.add('hidden-force'); document.body.classList.remove('modal-active'); }

const dataHandler = { 
    onDataChanged(data) { 
        studentsData = data.sort((a, b) => (parseFloat(b.total_score)||0) - (parseFloat(a.total_score)||0)); 
        if (currentView === 'admin') renderAdminDashboard(); 
        else if (currentView === 'student' && currentUser) { 
            const u = studentsData.find(s => String(s.national_id) === String(currentUser.national_id)); 
            if(u) currentUser = u; renderStudentView(); 
        } 
    } 
};

function render() {
    if(currentView === 'login') renderLogin();
    else if(currentView === 'admin') renderAdminDashboard();
    else renderStudentView();
}

function renderLogin() {
    document.getElementById('app').innerHTML = `
    <div class="h-full w-full bg-[#B2B2B2] flex flex-col items-center justify-center p-4 overflow-auto">
        <div class="w-full max-w-md bg-white rounded-[2rem] shadow-xl p-8 relative overflow-hidden shrink-0">
            <div class="text-center mb-8 relative z-10">
                <img src="https://img2.pic.in.th/pic/-69-1.png" class="h-32 w-auto mx-auto object-contain drop-shadow-md mb-6">
                <div class="text-gray-900 font-bold text-lg">ระบบประกาศผลคะแนน</div>
                <div class="text-gray-900 font-bold mt-1 text-xl">การสอบแข่งขันทักษะวิชาการเพชรราชพฤกษ์</div>
                <p class="text-gray-600 text-sm mt-2">โรงเรียนบางสะพานวิทยา</p>
                <p class="text-gray-400 mt-4 text-sm">ปีการศึกษา <span class="text-lime-600 font-bold">${defaultConfig.admission_year}</span></p>
            </div>
            <div class="space-y-3 mb-6 relative z-10" id="login-buttons">
                <button onclick="toggleLogin('student')" class="w-full py-4 px-6 rounded-2xl border-2 border-lime-300 text-lime-700 font-bold hover:bg-lime-50 transition-all flex items-center justify-center gap-2">ผู้เข้าสอบ</button>
                <button onclick="toggleLogin('admin')" class="w-full py-4 px-6 rounded-2xl border-2 border-amber-200 text-amber-500 font-bold hover:bg-amber-50 transition-all flex items-center justify-center gap-2">สำหรับแอดมิน</button>
            </div>
            <div id="login-form-container" class="hidden relative z-10 bg-gray-50/80 p-5 rounded-2xl border border-gray-100">
                <form onsubmit="handleLogin(event)" class="space-y-4">
                    <div id="input-student" class="hidden"><label class="block text-xs font-bold text-gray-500 mb-2">เลขบัตรประชาชน</label><input type="text" id="login-id" class="w-full px-4 py-3 rounded-xl border-gray-200 input-field"></div>
                    <div id="input-admin" class="hidden space-y-3">
                        <div><label class="block text-xs font-bold text-gray-500 mb-2">Username</label><input type="text" id="admin-user" class="w-full px-4 py-3 rounded-xl border-gray-200 input-field"></div>
                        <div><label class="block text-xs font-bold text-gray-500 mb-2">Password</label><input type="password" id="admin-pass" class="w-full px-4 py-3 rounded-xl border-gray-200 input-field"></div>
                    </div>
                    <div class="flex gap-2 pt-2"><button type="button" onclick="resetLogin()" class="px-4 py-3 bg-gray-200 rounded-xl font-bold text-sm">กลับ</button><button type="submit" class="flex-1 py-3 btn-primary rounded-xl font-bold">เข้าสู่ระบบ</button></div>
                </form>
            </div>
        </div>
    </div>`;
}

function toggleLogin(mode) { document.getElementById('login-buttons').classList.add('hidden'); document.getElementById('login-form-container').classList.remove('hidden'); if(mode==='student'){document.getElementById('input-student').classList.remove('hidden');document.getElementById('input-admin').classList.add('hidden');}else{document.getElementById('input-student').classList.add('hidden');document.getElementById('input-admin').classList.remove('hidden');} }
function resetLogin() { document.getElementById('login-form-container').classList.add('hidden'); document.getElementById('login-buttons').classList.remove('hidden'); }
function handleLogin(e) { e.preventDefault(); const isStudent = !document.getElementById('input-student').classList.contains('hidden'); if(isStudent){ const id = document.getElementById('login-id').value.trim(); const user = studentsData.find(s => String(s.national_id).trim() === String(id)); if(user){currentUser = user; currentView = 'student'; render();}else showAlert('ไม่พบข้อมูล', 'ไม่พบเลขบัตรประชาชนนี้ในระบบ'); }else{ if(document.getElementById('admin-user').value === 'admin' && document.getElementById('admin-pass').value === 'admin11275'){currentView='admin';render();}else showAlert('ผิดพลาด', 'ชื่อผู้ใช้หรือรหัสผ่านผิด'); } }

// --- Admin Dashboard ---
function renderAdminDashboard() {
    const m1 = studentsData.filter(s => ['p4','p5','p6','m1'].includes(s.grade_level));
    const m4 = studentsData.filter(s => ['m3','m4'].includes(s.grade_level));
    let activeData = adminTab === 'm1' ? m1 : m4;
    
    const totalStudents = activeData.length;
    const scores = activeData.map(s => (parseFloat(s.total_score)||0)).filter(s => s > 0);
    const maxScore = scores.length ? Math.max(...scores) : 0;
    const minScore = scores.length ? Math.min(...scores) : 0;

    let displayData = activeData;
    if(adminViewMode === 'manage' && searchQuery) {
        displayData = displayData.filter(s => s.full_name.includes(searchQuery) || String(s.exam_id).includes(searchQuery) || String(s.national_id).includes(searchQuery));
    }
    checkedIds.clear();

    document.getElementById('app').innerHTML = `
    <div class="h-screen flex bg-[#f8fafc] overflow-hidden relative">
        <aside id="sidebar" class="fixed inset-y-0 left-0 z-40 w-72 flex flex-col bg-white border-r border-gray-100 shadow-2xl transform -translate-x-full md:translate-x-0 transition-transform duration-300 md:static">
            <div class="h-20 flex items-center gap-3 px-6 border-b border-gray-50 shrink-0">
                <div class="font-bold text-lg">Admin Panel</div>
                <button onclick="toggleSidebar()" class="md:hidden ml-auto text-red-500">x</button>
            </div>
            <div class="flex-1 overflow-y-auto px-4 py-4 space-y-1">
                <button onclick="adminTab='m1';renderAdminDashboard();" class="w-full text-left px-4 py-3 rounded-xl ${adminTab==='m1' ? 'bg-lime-50 text-lime-700 font-bold' : 'text-gray-500 hover:bg-gray-50'}">ข้อมูล ม.1</button>
                <button onclick="adminTab='m4';renderAdminDashboard();" class="w-full text-left px-4 py-3 rounded-xl ${adminTab==='m4' ? 'bg-lime-50 text-lime-700 font-bold' : 'text-gray-500 hover:bg-gray-50'}">ข้อมูล ม.4</button>
                <div class="h-px bg-gray-100 my-4"></div>
                <button onclick="adminViewMode='manage';renderAdminDashboard();" class="w-full text-left px-4 py-3 rounded-xl ${adminViewMode==='manage'?'bg-blue-50 text-blue-700 font-bold':'text-gray-500'}">รายชื่อผู้สมัคร</button>
                <button onclick="adminViewMode='ranking';rankingTab='all';renderAdminDashboard();" class="w-full text-left px-4 py-3 rounded-xl ${adminViewMode==='ranking'?'bg-amber-50 text-amber-700 font-bold':'text-gray-500'}">ประกาศผล/จัดลำดับ</button>
                <button onclick="adminViewMode='interview';rankingTab='all';renderAdminDashboard();" class="w-full text-left px-4 py-3 rounded-xl ${adminViewMode==='interview'?'bg-purple-50 text-purple-700 font-bold':'text-gray-500'}">บันทึกคะแนนปฏิบัติ</button>
            </div>
            <div class="p-4 border-t"><button onclick="showAddStudentForm()" class="w-full py-2 bg-lime-500 text-white rounded-xl mb-2">เพิ่มข้อมูล</button><button onclick="currentView='login';render()" class="w-full py-2 text-red-500">ออกจากระบบ</button></div>
        </aside>
        <div id="sidebar-overlay" class="fixed inset-0 bg-black/30 z-30 hidden md:hidden" onclick="toggleSidebar()"></div>
        <main class="flex-1 flex flex-col h-full overflow-hidden w-full relative">
            <header class="h-16 bg-white border-b flex items-center justify-between px-4 md:hidden z-20"><span class="font-bold">Admin Panel</span><button onclick="toggleSidebar()" class="p-2 bg-gray-100 rounded">Menu</button></header>
            <div class="flex-1 overflow-y-auto p-4 md:p-8 bg-[#f8fafc]">
                ${adminViewMode === 'manage' ? `<div class="grid grid-cols-2 md:grid-cols-4 gap-3 md:gap-6 mb-8">
                    <div class="bg-white p-4 rounded-xl shadow-sm border"><span class="text-xs text-gray-400">จำนวน</span><div class="text-2xl font-bold">${totalStudents}</div></div>
                    <div class="bg-white p-4 rounded-xl shadow-sm border"><span class="text-xs text-gray-400">สูงสุด</span><div class="text-2xl font-bold">${maxScore.toFixed(2)}</div></div>
                    <div class="bg-white p-4 rounded-xl shadow-sm border"><span class="text-xs text-gray-400">ต่ำสุด</span><div class="text-2xl font-bold">${minScore.toFixed(2)}</div></div>
                    <div class="bg-white p-4 rounded-xl shadow-sm border"><span class="text-xs text-gray-400">ชั้น</span><div class="text-2xl font-bold uppercase">${adminTab}</div></div>
                </div>` : ''}
                
                ${adminViewMode === 'manage' ? renderManageView(displayData, activeData.length) : (adminViewMode === 'ranking' ? renderRankingView(activeData) : renderInterviewView(activeData))}
            </div>
        </main>
    </div>`;
}

function renderManageView(data, totalCount) {
    return `
    <div class="flex justify-between items-end mb-4"><h1 class="text-2xl font-bold">จัดการข้อมูล ${adminTab.toUpperCase()}</h1></div>
    <div class="bg-white p-2 rounded-2xl shadow-sm mb-6 flex gap-2">
        <input type="text" id="search-input" placeholder="ค้นหา..." class="flex-1 pl-4 py-2 rounded-xl border bg-gray-50" value="${searchQuery}" onkeydown="if(event.key==='Enter') triggerSearch()">
        <button onclick="triggerSearch()" class="px-6 bg-lime-400 text-white rounded-xl font-bold">ค้นหา</button>
        <button id="btn-bulk-delete" onclick="executeBulkDelete()" class="hidden px-4 bg-red-400 text-white rounded-xl font-bold">ลบ (<span id="selected-count">0</span>)</button>
    </div>
    <div class="bg-white rounded-3xl shadow-sm overflow-hidden border border-gray-100">
        <div class="overflow-x-auto">
            <table class="w-full text-left min-w-[800px]">
                <thead class="bg-gray-50 text-gray-600 text-sm uppercase font-bold"><tr><th class="px-4 py-4 w-10"><input type="checkbox" onchange="toggleAllCheckboxes(this)"></th><th class="px-4 py-4">รหัส</th><th class="px-4 py-4">ชื่อ-สกุล</th><th class="px-4 py-4">คะแนนรวม</th><th class="px-4 py-4">เลือก 1</th><th class="px-4 py-4 text-center">จัดการ</th></tr></thead>
                <tbody class="divide-y divide-gray-50 text-sm">${data.map(s => `<tr class="hover:bg-gray-50"><td class="px-4 py-4"><input type="checkbox" value="${s.__backendId}" onchange="toggleCheckbox('${s.__backendId}')" class="row-checkbox"></td><td class="px-4 py-4 font-bold text-lime-600">${s.exam_id}</td><td class="px-4 py-4 cursor-pointer" onclick="showEditForm('${s.__backendId}')">${s.full_name}</td><td class="px-4 py-4 font-bold">${s.total_score>0?s.total_score.toFixed(2):'-'}</td><td class="px-4 py-4">${s.choice_1||'-'}</td><td class="px-4 py-4 text-center"><button onclick="showEditForm('${s.__backendId}')" class="text-lime-500 p-2">แก้ไข</button><button onclick="deleteStudent('${s.__backendId}')" class="text-red-400 p-2">ลบ</button></td></tr>`).join('')}</tbody>
            </table>
        </div>
    </div>`;
}

function renderRankingView(allStudents) {
    const sorted = [...allStudents].sort((a,b) => b.total_score - a.total_score);
    const currentQuotas = { ...quotas[adminTab] };
    const counts = {}; Object.keys(currentQuotas).forEach(k => counts[k] = 0);
    const allocation = {}; 

    sorted.forEach(s => {
        let choices = adminTab === 'm4' ? [s.choice_1, s.choice_2] : [s.choice_1, s.choice_2, s.choice_3];
        choices = choices.filter(c => c);
        for (const c of choices) {
            if (currentQuotas[c] !== undefined && counts[c] < currentQuotas[c]) {
                allocation[s.__backendId] = c; counts[c]++; break;
            }
        }
    });

    let list = [];
    if (rankingTab === 'all') {
        list = sorted.map((s, i) => ({ ...s, rank: i+1, status: allocation[s.__backendId] ? 'pass' : 'fail', got: allocation[s.__backendId] || '-' }));
    } else {
        const target = { 'sm': 'S&M', 'gate': 'GATE', 'eis': 'EIS', 'sme': 'SME' }[rankingTab];
        list = sorted.filter(s => {
            if(allocation[s.__backendId] === target) return true;
            const chosen = (s.choice_1 === target || s.choice_2 === target || (adminTab !== 'm4' && s.choice_3 === target));
            return chosen && !allocation[s.__backendId];
        }).map(s => ({ ...s, rank: sorted.findIndex(x=>x.__backendId===s.__backendId)+1, status: allocation[s.__backendId] === target ? 'pass' : 'fail' }));
    }

    const tabs = adminTab === 'm1' ? [{id:'all',l:'สรุป'},{id:'sm',l:'S&M'},{id:'gate',l:'GATE'},{id:'eis',l:'EIS'}] : [{id:'all',l:'สรุป'},{id:'sme',l:'SME'},{id:'gate',l:'GATE'}];
    return `
    <div class="mb-4 flex flex-wrap gap-2 justify-between">
        <div class="flex gap-2">${tabs.map(t => `<button onclick="rankingTab='${t.id}';renderAdminDashboard()" class="px-4 py-2 rounded-xl border ${rankingTab===t.id?'bg-lime-500 text-white':'bg-white'}">${t.l}</button>`).join('')}</div>
        <div class="flex gap-2"><button onclick="exportRankingToExcel()" class="bg-green-600 text-white px-4 py-2 rounded-xl">Excel</button></div>
    </div>
    <div class="bg-white rounded-3xl shadow-sm overflow-hidden border">
        <div class="overflow-x-auto"><table class="w-full text-left"><thead class="bg-gray-50 font-bold"><tr><th class="px-6 py-3">ลำดับ</th><th class="px-6 py-3">ชื่อ</th><th class="px-6 py-3">คะแนน</th><th class="px-6 py-3">เลือก</th><th class="px-6 py-3">สถานะ</th></tr></thead>
        <tbody class="divide-y">${list.map(s => `<tr class="${s.status==='pass'?'bg-green-50/50':''}"><td class="px-6 py-4">#${s.rank}</td><td class="px-6 py-4">${s.full_name}<br><small>${s.exam_id}</small></td><td class="px-6 py-4 font-bold">${s.total_score.toFixed(2)}</td><td class="px-6 py-4 text-xs">${[s.choice_1,s.choice_2].join(', ')}</td><td class="px-6 py-4 font-bold ${s.status==='pass'?'text-green-600':'text-gray-400'}">${s.status==='pass'?'ผ่าน':'ไม่ผ่าน'} ${s.got?s.got:''}</td></tr>`).join('')}</tbody></table></div>
    </div>`;
}

function renderInterviewView(allStudents) {
    const sortedForClearing = [...allStudents].sort((a,b) => (b.total_score||0) - (a.total_score||0));
    const currentQuotas = { ...quotas[adminTab] };
    const counts = {}; Object.keys(currentQuotas).forEach(k => counts[k] = 0);
    const allocationResult = {}; 

    sortedForClearing.forEach(s => {
        let choices = adminTab === 'm4' ? [s.choice_1, s.choice_2].filter(c=>c) : [s.choice_1, s.choice_2, s.choice_3].filter(c=>c);
        for (const choiceName of choices) {
            if (currentQuotas[choiceName] !== undefined && counts[choiceName] < currentQuotas[choiceName]) {
                allocationResult[s.__backendId] = choiceName; counts[choiceName]++; break;
            }
        }
    });

    const availablePrograms = adminTab === 'm1' ? ['sm', 'gate', 'eis'] : ['sme', 'gate'];
    if (rankingTab === 'all' || !availablePrograms.includes(rankingTab)) rankingTab = availablePrograms[0];

    const targetProgramName = { 'sm': 'S&M', 'gate': 'GATE', 'eis': 'EIS', 'sme': 'SME' }[rankingTab];
    const maxPractical = targetProgramName === 'S&M' ? 20 : 100;
    const maxTotal = 100 + maxPractical;
    const finalRoundQuota = 40; 

    let interviewList = allStudents.filter(s => allocationResult[s.__backendId] === targetProgramName);
    interviewList = interviewList.map(s => {
        const written = parseFloat(s.total_score) || 0;
        const practical = parseFloat(s.practical_score) || 0;
        return { ...s, written_score: written, practical_score: practical, grand_total: written + practical };
    }).sort((a, b) => b.grand_total - a.grand_total);

    const tabs = adminTab === 'm1' ? [{ id: 'sm', label: 'S&M' }, { id: 'gate', label: 'GATE' }, { id: 'eis', label: 'EIS' }] : [{ id: 'sme', label: 'SME' }, { id: 'gate', label: 'GATE' }];

    return `
    <div class="mb-6 flex flex-col md:flex-row justify-between items-start md:items-end gap-4">
        <div>
            <h1 class="text-2xl md:text-3xl font-bold text-gray-800 mb-2">บันทึกคะแนนปฏิบัติ ${adminTab==='m1'?'ม.1':'ม.4'}</h1>
            <div class="flex flex-wrap gap-2">${tabs.map(t => `<button onclick="rankingTab='${t.id}';renderAdminDashboard();" class="px-5 py-2.5 rounded-xl text-sm font-bold transition-all border shadow-sm ${rankingTab===t.id ? 'bg-lime-500 text-white border-lime-500 shadow-lg shadow-lime-200' : 'bg-white text-gray-500 border-gray-200 hover:bg-gray-50'}">${t.label}</button>`).join('')}</div>
        </div>
        <div class="flex gap-2">
             <button onclick="exportInterviewToExcel()" class="flex items-center gap-2 px-4 py-3 bg-green-600 hover:bg-green-700 text-white rounded-xl font-bold shadow-lg shadow-green-200 transition-all active:scale-95">Excel</button>
             <button onclick="exportInterviewToWord()" class="flex items-center gap-2 px-4 py-3 bg-gradient-to-r from-lime-500 to-green-600 hover:from-lime-600 hover:to-green-700 text-white rounded-xl font-bold shadow-lg shadow-lime-200/50 transition-all active:scale-95">Word</button>
        </div>
    </div>
    <div class="bg-white rounded-[2rem] shadow-sm border border-gray-100 overflow-hidden">
        <div class="p-6 bg-lime-50/50 border-b border-lime-100 flex justify-between items-center">
            <div><h3 class="font-bold text-lime-800 text-lg">โครงการ ${targetProgramName}</h3><p class="text-xs text-lime-600 mt-1">เต็ม: ข้อเขียน(100)+ปฏิบัติ(${maxPractical}) = ${maxTotal}</p></div>
            <div class="text-sm font-bold text-gray-500 bg-white px-4 py-2 rounded-xl shadow-sm">จำนวน: <span class="text-lime-600 text-lg">${interviewList.length}</span></div>
        </div>
        <div class="overflow-x-auto"><table class="w-full text-left border-collapse"><thead><tr class="bg-gray-50 text-gray-500 text-xs uppercase font-bold tracking-wider">
            <th class="px-4 py-4 w-12 text-center">ที่</th><th class="px-4 py-4">ผู้เข้าสอบ</th><th class="px-4 py-4 text-center">รวมข้อเขียน</th><th class="px-4 py-4 text-center bg-lime-50 text-lime-700">คะแนนปฏิบัติ</th><th class="px-4 py-4 text-center">รวมสุทธิ</th><th class="px-4 py-4 text-center">สถานะ</th><th class="px-4 py-4 text-center">จัดการ</th>
        </tr></thead><tbody class="divide-y divide-gray-50 text-sm">
        ${interviewList.length > 0 ? interviewList.map((s, i) => `
        <tr class="hover:bg-lime-50/30 transition-colors group">
            <td class="px-4 py-4 text-center font-bold text-gray-400 group-hover:text-lime-600">#${i+1}</td>
            <td class="px-4 py-4"><div class="font-bold text-gray-800">${s.full_name}</div><div class="text-xs text-gray-400 font-mono mt-0.5">${s.exam_id}</div></td>
            <td class="px-4 py-4 text-center font-bold text-gray-700">${s.written_score.toFixed(2)}</td>
            <td class="px-4 py-4 text-center font-bold text-lime-700 bg-lime-50/20">${s.practical_score > 0 ? s.practical_score.toFixed(2) : '-'}</td>
            <td class="px-4 py-4 text-center font-black text-gray-800 text-lg">${s.grand_total.toFixed(2)}</td>
            <td class="px-4 py-4 text-center">${i < finalRoundQuota ? `<span class="px-2 py-1 rounded bg-green-100 text-green-700 text-xs font-bold">ตัวจริง</span>` : `<span class="px-2 py-1 rounded bg-orange-50 text-orange-600 text-xs font-bold">สำรอง ${i - finalRoundQuota + 1}</span>`}</td>
            <td class="px-4 py-4 text-center"><button onclick="showInterviewForm('${s.__backendId}', ${maxPractical}, '${targetProgramName}')" class="px-4 py-2 bg-lime-100 hover:bg-lime-200 text-lime-700 rounded-xl text-xs font-bold border border-lime-200 active:scale-95 transition-all">ให้คะแนน</button></td>
        </tr>`).join('') : `<tr><td colspan="7" class="text-center py-12 text-gray-400">ไม่มีข้อมูล</td></tr>`}
        </tbody></table></div></div>`;
}

function renderStudentView() {
    if(!currentUser) return;
    const s = currentUser;
    const total = (parseFloat(s.science_score)||0) + (parseFloat(s.math_score)||0) + (parseFloat(s.english_score)||0);
    document.getElementById('app').innerHTML = `
    <div class="h-full bg-[#fdfbf7] overflow-auto">
        <div class="gradient-bg h-48 w-full absolute top-0 left-0 z-0 rounded-b-[3rem] shadow-lg opacity-90"></div>
        <div class="relative z-10 max-w-4xl mx-auto p-4 pt-8">
            <div class="bg-white rounded-[2rem] p-8 mb-6 shadow-xl relative border border-lime-100 text-center">
                <img src="https://img2.pic.in.th/pic/-69-1.png" class="w-32 mx-auto mb-4">
                <h1 class="text-xl font-bold text-lime-900">ประกาศผลคะแนน</h1>
                <h2 class="text-lg font-bold text-lime-900">ปีการศึกษา ${defaultConfig.admission_year}</h2>
                <div class="absolute top-4 right-4"><button onclick="currentView='login';render()" class="text-red-500 font-bold border rounded-full px-3 py-1">ออก</button></div>
            </div>
            <div class="bg-white rounded-[2rem] p-6 shadow-xl mb-6 relative border border-lime-100">
                <h2 class="text-2xl font-bold">${s.full_name}</h2>
                <p class="text-lime-600 font-bold">${getThaiGrade(s.grade_level)}</p>
                <div class="grid grid-cols-1 gap-3 mt-4">
                    <div class="bg-gray-50 px-4 py-3 rounded-xl flex justify-between"><span>รหัสสอบ</span><span class="font-bold">${s.exam_id}</span></div>
                    <div class="bg-gray-50 px-4 py-3 rounded-xl flex justify-between"><span>โรงเรียนเดิม</span><span class="font-bold">${s.previous_school}</span></div>
                </div>
            </div>
            <h3 class="font-bold text-gray-600 mb-4 ml-2">คะแนนรายวิชา</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div class="bg-white p-5 rounded-2xl shadow-sm border"><div class="text-gray-500 text-xs font-bold uppercase">วิทยาศาสตร์</div><div class="text-3xl font-bold">${s.science_score||0} <span class="text-xs text-gray-400">/40</span></div></div>
                <div class="bg-white p-5 rounded-2xl shadow-sm border"><div class="text-gray-500 text-xs font-bold uppercase">คณิตศาสตร์</div><div class="text-3xl font-bold">${s.math_score||0} <span class="text-xs text-gray-400">/30</span></div></div>
                <div class="bg-white p-5 rounded-2xl shadow-sm border"><div class="text-gray-500 text-xs font-bold uppercase">อังกฤษ</div><div class="text-3xl font-bold">${s.english_score||0} <span class="text-xs text-gray-400">/30</span></div></div>
            </div>
            <div class="bg-orange-50 rounded-3xl p-6 border border-orange-100 text-center">
                <p class="text-orange-700 font-bold uppercase text-xs">คะแนนรวม</p>
                <div class="text-5xl font-black text-orange-500">${total.toFixed(2)}</div>
            </div>
        </div>
    </div>`;
}

// --- Logic & Events ---
function switchAddTab(tabName) { 
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active')); 
    document.getElementById(`tab-${tabName}`).classList.add('active'); 
    ['single','multiple','excel','score','practical'].forEach(v => document.getElementById(`view-${v}`).classList.add('hidden')); 
    document.getElementById(`view-${tabName}`).classList.remove('hidden'); 
    if(tabName==='multiple') { document.getElementById('multiple-tbody').innerHTML=''; addMultipleRow(); } 
}

function showAddStudentForm() { formMode = 'create'; document.getElementById('modal-title').textContent = 'เพิ่มผู้เข้าสอบใหม่'; document.getElementById('add-mode-tabs').classList.remove('hidden'); document.getElementById('score-section').classList.add('hidden'); switchAddTab('single'); document.getElementById('student-form').reset(); openModal(); }

function showEditForm(id) {
    formMode = 'update';
    document.getElementById('modal-title').textContent = 'แก้ไขข้อมูล';
    document.getElementById('add-mode-tabs').classList.add('hidden');
    ['single','multiple','excel','score','practical'].forEach(v => document.getElementById(`view-${v}`).classList.add('hidden'));
    document.getElementById('view-single').classList.remove('hidden');
    document.getElementById('score-section').classList.remove('hidden');
    const s = studentsData.find(x => x.__backendId === id);
    if(!s) return;
    document.getElementById('student-backend-id').value = s.__backendId;
    document.getElementById('form-national-id').value = s.national_id || '';
    document.getElementById('form-exam-id').value = s.exam_id;
    document.getElementById('form-grade').value = s.grade_level;
    document.getElementById('form-name').value = s.full_name;
    document.getElementById('form-school').value = s.previous_school;
    document.getElementById('form-choice-1').value = s.choice_1 || '';
    document.getElementById('form-choice-2').value = s.choice_2 || '';
    document.getElementById('form-choice-3').value = s.choice_3 || '';
    document.getElementById('score-science').value = s.science_score;
    document.getElementById('score-math').value = s.math_score;
    document.getElementById('score-english').value = s.english_score;
    openModal();
}

function handleSingleSubmit(e) {
    e.preventDefault();
    const scores = [0, parseFloat(document.getElementById('score-math').value)||0, parseFloat(document.getElementById('score-science').value)||0, parseFloat(document.getElementById('score-english').value)||0, 0];
    const data = {
        exam_id: document.getElementById('form-exam-id').value,
        national_id: document.getElementById('form-national-id').value,
        grade_level: document.getElementById('form-grade').value,
        full_name: document.getElementById('form-name').value,
        previous_school: document.getElementById('form-school').value,
        choice_1: document.getElementById('form-choice-1').value,
        choice_2: document.getElementById('form-choice-2').value,
        choice_3: document.getElementById('form-choice-3').value,
        thai_score: scores[0], math_score: scores[1], science_score: scores[2], english_score: scores[3], aptitude_score: scores[4],
        total_score: scores.reduce((a,b)=>a+b,0)
    };
    showLoading('กำลังบันทึก...');
    const action = formMode === 'create' ? window.dataSdk.create(data) : (data.__backendId = document.getElementById('student-backend-id').value, window.dataSdk.update(data));
    action.then(res => { setTimeout(() => { hideLoading(); if(res.isOk) { closeModal(); showAlert('สำเร็จ', 'บันทึกเรียบร้อย'); } else { showAlert('ผิดพลาด', res.error.message); } }, 500); });
}

function deleteStudent(id) { showConfirm('ยืนยันลบ', 'ต้องการลบข้อมูลนี้หรือไม่?', () => { showLoading('กำลังลบ...'); window.dataSdk.delete({__backendId: id}).then(res => { setTimeout(() => { hideLoading(); if(res.isOk) { showAlert('สำเร็จ', 'ลบเรียบร้อย'); } else { showAlert('ผิดพลาด', res.error.message); } }, 500); }); }); }
function toggleAllCheckboxes(source) { document.querySelectorAll('.row-checkbox').forEach(cb => { cb.checked = source.checked; if(source.checked) checkedIds.add(cb.value); else checkedIds.delete(cb.value); }); updateDeleteButton(); }
function toggleCheckbox(id) { const cb = document.querySelector(`.row-checkbox[value="${id}"]`); if(cb.checked) checkedIds.add(id); else checkedIds.delete(id); updateDeleteButton(); }
function updateDeleteButton() { const btn = document.getElementById('btn-bulk-delete'); if(checkedIds.size > 0) { btn.classList.remove('hidden'); document.getElementById('selected-count').textContent = checkedIds.size; } else { btn.classList.add('hidden'); } }
function executeBulkDelete() { if(checkedIds.size === 0) return; showConfirm('ยืนยัน', `ลบ ${checkedIds.size} รายการ?`, () => { showLoading('กำลังลบ...'); window.dataSdk.deleteBulk(Array.from(checkedIds)).then(res => { setTimeout(() => { hideLoading(); checkedIds.clear(); if(res.isOk) showAlert('สำเร็จ','เรียบร้อย'); else showAlert('ผิดพลาด',res.error.message); },500);});}); }
function triggerSearch() { searchQuery = document.getElementById('search-input').value.trim(); renderAdminDashboard(); }
function addMultipleRow() { const tr = document.createElement('tr'); tr.innerHTML = `<td class="p-2"><input type="text" class="w-full border rounded px-2 py-1 multi-national-id" placeholder="บัตรฯ"></td><td class="p-2"><input type="text" class="w-full border rounded px-2 py-1 multi-exam-id" placeholder="รหัส"></td><td class="p-2"><input type="text" class="w-full border rounded px-2 py-1 multi-name" placeholder="ชื่อ"></td><td class="p-2"><select class="w-full border rounded px-2 py-1 multi-grade"><option value="p6">ป.6</option><option value="m1">ม.1</option><option value="m3">ม.3</option><option value="m4">ม.4</option></select></td><td class="p-2"><input type="text" class="w-full border rounded px-2 py-1 multi-school" value="บางสะพานวิทยา"></td><td class="p-2 text-center"><button type="button" onclick="this.closest('tr').remove()" class="text-red-500 font-bold">x</button></td>`; document.getElementById('multiple-tbody').appendChild(tr); }

function handleMultipleSubmit() {
    const rows = document.querySelectorAll('#multiple-tbody tr'); const bulkData = [];
    rows.forEach(row => { const nid = row.querySelector('.multi-national-id').value.trim(); const id = row.querySelector('.multi-exam-id').value.trim(); const name = row.querySelector('.multi-name').value.trim(); if(id && name) bulkData.push({ exam_id: id, national_id: nid, full_name: name, grade_level: row.querySelector('.multi-grade').value, previous_school: row.querySelector('.multi-school').value.trim(), thai_score:0, math_score:0, science_score:0, english_score:0, aptitude_score:0, total_score:0, rank:0 }); });
    if(bulkData.length === 0) return showAlert('แจ้งเตือน', 'กรุณากรอกข้อมูล');
    showConfirm('ยืนยัน', `เพิ่ม ${bulkData.length} รายการ?`, () => { showLoading('บันทึก...'); window.dataSdk.createBulk(bulkData).then(res => { setTimeout(() => { hideLoading(); if(res.isOk) { closeModal(); showAlert('สำเร็จ','เรียบร้อย'); } else showAlert('ผิดพลาด', res.error.message); }, 500); }); });
}

function handleExcelUpload(input, type) {
    if(!input.files[0]) return;
    const reader = new FileReader();
    reader.onload = (e) => {
        const workbook = XLSX.read(new Uint8Array(e.target.result), {type: 'array'});
        const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], {header: 1, raw: false, defval: ""});
        if(type === 'student') {
            excelDataCache = [];
            for(let i=1; i<jsonData.length; i++) {
                const row = jsonData[i];
                if(row[0] && row[2]) excelDataCache.push({ exam_id: String(row[0]), national_id: String(row[1]||''), full_name: String(row[2]), grade_level: String(row[3]||'m1').toLowerCase(), previous_school: String(row[4]||''), choice_1: String(row[5]||'').trim(), choice_2: String(row[6]||'').trim(), choice_3: String(row[7]||'').trim(), total_score:0 });
            }
            document.getElementById('excel-count').textContent = excelDataCache.length;
            document.getElementById('excel-preview-area').classList.remove('hidden');
            document.getElementById('excel-preview-table').innerHTML = excelDataCache.slice(0,5).map(p=>`<tr><td class="p-1">${p.exam_id}</td><td class="p-1">${p.full_name}</td></tr>`).join('');
        } else if(type === 'score') {
            scoreDataCache = [];
            for(let i=1; i<jsonData.length; i++) { const row = jsonData[i]; if(row[0]) scoreDataCache.push({ exam_id: String(row[0]), science_score: row[1]||0, math_score: row[2]||0, english_score: row[3]||0 }); }
            document.getElementById('score-count').textContent = scoreDataCache.length;
            document.getElementById('score-preview-area').classList.remove('hidden');
            document.getElementById('score-preview-table').innerHTML = scoreDataCache.slice(0,5).map(p=>`<tr><td class="p-1">${p.exam_id}</td><td class="p-1">วิทย์: ${p.science_score}</td></tr>`).join('');
        } else if (type === 'practical') {
            practicalDataCache = [];
            for(let i=1; i<jsonData.length; i++) {
                const examId = String(jsonData[i][0]).trim(); const score = parseFloat(jsonData[i][1]);
                const student = studentsData.find(s => String(s.exam_id) === examId);
                if(examId && !isNaN(score) && student) practicalDataCache.push({ ...student, practical_score: score });
            }
            document.getElementById('practical-count').textContent = practicalDataCache.length;
            document.getElementById('practical-preview-area').classList.remove('hidden');
            document.getElementById('practical-preview-table').innerHTML = practicalDataCache.slice(0,5).map(p=>`<tr><td class="p-1">${p.exam_id}</td><td class="p-1">${p.full_name}</td><td class="p-1 font-bold">${p.practical_score}</td></tr>`).join('');
        }
    };
    reader.readAsArrayBuffer(input.files[0]);
}

function confirmExcelImport(type) {
    if(type === 'student' && excelDataCache.length > 0) {
        showConfirm('ยืนยัน', `นำเข้า ${excelDataCache.length} รายการ?`, () => { showLoading('นำเข้า...'); window.dataSdk.createBulk(excelDataCache).then(res => { setTimeout(() => { hideLoading(); if(res.isOk) { closeModal(); showAlert('สำเร็จ','เรียบร้อย'); } else showAlert('ผิดพลาด',res.error.message); }, 500); }); });
    } else if(type === 'score' && scoreDataCache.length > 0) {
        showConfirm('ยืนยัน', `อัปเดตคะแนน ${scoreDataCache.length} รายการ?`, () => { showLoading('อัปเดต...'); window.dataSdk.updateScoresBulk(scoreDataCache).then(res => { setTimeout(() => { hideLoading(); if(res.isOk) { closeModal(); showAlert('สำเร็จ','เรียบร้อย'); } else showAlert('ผิดพลาด',res.error.message); }, 500); }); });
    } else if (type === 'practical' && practicalDataCache.length > 0) {
        showConfirm('ยืนยัน', `นำเข้าคะแนนปฏิบัติ ${practicalDataCache.length} รายการ?`, () => { showLoading('บันทึก...'); const promises = practicalDataCache.map(u => window.dataSdk.update(u)); Promise.all(promises).then(() => { setTimeout(() => { hideLoading(); closeModal(); showAlert('สำเร็จ', 'เรียบร้อย'); window.dataSdk.refresh().then(() => renderAdminDashboard()); }, 1500); }).catch(err => { hideLoading(); showAlert('ผิดพลาด', err.message); }); });
    }
}

// --- Interview Modal Logic ---
function showInterviewForm(id, maxScore, programName) {
    const s = studentsData.find(x => x.__backendId === id); if (!s) return;
    const written = parseFloat(s.total_score) || 0;
    const practical = parseFloat(s.practical_score) || 0;
    const modalHtml = `
    <div id="interview-modal-wrapper" class="fixed inset-0 flex items-center justify-center z-[150] px-4">
        <div class="absolute w-full h-full bg-black/60 backdrop-blur-sm" onclick="document.getElementById('interview-modal-wrapper').remove()"></div>
        <div class="bg-white w-full max-w-lg rounded-[2rem] shadow-2xl z-[151] overflow-hidden relative">
            <div class="bg-gradient-to-r from-lime-400 to-lime-500 p-6 pt-8 pb-10 text-white relative">
                <button onclick="document.getElementById('interview-modal-wrapper').remove()" class="absolute top-4 right-4 bg-black/10 rounded-full p-1"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
                <div class="text-center"><div class="inline-block px-3 py-1 bg-white/20 rounded-full text-xs font-bold mb-2">โครงการ ${programName}</div><h2 class="text-2xl font-bold">${s.full_name}</h2><p class="text-lime-50 font-medium">รหัส: ${s.exam_id}</p></div>
            </div>
            <div class="p-6 -mt-6 bg-white rounded-t-[2rem] relative z-20">
                <div class="bg-gray-50 rounded-xl p-4 border flex justify-between items-center mb-6"><span class="text-sm font-bold text-gray-500">ข้อเขียน</span><span class="text-2xl font-black text-gray-700">${written.toFixed(2)}</span></div>
                <label class="block text-sm font-bold text-lime-700 mb-2">คะแนนปฏิบัติ (เต็ม ${maxScore})</label>
                <input type="number" id="input-score-modal" class="w-full px-4 py-4 text-center text-3xl font-black text-lime-600 border-2 border-lime-200 rounded-2xl focus:border-lime-500 outline-none" value="${practical>0?practical:''}" placeholder="0" onkeydown="if(event.key==='Enter') saveSingleInterviewScore('${id}', ${maxScore})">
                <button onclick="saveSingleInterviewScore('${id}', ${maxScore})" id="btn-save-interview" class="w-full mt-6 py-4 btn-primary rounded-2xl font-bold shadow-lg">บันทึกข้อมูล</button>
            </div>
        </div>
    </div>`;
    const div = document.createElement('div'); div.innerHTML = modalHtml; document.body.appendChild(div.firstElementChild);
    setTimeout(() => document.getElementById('input-score-modal').focus(), 100);
}

function saveSingleInterviewScore(id, maxScore) {
    const input = document.getElementById('input-score-modal');
    let score = parseFloat(input.value);
    if(isNaN(score)) score = 0; if(score < 0) score = 0;
    if(score > maxScore) { alert(`คะแนนห้ามเกิน ${maxScore}`); return; }
    
    const idx = studentsData.findIndex(s => s.__backendId === id); if(idx === -1) return;
    const updateData = { ...studentsData[idx], practical_score: score };
    
    const btn = document.getElementById('btn-save-interview');
    btn.innerHTML = 'กำลังบันทึก...'; btn.disabled = true;

    window.dataSdk.update(updateData).then(res => {
        if(res.isOk) {
            studentsData[idx].practical_score = score;
            document.getElementById('interview-modal-wrapper').remove();
            renderAdminDashboard();
        } else {
            alert('Error: ' + res.error.message); btn.innerHTML = 'บันทึกข้อมูล'; btn.disabled = false;
        }
    });
}

// --- Export Functions ---
function exportRankingToExcel() {
    const m1 = studentsData.filter(s => ['p4','p5','p6','m1'].includes(s.grade_level));
    const m4 = studentsData.filter(s => ['m3','m4'].includes(s.grade_level));
    const activeData = adminTab === 'm1' ? m1 : m4;
    const sorted = [...activeData].sort((a,b) => b.total_score - a.total_score);
    
    const currentQuotas = { ...quotas[adminTab] }; const counts = {}; Object.keys(currentQuotas).forEach(k => counts[k]=0); const allocation={};
    sorted.forEach(s => { const choices = (adminTab==='m4'?[s.choice_1,s.choice_2]:[s.choice_1,s.choice_2,s.choice_3]).filter(c=>c); for(const c of choices){ if(currentQuotas[c]!==undefined && counts[c]<currentQuotas[c]){ allocation[s.__backendId]=c; counts[c]++; break; } } });

    const target = { 'sm': 'S&M', 'gate': 'GATE', 'eis': 'EIS', 'sme': 'SME' }[rankingTab];
    const list = rankingTab==='all' ? sorted : sorted.filter(s => allocation[s.__backendId]===target || (s.choice_1===target && !allocation[s.__backendId]));

    const rows = list.map((s, i) => ({
        'ลำดับ': i+1, 'เลขประจำตัวสอบ': s.exam_id, 'ชื่อ-นามสกุล': s.full_name, 'คะแนนรวม': s.total_score,
        'ผลการคัดเลือก': rankingTab==='all' ? (allocation[s.__backendId]||'ไม่ผ่าน') : (allocation[s.__backendId]===target?'ผ่าน':'ไม่ผ่าน')
    }));
    const ws = XLSX.utils.json_to_sheet(rows); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Ranking"); XLSX.writeFile(wb, `Ranking_${adminTab}.xlsx`);
}

function exportInterviewToExcel() {
    const m1 = studentsData.filter(s => ['p4','p5','p6','m1'].includes(s.grade_level)); const m4 = studentsData.filter(s => ['m3','m4'].includes(s.grade_level));
    const activeData = adminTab === 'm1' ? m1 : m4; const sorted = [...activeData].sort((a,b) => b.total_score - a.total_score);
    const currentQuotas = { ...quotas[adminTab] }; const counts = {}; Object.keys(currentQuotas).forEach(k => counts[k]=0); const allocation={};
    sorted.forEach(s => { const choices = (adminTab==='m4'?[s.choice_1,s.choice_2]:[s.choice_1,s.choice_2,s.choice_3]).filter(c=>c); for(const c of choices){ if(currentQuotas[c]!==undefined && counts[c]<currentQuotas[c]){ allocation[s.__backendId]=c; counts[c]++; break; } } });
    
    const target = { 'sm': 'S&M', 'gate': 'GATE', 'eis': 'EIS', 'sme': 'SME' }[rankingTab];
    let list = activeData.filter(s => allocation[s.__backendId] === target).map(s => ({ ...s, grand: (parseFloat(s.total_score)||0)+(parseFloat(s.practical_score)||0) })).sort((a,b) => b.grand - a.grand);
    
    const rows = list.map((s, i) => ({
        'ลำดับ': i+1, 'รหัส': s.exam_id, 'ชื่อ': s.full_name, 'ข้อเขียน': s.total_score, 'ปฏิบัติ': s.practical_score, 'รวม': s.grand, 'สถานะ': i < 40 ? 'ตัวจริง' : 'สำรอง '+(i-39)
    }));
    const ws = XLSX.utils.json_to_sheet(rows); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Interview"); XLSX.writeFile(wb, `Interview_${target}.xlsx`);
}

function exportInterviewToWord() {
    const target = { 'sm': 'S&M', 'gate': 'GATE', 'eis': 'EIS', 'sme': 'SME' }[rankingTab];
    const title = `แบบบันทึกคะแนนสอบคัดเลือก (รอบปฏิบัติ) โครงการ ${target}`;
    const docContent = `<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'><head><meta charset='utf-8'><title>${title}</title><body><h2 style="text-align:center">${title}</h2><p style="text-align:center">โปรดใช้ Excel สำหรับข้อมูลที่สมบูรณ์</p></body></html>`;
    const blob = new Blob(['\ufeff', docContent], { type: 'application/msword' });
    const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download = `${title}.doc`; document.body.appendChild(link); link.click(); document.body.removeChild(link);
}

// --- Init ---
window.onload = async function() {
    showLoading('กำลังโหลดข้อมูล...');
    await window.dataSdk.init(dataHandler);
    hideLoading();
    render();
};
</script>
</body>
</html>
