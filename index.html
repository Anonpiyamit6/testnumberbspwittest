<!doctype html>
<html lang="th" class="h-full">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ระบบประกาศผลคะแนน</title>

<script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Sarabun:ital,wght@0,300;0,400;0,500;0,600;0,700;0,800;1,400&display=swap" rel="stylesheet">

<style>
    /* บังคับใช้ฟอนต์ Sarabun กับทุก Elements ในหน้าเว็บ */
    * {
        font-family: 'Sarabun', sans-serif !important;
    }

    /* ปรับแต่งตัวเลขให้สวยงามและอ่านง่าย */
    body, html, input, textarea, select, button, table, th, td, span, div, p, h1, h2, h3, h4, h5, h6 {
        font-family: 'Sarabun', sans-serif !important;
    }

    /* แก้ไขปัญหาตัวเลขใน Input ไม่ยอมเปลี่ยนฟอนต์ในบาง Browser */
    input[type="number"], input[type="text"] {
        font-family: 'Sarabun', sans-serif !important;
        font-variant-numeric: tabular-nums; /* จัดตัวเลขให้ตรงแนวกัน */
    }
    
    /* ยกเลิกฟอนต์ Mono เดิม (ถ้ามี) ให้กลับมาใช้ Sarabun */
    .font-mono {
        font-family: 'Sarabun', sans-serif !important;
    }
</style>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&amp;display=swap" rel="stylesheet">

<style>
body { box-sizing: border-box; font-family: 'Sarabun', sans-serif; background-color: #f0fdf4; color: #4b5563; -webkit-tap-highlight-color: transparent; }
.gradient-bg { background-color: #C6E686; } 
.btn-primary { background: linear-gradient(135deg, #fcd34d 0%, #fbbf24 100%); color: #78350f; transition: all 0.2s ease; cursor: pointer; }
.btn-primary:active { transform: scale(0.96); }
.card-hover { background-color: white; transition: all 0.3s ease; border: 1px solid #e5e7eb; }
.input-field { background-color: #f9fafb; border: 1px solid #e5e7eb; transition: all 0.2s ease; }
.input-field:focus { background-color: white; border-color: #C6E686; box-shadow: 0 0 0 3px rgba(198, 230, 134, 0.4); outline: none; }
.sidebar-btn { width: 100%; text-align: left; padding: 12px 16px; margin-bottom: 8px; border-radius: 12px; display: flex; align-items: center; gap: 12px; color: #4b5563; background: transparent; border: none; cursor: pointer; min-height: 48px; }
.sidebar-btn:active { background-color: #ecfdf5; }
.sidebar-btn.active { background-color: #eefad2; color: #5a7a1a; font-weight: 600; }
@media (hover: hover) { .sidebar-btn:hover { background-color: #f7fee7; color: #5a7a1a; } .card-hover:hover { transform: translateY(-3px); box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1); border-color: #C6E686; } .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(251, 191, 36, 0.4); } }
.clickable-name { cursor: pointer; font-weight: 600; color: #65a30d; text-decoration: underline; text-underline-offset: 2px; }
.modal-overlay { background-color: rgba(255, 255, 255, 0.6); backdrop-filter: blur(8px); }
#student-modal { transition: opacity 0.2s ease; z-index: 100; } 
body.modal-active { overflow: hidden !important; }
#alert-modal, #confirm-modal, #loading-modal { z-index: 200; transition: opacity 0.2s ease; }
.hidden-force { display: none !important; }
.tab-btn { border-bottom: 3px solid transparent; color: #9ca3af; padding: 12px 16px; transition: all 0.2s; white-space: nowrap; cursor: pointer; }
.tab-btn.active { border-bottom: 3px solid #84cc16; color: #4d7c0f; font-weight: bold; background-color: #f7fee7; }
/* นำเข้าฟอนต์ Sarabun จาก Google Fonts (ตัวแทน TH Sarabun New บนเว็บ) */
@import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap');

/* --- ตั้งค่าสำหรับการพิมพ์ (PDF ราชการ) --- */
@media print {
    @page { 
        size: A4 portrait; 
        margin: 2cm; /* ขอบกระดาษมาตรฐาน */
    }

    /* ล้างค่าสีและพื้นหลังทั้งหมด */
    body, #app { 
        background-color: white !important; 
        font-family: 'Sarabun', sans-serif !important;
        color: black !important;
    }

    /* ซ่อน UI ที่ไม่จำเป็น */
    #sidebar, #sidebar-overlay, .no-print, button, input, 
    .shadow-sm, .shadow-lg, .shadow-xl, .rounded-3xl, .rounded-xl {
        display: none !important; 
        box-shadow: none !important;
        border: none !important;
        border-radius: 0 !important;
    }

    /* บังคับแสดง Header/Footer ของกระดาษ */
    #print-header, .print-footer { display: block !important; }

    /* ปรับตารางให้เป็นเส้นดำ ราชการ */
    .bg-white { background-color: transparent !important; border: none !important; }
    .border-gray-100, .border-b { border: none !important; }
    
    table {
        width: 100% !important;
        border-collapse: collapse !important;
        border: 1px solid black !important;
        font-size: 14pt !important; /* ขนาดตัวอักษรราชการ */
    }

    th {
        border: 1px solid black !important;
        background-color: transparent !important; /* ลบสีเทาหัวตารางออก */
        color: black !important;
        text-align: center !important;
        font-weight: bold !important;
        padding: 5px !important;
    }

    td {
        border: 1px solid black !important;
        padding: 5px !important;
        color: black !important;
        vertical-align: top !important;
    }

    /* แปลงป้ายสถานะ (Badge) ให้เป็นข้อความธรรมดา */
    .rounded-full {
        background-color: transparent !important;
        color: black !important;
        border: none !important;
        padding: 0 !important;
        font-weight: normal !important;
    }
    
    /* ลบสีพื้นหลังแถว */
    tr.bg-green-50\/50, tr.hover\:bg-gray-100 {
        background-color: transparent !important;
    }
}
</style>

<script>
// -----------------------------------------------------------
// ตั้งค่า URL ของ Google Apps Script Web App ที่ได้จากการ Deploy
// -----------------------------------------------------------
const API_URL = "https://script.google.com/macros/s/AKfycbzkDOBBuhB-erTc_36OJ3kqVpUE7mh1JpEmSwDfVJMXgpALiLPZ40c470dBODmPQZVOsA/exec"

async function callApi(action, data = {}) {
const body = JSON.stringify({ action, ...data });
const response = await fetch(API_URL, {
method: 'POST',
body: body,
// สำคัญ: ใช้ text/plain เพื่อหลีกเลี่ยง CORS preflight issues ของ Google Apps Script
headers: { "Content-Type": "text/plain;charset=utf-8" } 
});
return await response.json();
}

window.dataSdk = {
init: async (handler) => { window.dataSdkHandler = handler; await window.dataSdk.refresh(); return { isOk: true }; },
refresh: async () => { 
try {
const res = await callApi('getAllStudents');
if (res.success) { 
const mappedData = res.students.map(s => ({ ...s, __backendId: s.id })); 
if (window.dataSdkHandler?.onDataChanged) window.dataSdkHandler.onDataChanged(mappedData); 
return { isOk: true, data: mappedData }; 
} 
return { isOk: false, error: { message: res.message } };
} catch(e) { return { isOk: false, error: { message: e.message } }; }
},
create: async (data) => {
try {
const res = await callApi('createStudent', { data });
if(res.success) { await window.dataSdk.refresh(); return { isOk: true }; }
return { isOk: false, error: { message: res.message } };
} catch(e) { return { isOk: false, error: { message: e.message } }; }
},
createBulk: async (dataArray) => {
try {
const res = await callApi('createStudentsBulk', { data: dataArray });
if(res.success) { await window.dataSdk.refresh(); return { isOk: true }; }
return { isOk: false, error: { message: res.message } };
} catch(e) { return { isOk: false, error: { message: e.message } }; }
},
updateScoresBulk: async (dataArray) => {
try {
const res = await callApi('updateScoresBulk', { data: dataArray });
if(res.success) { await window.dataSdk.refresh(); return { isOk: true, message: res.message }; }
return { isOk: false, error: { message: res.message } };
} catch(e) { return { isOk: false, error: { message: e.message } }; }
},
update: async (data) => {
try {
const updateData = { ...data, id: data.__backendId };
const res = await callApi('updateStudent', { data: updateData });
if(res.success) { await window.dataSdk.refresh(); return { isOk: true }; }
return { isOk: false, error: { message: res.message } };
} catch(e) { return { isOk: false, error: { message: e.message } }; }
},
delete: async (data) => {
try {
const res = await callApi('deleteStudent', { id: data.__backendId });
if(res.success) { await window.dataSdk.refresh(); return { isOk: true }; }
return { isOk: false, error: { message: res.message } };
} catch(e) { return { isOk: false, error: { message: e.message } }; }
},
deleteBulk: async (ids) => {
try {
const res = await callApi('deleteStudentsBulk', { ids });
if(res.success) { await window.dataSdk.refresh(); return { isOk: true }; }
return { isOk: false, error: { message: res.message } };
} catch(e) { return { isOk: false, error: { message: e.message } }; }
}
};
</script>
</head>
<body class="h-full">
<div id="app" class="h-full w-full"></div>

<div id="student-modal" class="hidden-force fixed inset-0 flex items-center justify-center z-[100]">
    <div class="modal-overlay absolute w-full h-full" onclick="closeModal()"></div>
    <div class="bg-white w-full h-full md:w-11/12 md:h-auto md:max-w-4xl md:max-h-[90vh] md:rounded-[2rem] shadow-2xl z-[101] flex flex-col border border-lime-100 relative transform transition-all">
        
        <div class="flex justify-between items-center px-6 py-4 bg-gradient-to-r from-lime-50 to-white border-b border-lime-100 shrink-0">
            <div class="flex items-center gap-3">
                <div class="p-2 bg-lime-100 rounded-full text-lime-600"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg></div>
                <p class="text-lg md:text-xl font-bold text-lime-800" id="modal-title">จัดการข้อมูล</p>
            </div>
            <button type="button" class="text-gray-400 hover:text-red-500 p-2 rounded-full active:bg-gray-100" onclick="closeModal()"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
        </div>

        <div id="add-mode-tabs" class="flex px-4 border-b border-gray-100 bg-gray-50/50 hidden overflow-x-auto shrink-0">
            <button type="button" onclick="switchAddTab('single')" id="tab-single" class="tab-btn active flex-1 md:flex-none">เพิ่มทีละคน</button>
            <button type="button" onclick="switchAddTab('multiple')" id="tab-multiple" class="tab-btn flex-1 md:flex-none">เพิ่มหลายคน</button>
            <button type="button" onclick="switchAddTab('excel')" id="tab-excel" class="tab-btn flex-1 md:flex-none">Import ชื่อ</button>
            <button type="button" onclick="switchAddTab('score')" id="tab-score" class="tab-btn flex-1 md:flex-none text-purple-600 font-bold">Import คะแนน</button>
            <button type="button" onclick="switchAddTab('practical')" id="tab-practical" class="tab-btn flex-1 md:flex-none text-indigo-600 font-bold">Import ปฏิบัติ</button>
        </div>

        <div class="overflow-y-auto p-4 md:p-8 flex-1 bg-white">

            <div id="view-single" class="block pb-20 md:pb-0">
                <form id="student-form" onsubmit="handleSingleSubmit(event)">
                    <input type="hidden" id="student-backend-id">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6 mb-4">
                        <div><label class="block text-gray-500 text-xs font-bold mb-2 uppercase">เลขบัตรประชาชน (13 หลัก)</label><input type="text" id="form-national-id" class="w-full px-4 py-3 rounded-xl border-gray-200 focus:border-lime-400 input-field" placeholder="00xxxxxxxxxxx" required></div>
                        <div><label class="block text-gray-500 text-xs font-bold mb-2 uppercase">รหัสประจำตัวสอบ</label><input type="text" id="form-exam-id" class="w-full px-4 py-3 rounded-xl border-gray-200 input-field" required></div>
                        <div><label class="block text-gray-500 text-xs font-bold mb-2 uppercase">ระดับชั้น</label><select id="form-grade" class="w-full px-4 py-3 rounded-xl border-gray-200 input-field bg-white"><option value="p4">ประถมศึกษาปีที่ 4</option><option value="p5">ประถมศึกษาปีที่ 5</option><option value="p6">ประถมศึกษาปีที่ 6</option><option value="m1">มัธยมศึกษาปีที่ 1</option><option value="m3">มัธยมศึกษาปีที่ 3</option><option value="m4">มัธยมศึกษาปีที่ 4</option></select></div>
                        <div><label class="block text-gray-500 text-xs font-bold mb-2 uppercase">ชื่อ-นามสกุล</label><input type="text" id="form-name" class="w-full px-4 py-3 rounded-xl border-gray-200 input-field" required></div>
                        <div class="md:col-span-2"><label class="block text-gray-500 text-xs font-bold mb-2 uppercase">โรงเรียนปัจจุบัน</label><input type="text" id="form-school" class="w-full px-4 py-3 rounded-xl border-gray-200 input-field"></div>
                    </div>

                    <div class="bg-lime-50/50 p-4 rounded-2xl border border-lime-100 mb-4">
                        <h3 class="text-sm font-bold text-lime-700 mb-3 uppercase flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path></svg>
                            ลำดับโครงการที่เลือก
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                            <div>
                                <label class="text-[10px] text-gray-500 font-bold uppercase mb-1 block">อันดับ 1</label>
                                <select id="form-choice-1" class="w-full px-3 py-2 rounded-lg border-gray-200 text-sm input-field bg-white">
                                    <option value="">- ไม่ระบุ -</option>
                                    <optgroup label="ม.1"><option value="S&M">S&M</option><option value="GATE">GATE</option><option value="EIS">EIS</option></optgroup>
                                    <optgroup label="ม.4"><option value="SME">SME</option><option value="GATE">GATE</option></optgroup>
                                </select>
                            </div>
                            <div>
                                <label class="text-[10px] text-gray-500 font-bold uppercase mb-1 block">อันดับ 2</label>
                                <select id="form-choice-2" class="w-full px-3 py-2 rounded-lg border-gray-200 text-sm input-field bg-white">
                                    <option value="">- ไม่ระบุ -</option>
                                    <optgroup label="ม.1"><option value="S&M">S&M</option><option value="GATE">GATE</option><option value="EIS">EIS</option></optgroup>
                                    <optgroup label="ม.4"><option value="SME">SME</option><option value="GATE">GATE</option></optgroup>
                                </select>
                            </div>
                            <div>
                                <label class="text-[10px] text-gray-500 font-bold uppercase mb-1 block">อันดับ 3</label>
                                <select id="form-choice-3" class="w-full px-3 py-2 rounded-lg border-gray-200 text-sm input-field bg-white">
                                    <option value="">- ไม่ระบุ -</option>
                                    <optgroup label="ม.1"><option value="S&M">S&M</option><option value="GATE">GATE</option><option value="EIS">EIS</option></optgroup>
                                    <optgroup label="ม.4"><option value="SME">SME</option><option value="GATE">GATE</option></optgroup>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div id="score-section" class="bg-amber-50/50 p-4 md:p-6 rounded-2xl border border-amber-100">
                        <h3 class="text-sm font-bold text-amber-600 mb-4 uppercase">คะแนนสอบ</h3>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-3 md:gap-4">
                            <div><label class="text-xs text-gray-500 font-semibold">วิทยาศาสตร์ (40)</label><input type="number" step="0.01" id="score-science" class="w-full px-3 py-2 rounded-lg border-gray-200 text-center font-bold text-lime-600 input-field"></div>
                            <div><label class="text-xs text-gray-500 font-semibold">คณิตศาสตร์ (30)</label><input type="number" step="0.01" id="score-math" class="w-full px-3 py-2 rounded-lg border-gray-200 text-center font-bold text-lime-600 input-field"></div>
                            <div><label class="text-xs text-gray-500 font-semibold">ภาษาอังกฤษ (30)</label><input type="number" step="0.01" id="score-english" class="w-full px-3 py-2 rounded-lg border-gray-200 text-center font-bold text-lime-600 input-field"></div>
                        </div>
                    </div>

                    <div class="flex justify-end pt-6 gap-3 md:relative fixed bottom-0 left-0 w-full bg-white p-4 border-t border-gray-100 md:border-0 md:bg-transparent md:p-0 z-10">
                        <button type="button" onclick="closeModal()" class="flex-1 md:flex-none px-6 py-3 bg-gray-100 text-gray-600 rounded-xl font-bold">ยกเลิก</button>
                        <button type="submit" class="flex-1 md:flex-none px-8 py-3 btn-primary rounded-xl font-bold shadow-lg shadow-amber-200/50">บันทึก</button>
                    </div>
                </form>
            </div>

            <div id="view-multiple" class="hidden h-full flex flex-col">
                <div class="flex-1 overflow-auto border border-gray-100 rounded-xl mb-4 shadow-inner bg-gray-50/50">
                    <table class="w-full text-sm text-left text-gray-500" id="multiple-table"><thead class="text-xs text-gray-500 uppercase bg-gray-100 sticky top-0"><tr><th class="px-2 py-3">เลขบัตร</th><th class="px-2 py-3">รหัส</th><th class="px-2 py-3">ชื่อ</th><th class="px-2 py-3">ชั้น</th><th class="px-2 py-3">รร.</th><th class="px-1 py-3">ลบ</th></tr></thead><tbody id="multiple-tbody" class="bg-white"></tbody></table>
                </div>
                <div class="flex justify-between items-center bg-white p-2 rounded-lg gap-2">
                    <button type="button" onclick="addMultipleRow()" class="flex-1 text-lime-600 font-bold bg-lime-50 px-3 py-3 rounded-lg">+ เพิ่มแถว</button>
                    <button type="button" onclick="handleMultipleSubmit()" class="flex-1 btn-primary px-3 py-3 rounded-lg font-bold text-yellow-900 shadow-md">บันทึก</button>
                </div>
            </div>

            <div id="view-excel" class="hidden">
                <div class="border-2 border-dashed border-lime-200 bg-lime-50/30 rounded-2xl p-6 md:p-10 text-center hover:bg-lime-50 transition-colors cursor-pointer" id="drop-zone-name">
                    <div class="w-16 h-16 bg-lime-100 text-lime-500 rounded-full flex items-center justify-center mx-auto mb-4"><svg class="h-8 w-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg></div>
                    <label for="excel-upload-name" class="cursor-pointer block"><span class="block text-lg font-bold text-lime-700">เลือกไฟล์ Excel (รายชื่อ)</span><span class="block text-sm text-lime-500 mt-1">.xlsx หรือ .xls</span><input id="excel-upload-name" type="file" class="hidden" accept=".xlsx, .xls" onchange="handleExcelUpload(this, 'student')"></label>
                </div>
                <div class="mt-6 bg-amber-50 p-6 rounded-2xl border border-amber-100">
                    <h4 class="font-bold text-amber-700 mb-2">คำแนะนำไฟล์ Excel</h4><ul class="text-sm text-amber-800 space-y-1 ml-7 list-disc"><li>A: รหัสสอบ</li><li>B: เลขบัตรฯ (00 ได้)</li><li>C: ชื่อ-นามสกุล</li><li>D: ระดับชั้น (p6, m3)</li><li>E: โรงเรียนปัจจุบัน</li></ul>
                </div>
                <div id="excel-preview-area" class="mt-6 hidden">
                    <div class="flex justify-between items-center mb-3"><h4 class="font-bold text-gray-700 text-sm">ข้อมูล (<span id="excel-count">0</span> คน)</h4><button type="button" onclick="confirmExcelImport('student')" class="px-4 py-2 btn-primary rounded-lg font-bold text-sm shadow-md">ยืนยัน</button></div>
                    <div class="overflow-auto max-h-48 border border-gray-200 rounded-xl text-xs bg-white"><table class="w-full text-left" id="excel-preview-table"></table></div>
                </div>
            </div>

            <div id="view-score" class="hidden">
                <div class="border-2 border-dashed border-purple-200 bg-purple-50/30 rounded-2xl p-6 md:p-10 text-center hover:bg-purple-50 transition-colors cursor-pointer" id="drop-zone-score">
                    <div class="w-16 h-16 bg-purple-100 text-purple-500 rounded-full flex items-center justify-center mx-auto mb-4"><svg class="h-8 w-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg></div>
                    <label for="excel-upload-score" class="cursor-pointer block"><span class="block text-lg font-bold text-purple-700">เลือกไฟล์ Excel (คะแนน)</span><span class="block text-sm text-purple-500 mt-1">.xlsx หรือ .xls</span><input id="excel-upload-score" type="file" class="hidden" accept=".xlsx, .xls" onchange="handleExcelUpload(this, 'score')"></label>
                </div>
                <div class="mt-6 bg-purple-50 p-6 rounded-2xl border border-purple-100">
                    <h4 class="font-bold text-purple-700 mb-2">คำแนะนำไฟล์คะแนน</h4><ul class="text-sm text-purple-800 space-y-1 ml-7 list-disc"><li>A: รหัสสอบ (ตรงกับในระบบ)</li><li>B: วิทยาศาสตร์ (เต็ม 40)</li><li>C: คณิตศาสตร์ (เต็ม 30)</li><li>D: ภาษาอังกฤษ (เต็ม 30)</li></ul>
                </div>
                <div id="score-preview-area" class="mt-6 hidden">
                    <div class="flex justify-between items-center mb-3"><h4 class="font-bold text-gray-700 text-sm">ข้อมูลคะแนน (<span id="score-count">0</span> คน)</h4><button type="button" onclick="confirmExcelImport('score')" class="px-4 py-2 bg-purple-500 text-white rounded-lg font-bold text-sm shadow-md hover:bg-purple-600">อัปเดตคะแนน</button></div>
                    <div class="overflow-auto max-h-48 border border-gray-200 rounded-xl text-xs bg-white"><table class="w-full text-left" id="score-preview-table"></table></div>
                </div>
            </div>

            <div id="view-practical" class="hidden">
                <div class="border-2 border-dashed border-indigo-200 bg-indigo-50/30 rounded-2xl p-6 md:p-10 text-center hover:bg-indigo-50 transition-colors cursor-pointer" id="drop-zone-practical">
                    <div class="w-16 h-16 bg-indigo-100 text-indigo-500 rounded-full flex items-center justify-center mx-auto mb-4">
                        <svg class="h-8 w-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    </div>
                    <label for="excel-upload-practical" class="cursor-pointer block">
                        <span class="block text-lg font-bold text-indigo-700">เลือกไฟล์ Excel (คะแนนปฏิบัติ)</span>
                        <span class="block text-sm text-indigo-500 mt-1">.xlsx หรือ .xls</span>
                        <input id="excel-upload-practical" type="file" class="hidden" accept=".xlsx, .xls" onchange="handleExcelUpload(this, 'practical')">
                    </label>
                </div>
                <div class="mt-6 bg-indigo-50 p-6 rounded-2xl border border-indigo-100">
                    <h4 class="font-bold text-indigo-700 mb-2">คำแนะนำไฟล์ Excel</h4>
                    <ul class="text-sm text-indigo-800 space-y-1 ml-7 list-disc">
                        <li>A: รหัสประจำตัวสอบ (ต้องตรงกับในระบบ)</li>
                        <li>B: คะแนนสอบปฏิบัติ (ตัวเลข)</li>
                    </ul>
                </div>
                <div id="practical-preview-area" class="mt-6 hidden">
                    <div class="flex justify-between items-center mb-3">
                        <h4 class="font-bold text-gray-700 text-sm">รายการที่พบ (<span id="practical-count">0</span> คน)</h4>
                        <button type="button" onclick="confirmExcelImport('practical')" class="px-4 py-2 bg-indigo-600 text-white rounded-lg font-bold text-sm shadow-md hover:bg-indigo-700">ยืนยันนำเข้า</button>
                    </div>
                    <div class="overflow-auto max-h-48 border border-gray-200 rounded-xl text-xs bg-white">
                        <table class="w-full text-left" id="practical-preview-table"></table>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>
<script>
// Config พร้อมชื่อโรงเรียนตัวไม่หนา
const defaultConfig = { 
system_title: "ระบบประกาศผลคะแนน<br>การสอบแข่งขันทักษะวิชาการเพชรราชพฤกษ์<br><span class='text-sm font-normal'>โรงเรียนบางสะพานวิทยา จังหวัดประจวบคีรีขันธ์</span>", 
admission_year: "2569", 
primary_color: "#C6E686", 
secondary_color: "#fbbf24", 
background_color: "#f0fdf4", 
text_color: "#374151", 
surface_color: "#ffffff" 
};

let currentUser = null, currentView = 'login', adminTab = 'm1', studentsData = [], searchQuery = '', formMode = 'create', excelDataCache = [], scoreDataCache = [], confirmCallback = null, isSidebarOpen = false, checkedIds = new Set();
// --- เพิ่มต่อจากตัวแปรเดิม ---
// adminViewMode: 'manage' (จัดการข้อมูล), 'ranking' (ดูผลจัดลำดับ)
// rankingTab: 'all' (รวม), 'sm', 'gate', 'eis' (สำหรับ ม.1) หรือ 'sme', 'gate' (สำหรับ ม.4)
let adminViewMode = 'manage', rankingTab = 'all';
// เพิ่มตัวนี้เข้าไป
let practicalDataCache = [];

// กำหนดโควตาการรับสมัคร (แก้ไขตัวเลขได้ที่นี่)
const quotas = {
    m1: { 'S&M': 80, 'GATE': 60, 'EIS': 60 },
    m4: { 'SME': 80, 'GATE': 60 } // สมมติของ ม.4 ไว้ก่อน
};
  // คะแนนเต็มภาคปฏิบัติของแต่ละโครงการ
const practicalMaxScores = {
    'S&M': 20,   // ม.1 S&M (เต็ม 20) -> รวม 120
    'GATE': 100, // GATE (เต็ม 100) -> รวม 200
    'EIS': 100,  // EIS (เต็ม 100) -> รวม 200
    'SME': 100   // SME (เต็ม 100) -> รวม 200
};
function getThaiGrade(code) { const map = { 'p4': 'ประถมศึกษาปีที่ 4', 'p5': 'ประถมศึกษาปีที่ 5', 'p6': 'ประถมศึกษาปีที่ 6', 'm3': 'มัธยมศึกษาปีที่ 3' }; return map[code.toLowerCase()] || code; }
function toggleSidebar() { const sb=document.getElementById('sidebar'), ov=document.getElementById('sidebar-overlay'); isSidebarOpen=!isSidebarOpen; if(isSidebarOpen){sb.classList.remove('-translate-x-full');ov.classList.remove('hidden');}else{sb.classList.add('-translate-x-full');ov.classList.add('hidden');} }

function showAlert(t, m) { document.getElementById('alert-title').textContent = t; document.getElementById('alert-message').textContent = m; document.getElementById('alert-modal').classList.remove('hidden-force'); }
function closeAlert() { document.getElementById('alert-modal').classList.add('hidden-force'); }
function showConfirm(t, m, cb) { document.getElementById('confirm-title').textContent = t; document.getElementById('confirm-message').textContent = m; confirmCallback = cb; document.getElementById('confirm-modal').classList.remove('hidden-force'); }
function closeConfirm() { document.getElementById('confirm-modal').classList.add('hidden-force'); confirmCallback = null; }
function confirmAction() { if(confirmCallback) confirmCallback(); closeConfirm(); }
function showLoading(msg) { document.getElementById('loading-message').textContent = msg; document.getElementById('loading-modal').classList.remove('hidden-force'); }
function hideLoading() { document.getElementById('loading-modal').classList.add('hidden-force'); }
function openModal() { document.getElementById('student-modal').classList.remove('hidden-force'); document.body.classList.add('modal-active'); }
function closeModal() { document.getElementById('student-modal').classList.add('hidden-force'); document.body.classList.remove('modal-active'); }

const dataHandler = { onDataChanged(data) { studentsData = data.sort((a, b) => b.total_score - a.total_score); let m1 = studentsData.filter(s => ['p4','p5','p6','m1'].includes(s.grade_level)); let m4 = studentsData.filter(s => ['m3','m4'].includes(s.grade_level)); m1.forEach((s, i) => s.rank = i+1); m4.forEach((s, i) => s.rank = i+1); if (currentView === 'admin') renderAdminDashboard(); else if (currentView === 'student' && currentUser) { const u = studentsData.find(s => String(s.national_id) === String(currentUser.national_id)); if(u) currentUser = u; renderStudentView(); } } };
function render() { const app = document.getElementById('app'); if(currentView === 'login') renderLogin(); else if(currentView === 'admin') renderAdminDashboard(); else renderStudentView(); }

function toggleAllCheckboxes(source) { const checkboxes = document.querySelectorAll('.row-checkbox'); checkboxes.forEach(cb => { cb.checked = source.checked; if(source.checked) checkedIds.add(cb.value); else checkedIds.delete(cb.value); }); updateDeleteButton(); }
function toggleCheckbox(id) { const cb = document.querySelector(`.row-checkbox[value="${id}"]`); if(cb.checked) checkedIds.add(id); else checkedIds.delete(id); updateDeleteButton(); }
function updateDeleteButton() { const btn = document.getElementById('btn-bulk-delete'); if(checkedIds.size > 0) { btn.classList.remove('hidden'); document.getElementById('selected-count').textContent = checkedIds.size; } else { btn.classList.add('hidden'); } }
function executeBulkDelete() { if(checkedIds.size === 0) return; showConfirm('ยืนยันลบหมู่', `ต้องการลบข้อมูล ${checkedIds.size} รายการหรือไม่?`, () => { showLoading(`กำลังลบ ${checkedIds.size} รายการ...`); window.dataSdk.deleteBulk(Array.from(checkedIds)).then(res => { setTimeout(() => { hideLoading(); checkedIds.clear(); if(res.isOk) { showAlert('สำเร็จ', 'ลบข้อมูลเรียบร้อยแล้ว'); } else { showAlert('ผิดพลาด', res.error.message); } }, 500); }); }); }

// ---------------------------------------------
// RENDER LOGIN: พื้นหลัง #B2B2B2 และข้อความเรียงบรรทัด
// ---------------------------------------------
function renderLogin() {
const config = window.elementSdk?.config || defaultConfig;
document.getElementById('app').innerHTML = `
<div class="h-full w-full bg-[#B2B2B2] flex flex-col items-center justify-center p-4 overflow-auto">

<div class="w-full max-w-md bg-white rounded-[2rem] shadow-xl p-8 relative overflow-hidden shrink-0">

<div class="absolute -top-10 -right-10 w-32 h-32 bg-yellow-100 rounded-full opacity-50 blur-xl"></div>
<div class="absolute -bottom-10 -left-10 w-32 h-32 bg-green-100 rounded-full opacity-50 blur-xl"></div>

<div class="text-center mb-8 relative z-10">
<div class="mx-auto mb-6"><img src="https://img2.pic.in.th/pic/-69-1.png" alt="โลโก้โรงเรียน" class="h-32 w-auto mx-auto object-contain drop-shadow-md"></div>

<div class="text-gray-900 font-bold text-lg md:text-xl whitespace-nowrap leading-tight">
ระบบประกาศผลคะแนน
</div>

<div class="text-gray-900 font-bold whitespace-nowrap mt-1 leading-tight -mx-6 px-1
text-[13px] min-[360px]:text-[14.5px] min-[390px]:text-[16px] sm:text-xl sm:mx-0">
การสอบแข่งขันทักษะวิชาการเพชรราชพฤกษ์
</div>

<p class="text-gray-600 text-xs sm:text-sm font-normal mt-2">
โรงเรียนบางสะพานวิทยา จังหวัดประจวบคีรีขันธ์
</p>

<p class="text-gray-400 mt-4 text-sm">ปีการศึกษา <span class="text-lime-600 font-bold">${config.admission_year}</span></p>
</div>

<div class="space-y-3 mb-6 relative z-10" id="login-buttons">
<button type="button" onclick="toggleLogin('student')" class="w-full py-4 px-6 rounded-2xl border-2 border-lime-300 text-lime-700 font-bold hover:bg-lime-50 active:scale-95 transition-all flex items-center justify-center gap-3 shadow-sm"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>ผู้เข้าสอบ</button>
<button type="button" onclick="toggleLogin('admin')" class="w-full py-4 px-6 rounded-2xl border-2 border-amber-200 text-amber-500 font-bold hover:bg-amber-50 active:scale-95 transition-all flex items-center justify-center gap-3 shadow-sm"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>สำหรับแอดมิน</button>
</div>

<div id="login-form-container" class="hidden relative z-10 bg-gray-50/80 p-5 rounded-2xl border border-gray-100">
<form onsubmit="handleLogin(event)" class="space-y-4">
<div id="input-student" class="hidden"><label class="block text-xs font-bold text-gray-500 mb-2 uppercase">เลขบัตรประชาชน 13 หลัก</label><input type="text" id="login-id" class="w-full px-4 py-3 rounded-xl border-gray-200 focus:border-lime-400 focus:ring-2 focus:ring-lime-100 outline-none transition-all input-field" placeholder="กรอกเลขบัตรประชาชน"></div>
<div id="input-admin" class="hidden space-y-3">
<div><label class="block text-xs font-bold text-gray-500 mb-2 uppercase">ชื่อผู้ใช้</label><input type="text" id="admin-user" class="w-full px-4 py-3 rounded-xl border-gray-200 focus:border-amber-300 focus:ring-2 focus:ring-amber-100 outline-none transition-all input-field" placeholder="Admin Username"></div>
<div><label class="block text-xs font-bold text-gray-500 mb-2 uppercase">รหัสผ่าน</label><input type="password" id="admin-pass" class="w-full px-4 py-3 rounded-xl border-gray-200 focus:border-amber-300 focus:ring-2 focus:ring-amber-100 outline-none transition-all input-field" placeholder="••••••••"></div>
</div>
<div class="flex gap-2 pt-2"><button type="button" onclick="resetLogin()" class="px-4 py-3 bg-gray-200 text-gray-600 rounded-xl font-bold text-sm">กลับ</button><button type="submit" class="flex-1 py-3 btn-primary rounded-xl font-bold shadow-lg shadow-amber-100 transition-all text-sm">เข้าสู่ระบบ</button></div>
</form>
</div>
</div>

<div class="mt-6 text-center animate-pulse">
<p class="text-xs text-white font-medium drop-shadow-md bg-black/10 px-3 py-1 rounded-full">พัฒนาระบบโดย ครูอานนท์ เมืองแก้ว</p>
</div>

</div>
`;
}

function toggleLogin(mode) { document.getElementById('login-buttons').classList.add('hidden'); document.getElementById('login-form-container').classList.remove('hidden'); if(mode==='student'){document.getElementById('input-student').classList.remove('hidden');document.getElementById('input-admin').classList.add('hidden');}else{document.getElementById('input-student').classList.add('hidden');document.getElementById('input-admin').classList.remove('hidden');} }
function resetLogin() { document.getElementById('login-form-container').classList.add('hidden'); document.getElementById('login-buttons').classList.remove('hidden'); }
function handleLogin(e) { e.preventDefault(); const isStudent = !document.getElementById('input-student').classList.contains('hidden'); if(isStudent){ const id = document.getElementById('login-id').value.trim(); const user = studentsData.find(s => String(s.national_id).trim() === String(id)); if(user){currentUser = user; currentView = 'student'; render();}else showAlert('ไม่พบข้อมูล', 'ไม่พบเลขบัตรประชาชนนี้ในระบบ'); }else{ if(document.getElementById('admin-user').value === 'admin' && document.getElementById('admin-pass').value === 'admin11275'){currentView='admin';render();}else showAlert('ผิดพลาด', 'ชื่อผู้ใช้หรือรหัสผ่านผิด'); } }

function renderAdminDashboard() {
    // 1. กรองนักเรียนตามระดับชั้น (ม.1 หรือ ม.4)
    const m1 = studentsData.filter(s => ['p4','p5','p6','m1'].includes(s.grade_level));
    const m4 = studentsData.filter(s => ['m3','m4'].includes(s.grade_level));
    let activeData = adminTab === 'm1' ? m1 : m4;

    // 2. Logic การกรองข้อมูลสำหรับหน้า Manage
    let displayData = activeData;
    if(adminViewMode === 'manage') {
        if(searchQuery) displayData = displayData.filter(s => s.full_name.includes(searchQuery) || String(s.exam_id).includes(searchQuery) || String(s.national_id).includes(searchQuery));
    }
    checkedIds.clear();

    // 3. เริ่มต้น Render HTML
    document.getElementById('app').innerHTML = `
    <div class="h-full flex flex-col md:flex-row overflow-hidden bg-[#f8fafc]">
        
        <div class="md:hidden bg-white p-4 shadow-sm flex justify-between items-center z-20 shrink-0 border-b border-gray-100">
            <div class="flex items-center gap-2"><h2 class="font-bold text-gray-700">ระบบแอดมิน</h2></div>
            <button onclick="toggleSidebar()" class="p-2 text-gray-500 rounded-lg"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg></button>
        </div>
        <div id="sidebar-overlay" class="fixed inset-0 bg-black/30 z-30 hidden md:hidden backdrop-blur-sm transition-opacity" onclick="toggleSidebar()"></div>
        
        <div id="sidebar" class="fixed inset-y-0 left-0 z-40 w-64 bg-white flex flex-col p-6 shadow-xl transform -translate-x-full transition-transform duration-300 md:translate-x-0 md:static">
            <div class="hidden md:flex mb-8 px-2 items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-lime-100 flex items-center justify-center text-lime-600 font-bold">AD</div>
                <h2 class="text-lg font-bold text-gray-700">Admin Panel</h2>
            </div>
            
            <div class="space-y-6 flex-1">
                <div>
                    <p class="text-xs font-bold text-gray-400 uppercase mb-3 px-2">เลือกกลุ่มข้อมูล</p>
                    <button class="sidebar-btn ${adminTab==='m1'?'active':''}" onclick="adminTab='m1';renderAdminDashboard();"><span class="w-2 h-2 rounded-full ${adminTab==='m1'?'bg-lime-500':'bg-gray-300'}"></span> ข้อมูล ม.1 (เข้าเรียน)</button>
                    <button class="sidebar-btn ${adminTab==='m4'?'active':''}" onclick="adminTab='m4';renderAdminDashboard();"><span class="w-2 h-2 rounded-full ${adminTab==='m4'?'bg-lime-500':'bg-gray-300'}"></span> ข้อมูล ม.4 (เข้าเรียน)</button>
                </div>

                <div>
                    <p class="text-xs font-bold text-gray-400 uppercase mb-3 px-2">เมนูหลัก</p>
                    
                    <button class="sidebar-btn ${adminViewMode==='manage'?'bg-blue-50 text-blue-600 font-bold':''}" onclick="adminViewMode='manage';renderAdminDashboard();">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"></path></svg> จัดการรายชื่อ
                    </button>
                    
                    <button class="sidebar-btn ${adminViewMode==='ranking'?'bg-blue-50 text-blue-600 font-bold':''}" onclick="adminViewMode='ranking';rankingTab='all';renderAdminDashboard();">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg> ประกาศผล/จัดลำดับ
                    </button>

                    <button class="sidebar-btn ${adminViewMode==='interview'?'bg-purple-50 text-purple-600 font-bold':''}" onclick="adminViewMode='interview';rankingTab='all';renderAdminDashboard();">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg> บันทึกคะแนนปฏิบัติ
                    </button>

                    <button class="sidebar-btn border-t border-gray-100 mt-2 pt-4 text-lime-600" onclick="showAddStudentForm();toggleSidebar()"><span class="text-xl font-bold mr-2">+</span> เพิ่มผู้เข้าสอบ</button>
                </div>
            </div>
            <button class="sidebar-btn text-red-400 hover:bg-red-50 mt-auto" onclick="currentView='login';render()">ออกจากระบบ</button>
        </div>

        <div class="flex-1 overflow-auto p-4 md:p-8 w-full bg-[#f8fafc]">
            ${ 
                adminViewMode === 'manage' 
                ? renderManageView(displayData, activeData.length) 
                : (
                    adminViewMode === 'ranking' 
                    ? renderRankingView(activeData) 
                    : renderInterviewView(activeData) // เรียกหน้า Interview ถ้าเลือกเมนูใหม่
                  )
            }
        </div>
    </div>
    `;
}

// --- ฟังก์ชันย่อย 1: แสดงหน้าจัดการข้อมูล (ตารางเดิม) ---
function renderManageView(data, totalCount) {
    return `
    <div class="flex flex-col md:flex-row justify-between md:items-end mb-6 gap-2">
        <div><h1 class="text-2xl md:text-3xl font-bold text-gray-800 mb-1">จัดการข้อมูล ${adminTab==='m1'?'ม.1':'ม.4'}</h1><p class="text-gray-400 text-sm">ทั้งหมด <span class="font-bold text-lime-600">${totalCount}</span> คน</p></div>
    </div>

    <div class="bg-white p-2 rounded-2xl shadow-sm mb-6 flex gap-2">
        <div class="relative flex-1"><input type="text" id="search-input" placeholder="ค้นหาชื่อ, รหัส..." class="w-full pl-10 pr-4 py-3 rounded-xl border-none bg-gray-50 focus:bg-white focus:ring-2 focus:ring-lime-100 transition-all text-gray-600" value="${searchQuery}" onkeydown="if(event.key==='Enter') triggerSearch()"><svg class="w-5 h-5 text-gray-400 absolute left-3 top-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg></div>
        <button onclick="triggerSearch()" class="px-4 md:px-8 bg-lime-400 text-white rounded-xl font-bold shadow-lg shadow-lime-200">ค้นหา</button>
        <button id="btn-bulk-delete" onclick="executeBulkDelete()" class="hidden px-4 md:px-6 bg-red-400 hover:bg-red-500 text-white rounded-xl font-bold shadow-lg shadow-red-200 transition-all flex items-center gap-2"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg><span class="hidden md:inline">ลบ (<span id="selected-count">0</span>)</span></button>
    </div>

    <div class="bg-white rounded-3xl shadow-sm overflow-hidden border border-gray-100">
        <div class="overflow-x-auto">
            <table class="w-full text-left min-w-[800px]">
                <thead class="bg-gray-50 text-gray-600 text-sm uppercase font-bold">
                    <tr>
                        <th class="px-4 py-4 w-10 text-center"><input type="checkbox" onchange="toggleAllCheckboxes(this)" class="custom-checkbox rounded text-lime-500 focus:ring-lime-400"></th>
                        <th class="px-4 py-4">รหัส</th>
                        <th class="px-4 py-4">ชื่อ-สกุล</th>
                        <th class="px-4 py-4 text-center">คะแนนรวม</th>
                        <th class="px-4 py-4">เลือกอันดับ 1</th>
                        <th class="px-4 py-4 text-center">จัดการ</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-50 text-sm">
                    ${data.map(s => `
                    <tr class="hover:bg-gray-50 transition-colors">
                        <td class="px-4 py-4 text-center"><input type="checkbox" value="${s.__backendId}" onchange="toggleCheckbox('${s.__backendId}')" class="row-checkbox custom-checkbox rounded text-lime-500 focus:ring-lime-400"></td>
                        <td class="px-4 py-4 font-mono text-lime-600 font-bold">${s.exam_id}</td>
                        <td class="px-4 py-4 font-medium text-gray-700 cursor-pointer hover:text-lime-600" onclick="showEditForm('${s.__backendId}')">${s.full_name}</td>
                        <td class="px-4 py-4 text-center font-bold ${s.total_score>0?'text-amber-500':'text-gray-200'}">${s.total_score>0 ? s.total_score.toFixed(2) : '-'}</td>
                        <td class="px-4 py-4 text-gray-500">${s.choice_1 || '-'}</td>
                        <td class="px-4 py-4 text-center flex justify-center gap-2">
                            <button onclick="showEditForm('${s.__backendId}')" class="text-lime-500 bg-lime-50 p-2 rounded-lg hover:bg-lime-100"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg></button>
                            <button onclick="deleteStudent('${s.__backendId}')" class="text-red-400 bg-red-50 p-2 rounded-lg hover:bg-red-100"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>
                        </td>
                    </tr>`).join('')}
                </tbody>
            </table>
        </div>
    </div>`;
}

// --- ฟังก์ชันย่อย 2: แสดงหน้าจัดลำดับ (Ranking View) ---
// --- ฟังก์ชันย่อย 2: แสดงหน้าจัดลำดับ (Ranking View) ---
function renderRankingView(allStudents) {
    const sortedAll = [...allStudents].sort((a,b) => b.total_score - a.total_score);
    const currentQuotas = { ...quotas[adminTab] };
    const counts = {};
    Object.keys(currentQuotas).forEach(k => counts[k] = 0);
    const allocationResult = {}; 

    sortedAll.forEach(s => {
        let choices = adminTab === 'm4' ? [s.choice_1, s.choice_2].filter(c=>c) : [s.choice_1, s.choice_2, s.choice_3].filter(c=>c);
        for (const choiceName of choices) {
            if (currentQuotas[choiceName] !== undefined && counts[choiceName] < currentQuotas[choiceName]) {
                allocationResult[s.__backendId] = choiceName;
                counts[choiceName]++;
                break;
            }
        }
    });

    let renderList = [];
    let showQuota = 0;
    
    if (rankingTab === 'all') {
        renderList = sortedAll.map((s, i) => ({ 
            ...s, rank: i+1, status: allocationResult[s.__backendId] ? 'pass' : 'fail', got_program: allocationResult[s.__backendId] || '-'
        }));
    } else {
        const targetProgram = { 'sm': 'S&M', 'gate': 'GATE', 'eis': 'EIS', 'sme': 'SME' }[rankingTab];
        showQuota = (quotas[adminTab] && quotas[adminTab][targetProgram]) || 0;
        renderList = sortedAll.filter(s => {
            if (allocationResult[s.__backendId] === targetProgram) return true;
            const isSelectedHere = (s.choice_1 === targetProgram || s.choice_2 === targetProgram || (adminTab !== 'm4' && s.choice_3 === targetProgram));
            const gotOtherPlace = allocationResult[s.__backendId] !== undefined;
            return isSelectedHere && !gotOtherPlace;
        }).map((s, i) => ({
            ...s, rank: sortedAll.findIndex(x => x.__backendId === s.__backendId) + 1,
            status: allocationResult[s.__backendId] === targetProgram ? 'pass' : 'fail'
        }));
    }

    const tabsM1 = [{ id: 'all', label: 'สรุปภาพรวม' }, { id: 'sm', label: 'S&M (80)' }, { id: 'gate', label: 'GATE (60)' }, { id: 'eis', label: 'EIS (60)' }];
    const tabsM4 = [{ id: 'all', label: 'สรุปภาพรวม' }, { id: 'sme', label: 'SME (80)' }, { id: 'gate', label: 'GATE (60)' }];
    const currentTabs = adminTab === 'm1' ? tabsM1 : tabsM4;

    return `
    <div class="mb-6 flex flex-col md:flex-row justify-between items-start md:items-end gap-4">
        <div>
            <h1 class="text-2xl md:text-3xl font-bold text-gray-800 mb-2">ประกาศผลสอบ (Clearing House) ${adminTab==='m1'?'ม.1':'ม.4'}</h1>
            <div class="flex flex-wrap gap-2">
                ${currentTabs.map(t => `<button onclick="rankingTab='${t.id}';renderAdminDashboard();" class="px-4 py-2 rounded-xl text-sm font-bold transition-all border ${rankingTab===t.id ? 'bg-lime-500 text-white border-lime-500 shadow-lg shadow-lime-200' : 'bg-white text-gray-500 border-gray-200 hover:bg-gray-50'}">${t.label}</button>`).join('')}
            </div>
        </div>
        
        <div class="flex gap-2">
            <button onclick="exportRankingToExcel()" class="flex items-center gap-2 px-4 py-3 bg-green-600 hover:bg-green-700 text-white rounded-xl font-bold shadow-lg shadow-green-200 transition-all active:scale-95">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                Excel
            </button>
            <button onclick="exportToWord()" class="flex items-center gap-2 px-4 py-3 bg-gradient-to-r from-lime-500 to-green-600 hover:from-lime-600 hover:to-green-700 text-white rounded-xl font-bold shadow-lg shadow-lime-200/50 transition-all active:scale-95">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                Word (.doc)
            </button>
        </div>
    </div>

    <div class="bg-white rounded-3xl shadow-sm overflow-hidden border border-gray-100">
        <div class="p-4 bg-gray-50 border-b border-gray-100 flex justify-between items-center">
            <h3 class="font-bold text-gray-700">${rankingTab === 'all' ? 'รายชื่อทั้งหมด' : 'รายชื่อผู้มีสิทธิ์'}</h3>
            ${rankingTab !== 'all' ? `<div class="text-xs font-bold text-gray-400">ผ่าน: ${renderList.filter(x=>x.status==='pass').length} / ${showQuota}</div>` : ''}
        </div>
        <div class="overflow-x-auto">
            <table class="w-full text-left min-w-[700px]">
                <thead class="bg-white text-gray-600 text-sm uppercase font-bold border-b border-gray-100">
                    <tr>
                        <th class="px-6 py-3 w-20 text-center">ลำดับ</th>
                        <th class="px-6 py-3">รหัส-ชื่อสกุล</th>
                        <th class="px-6 py-3 text-center">คะแนนรวม</th>
                        <th class="px-6 py-3">โครงการที่เลือก</th>
                        <th class="px-6 py-3 text-center">สถานะ</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-50 text-sm">
                    ${renderList.length > 0 ? renderList.map(s => `
                    <tr class="${s.status==='pass' ? 'bg-green-50/50' : (s.status==='fail'?'bg-red-50/50':'')} hover:bg-gray-100 transition-colors">
                        <td class="px-6 py-4 text-center font-bold text-gray-500">#${s.rank}</td>
                        <td class="px-6 py-4">
                            <div class="font-bold text-gray-700">${s.exam_id}</div>
                            <div class="text-xs text-gray-500">${s.full_name}</div>
                        </td>
                        <td class="px-6 py-4 text-center font-bold text-gray-700">${s.total_score.toFixed(2)}</td>
                        <td class="px-6 py-4 text-xs text-gray-500 space-y-1">
                            ${[s.choice_1, s.choice_2, (adminTab!=='m4'?s.choice_3:null)].filter(c=>c).map((c,i)=>`
                                <div class="${rankingTab!=='all' && c.includes({sm:'S&M',gate:'GATE',eis:'EIS',sme:'SME'}[rankingTab]) ? 'font-bold text-lime-600':''}">${i+1}. ${c}</div>
                            `).join('')}
                        </td>
                        <td class="px-6 py-4 text-center">
                            ${rankingTab === 'all' 
                                ? (s.status === 'pass' ? `<span class="text-green-600 font-bold">ผ่านเกณฑ์โครงการ ${s.got_program}</span>` : `<span class="text-gray-400">ไม่ผ่านเกณฑ์</span>`)
                                : (s.status === 'pass' 
                                    ? `<span class="px-3 py-1 rounded-full bg-green-100 text-green-700 font-bold text-xs shadow-sm">ผ่านเกณฑ์</span>` 
                                    : `<span class="px-3 py-1 rounded-full bg-red-100 text-red-600 font-bold text-xs">ไม่ผ่านเกณฑ์</span>`)
                            }
                        </td>
                    </tr>`).join('') : `<tr><td colspan="5" class="text-center py-8 text-gray-400">ไม่มีข้อมูล</td></tr>`}
                </tbody>
            </table>
        </div>
    </div>
    `;
}

// --- ฟังก์ชันส่งออกเป็นไฟล์ Word (.doc) พร้อมข้อความทางการ ---
function exportToWord() {
    // 0. กรองข้อมูลเฉพาะระดับชั้นที่เลือก (สำคัญ: ป้องกันข้อมูลข้ามระดับชั้น)
    const m1 = studentsData.filter(s => ['p4','p5','p6','m1'].includes(s.grade_level));
    const m4 = studentsData.filter(s => ['m3','m4'].includes(s.grade_level));
    const activeData = adminTab === 'm1' ? m1 : m4;

    // 1. คำนวณข้อมูล (ใช้ activeData แทน studentsData)
    const sortedAll = [...activeData].sort((a,b) => b.total_score - a.total_score);
    const currentQuotas = { ...quotas[adminTab] };
    const counts = {};
    Object.keys(currentQuotas).forEach(k => counts[k] = 0);
    const allocationResult = {}; 

    sortedAll.forEach(s => {
        let choices = adminTab === 'm4' ? [s.choice_1, s.choice_2].filter(c=>c) : [s.choice_1, s.choice_2, s.choice_3].filter(c=>c);
        for (const choiceName of choices) {
            if (currentQuotas[choiceName] !== undefined && counts[choiceName] < currentQuotas[choiceName]) {
                allocationResult[s.__backendId] = choiceName;
                counts[choiceName]++;
                break;
            }
        }
    });

    let renderList = [];
    
    if (rankingTab === 'all') {
        renderList = sortedAll.map((s, i) => ({ 
            ...s, rank: i+1, status: allocationResult[s.__backendId] ? 'pass' : 'fail', got_program: allocationResult[s.__backendId] || '-'
        }));
    } else {
        const targetProgram = { 'sm': 'S&M', 'gate': 'GATE', 'eis': 'EIS', 'sme': 'SME' }[rankingTab];
        renderList = sortedAll.filter(s => {
            if (allocationResult[s.__backendId] === targetProgram) return true;
            const isSelectedHere = (s.choice_1 === targetProgram || s.choice_2 === targetProgram || (adminTab !== 'm4' && s.choice_3 === targetProgram));
            const gotOtherPlace = allocationResult[s.__backendId] !== undefined;
            return isSelectedHere && !gotOtherPlace;
        }).map((s, i) => ({
            ...s, rank: sortedAll.findIndex(x => x.__backendId === s.__backendId) + 1,
            status: allocationResult[s.__backendId] === targetProgram ? 'pass' : 'fail'
        }));
    }

    // 2. สร้างเนื้อหา HTML สำหรับ Word
    const tableRows = renderList.length > 0 ? renderList.map(s => `
        <tr>
            <td style="text-align:center;">${s.rank}</td>
            <td style="text-align:center;">${s.exam_id}</td>
            <td>${s.full_name}</td>
            <td style="text-align:center;">${s.total_score.toFixed(2)}</td>
            <td>${[s.choice_1, s.choice_2, (adminTab!=='m4'?s.choice_3:null)].filter(c=>c).map((c,i)=>`${i+1}. ${c}`).join('<br>')}</td>
            <td style="text-align:center;">
                ${rankingTab === 'all' 
                    ? (s.status === 'pass' ? `ผ่านเกณฑ์ห้องเรียนโครงการ ${s.got_program}` : `ไม่ผ่านเกณฑ์`) 
                    : (s.status === 'pass' ? `ผ่านเกณฑ์` : `ไม่ผ่านเกณฑ์`)
                }
            </td>
        </tr>
    `).join('') : `<tr><td colspan="6" style="text-align:center;">ไม่มีข้อมูล</td></tr>`;

    const title = `ประกาศผลสอบห้องเรียนพิเศษ ${adminTab==='m1'?'ม.1':'ม.4'} - ${rankingTab === 'all' ? 'รวม' : rankingTab}`;
    
    const docContent = `
        <html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'>
        <head><meta charset='utf-8'><title>${title}</title>
        <style>
            body { font-family: 'TH Sarabun New', 'Angsana New', sans-serif; font-size: 16pt; }
            table { border-collapse: collapse; width: 100%; margin-top: 10px; }
            td, th { border: 1px solid #000; padding: 5px; vertical-align: top; }
            th { background-color: #f0f0f0; text-align: center; font-weight: bold; }
            .header { text-align: center; margin-bottom: 20px; }
            .footer { margin-top: 50px; width: 100%; text-align: center; }
        </style>
        </head><body>
        
        <div class="header">
            <img src="https://img2.pic.in.th/pic/-69-1.png" width="80" height="auto"><br>
            <b>ประกาศโรงเรียนบางสะพานวิทยา</b><br>
            เรื่อง ผลการสอบคัดเลือกนักเรียนห้องเรียนพิเศษ ระดับชั้นมัธยมศึกษาปีที่ ${adminTab==='m1'?'๑':'๔'}<br>
            ประจำปีการศึกษา ${window.elementSdk?.config?.admission_year || '๒๕๖๙'}<br>
            <br>
            (บัญชีรายชื่อ: ${rankingTab === 'all' ? 'คะแนนรวมทั้งหมด' : 'โครงการ ' + ({ 'sm': 'S&M', 'gate': 'GATE', 'eis': 'EIS', 'sme': 'SME' }[rankingTab])})
        </div>

        <table>
            <thead>
                <tr>
                    <th width="10%">ลำดับ</th>
                    <th width="15%">เลขประจำตัวสอบ</th>
                    <th width="30%">ชื่อ - สกุล</th>
                    <th width="10%">คะแนน</th>
                    <th width="20%">โครงการที่เลือก</th>
                    <th width="15%">สถานะ</th>
                </tr>
            </thead>
            <tbody>${tableRows}</tbody>
        </table>

        <table style="border:none; margin-top:50px;">
            <tr style="border:none;">
                <td style="border:none; text-align:center; padding-top:40px;">ลงชื่อ.........................................กรรมการ<br>(.........................................)</td>
                <td style="border:none; text-align:center; padding-top:40px;">ลงชื่อ.........................................นายทะเบียน<br>(.........................................)</td>
                <td style="border:none; text-align:center; padding-top:40px;">ลงชื่อ.........................................ผู้อำนวยการ<br>(.........................................)</td>
            </tr>
        </table>
        
        </body></html>
    `;

    const blob = new Blob(['\ufeff', docContent], { type: 'application/msword' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `${title}.doc`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}
    
function triggerSearch() { searchQuery = document.getElementById('search-input').value.trim(); renderAdminDashboard(); }

function renderStudentView() {
    const s = currentUser; // ข้อมูลนักเรียนที่ Login อยู่
    if (!s) { renderLogin(); return; }

    // 1. เตรียมข้อมูลคะแนนและสถานะ
    const isM1 = ['p4','p5','p6','m1'].includes(s.grade_level);
    const totalScore = parseFloat(s.total_score) || 0;
    const practicalScore = parseFloat(s.practical_score) || 0;
    const grandTotal = totalScore + practicalScore;

    // คำนวณร้อยละ (สำหรับหลอดสี)
    const maxScore = isM1 ? 120 : 200; // สมมติฐานคะแนนเต็มคร่าวๆ (ปรับแก้ได้)
    
    // --- Logic ตรวจสอบผลการคัดเลือก (Clearing House) ---
    // เพื่อแสดงว่า "ติด" โครงการไหน (เหมือนหน้า Admin)
    const allStudentsInLevel = studentsData.filter(std => isM1 ? ['p4','p5','p6','m1'].includes(std.grade_level) : ['m3','m4'].includes(std.grade_level));
    const sortedByGrandTotal = [...allStudentsInLevel].sort((a,b) => ((b.total_score||0)+(b.practical_score||0)) - ((a.total_score||0)+(a.practical_score||0)));
    const finalRoundQuota = 40; 
    
    const choices = isM1 ? [s.choice_1, s.choice_2, s.choice_3] : [s.choice_1, s.choice_2];
    let passStatus = null;

    for (const choiceName of choices) {
        if (!choiceName) continue;
        const programStudents = sortedByGrandTotal.filter(std => {
            const stdChoices = isM1 ? [std.choice_1, std.choice_2, std.choice_3] : [std.choice_1, std.choice_2];
            return stdChoices.includes(choiceName);
        });
        const rankInProgram = programStudents.findIndex(std => std.__backendId === s.__backendId);

        if (rankInProgram !== -1) {
            // ถ้าอยู่ในโควตา 40 คนแรก
            if (rankInProgram < finalRoundQuota) {
                passStatus = { program: choiceName, type: 'real', rank: rankInProgram + 1 };
                break; // เจอที่ติดแล้วหยุดเลย
            } 
            // ถ้ายังไม่ติดตัวจริงอันดับนี้ ให้เช็คว่าเป็นสำรองไหม (เก็บค่าไว้ก่อน)
            else if (!passStatus) {
                passStatus = { program: choiceName, type: 'reserve', rank: rankInProgram - finalRoundQuota + 1 };
            }
        }
    }

    // 2. เริ่ม Render HTML
    document.getElementById('app').innerHTML = `
    <div class="min-h-screen bg-slate-50 relative overflow-x-hidden font-sarabun pb-10">
        <div class="absolute top-0 left-0 w-full h-[500px] bg-gradient-to-b from-lime-50 to-transparent -z-10"></div>
        <div class="absolute -top-20 -right-20 w-96 h-96 bg-yellow-100/50 rounded-full blur-3xl -z-10 animate-pulse-slow"></div>

        <div class="max-w-4xl mx-auto p-4 md:p-8 animate-fade-in">
            
            <div class="bg-white rounded-[2.5rem] shadow-xl shadow-lime-100/50 border border-lime-100 p-8 md:p-10 mb-8 relative overflow-hidden text-center group">
                <div class="absolute top-0 right-0 w-64 h-64 bg-gradient-to-br from-lime-50 to-yellow-50 rounded-full blur-3xl -mr-20 -mt-20 opacity-60 pointer-events-none group-hover:scale-110 transition-transform duration-700"></div>
                <div class="absolute bottom-0 left-0 w-48 h-48 bg-gradient-to-tr from-blue-50 to-purple-50 rounded-full blur-2xl -ml-10 -mb-10 opacity-60 pointer-events-none"></div>

                <div class="relative z-10 flex flex-col items-center">
                    <img src="https://img5.pic.in.th/file/secure-sv1/-69-1112b7dae5160e09f.png" alt="Logo" class="w-32 h-auto mb-4 drop-shadow-md hover:scale-105 transition-transform duration-300">
                    
                    <h1 class="text-xl md:text-2xl font-black text-lime-900 mb-2 leading-tight">
                        ประกาศผลคะแนนการสอบแข่งขันทักษะวิชาการเพชรราชพฤกษ์
                    </h1>
                    <p class="text-lg md:text-xl font-bold text-lime-700 mb-4">
                        ปีการศึกษา 2569
                    </p>
                    <div class="h-1 w-24 bg-gradient-to-r from-lime-300 to-yellow-400 rounded-full mb-4"></div>
                    <p class="text-gray-600 font-medium">
                        โรงเรียนบางสะพานวิทยา จังหวัดประจวบคีรีขันธ์
                    </p>
                </div>

                <div class="absolute bottom-4 right-4 z-20">
                    <button onclick="currentView='login';render()" class="flex items-center gap-2 px-5 py-2.5 bg-red-50 hover:bg-red-500 text-red-500 hover:text-white rounded-full font-bold text-sm transition-all shadow-sm hover:shadow-md active:scale-95 border border-red-100">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                        ออกจากระบบ
                    </button>
                </div>
            </div>
            <div class="bg-white rounded-3xl shadow-lg border border-gray-100 overflow-hidden mb-8 flex flex-col md:flex-row relative z-10">
                <div class="bg-gradient-to-br from-lime-500 to-green-600 p-8 text-white flex flex-col items-center justify-center md:w-1/3 text-center relative overflow-hidden">
                    <div class="absolute inset-0 bg-white/5 bg-[url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI4IiBoZWlnaHQ9IjgiPgo8cmVjdCB3aWR0aD0iOCIgaGVpZ2h0PSI4IiBmaWxsPSIjZmZmIiBmaWxsLW9wYWNpdHk9IjAuMSIvPgo8cGF0aCBkPSJNMCAwTDggOFpNOCAwTDAgOFoiIHN0cm9rZT0ibm9uZSIvPjwvc3ZnPg==')] opacity-20"></div>
                    <div class="w-20 h-20 bg-white/20 backdrop-blur-sm rounded-full flex items-center justify-center text-2xl font-bold mb-4 border-2 border-white/30 shadow-inner">
                        ${s.exam_id.slice(-3)}
                    </div>
                    <h2 class="text-xl font-bold mb-1 break-words w-full px-2">${s.full_name}</h2>
                    <p class="text-lime-100 text-sm font-medium bg-white/10 px-3 py-1 rounded-full mt-2">รหัสสอบ: ${s.exam_id}</p>
                </div>
                <div class="p-6 md:p-8 md:w-2/3 grid grid-cols-1 md:grid-cols-2 gap-y-6 gap-x-8 bg-white/80 backdrop-blur-xl">
                    <div>
                        <p class="text-xs text-gray-400 font-bold uppercase tracking-wider mb-1">โรงเรียนเดิม</p>
                        <p class="font-bold text-gray-700 text-lg flex items-center gap-2"><svg class="w-5 h-5 text-lime-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path></svg>${s.previous_school || '-'}</p>
                    </div>
                    <div>
                        <p class="text-xs text-gray-400 font-bold uppercase tracking-wider mb-1">ระดับชั้นที่สอบ</p>
                        <p class="font-bold text-gray-700 text-lg flex items-center gap-2"><svg class="w-5 h-5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.747 0-3.332.477-4.5 1.253"></path></svg>${getThaiGrade(s.grade_level)}</p>
                    </div>
                    <div class="md:col-span-2 bg-gray-50 rounded-2xl p-4 border border-gray-100">
                        <p class="text-xs text-gray-400 font-bold uppercase tracking-wider mb-3 flex items-center gap-2">
                            <svg class="w-4 h-4 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path></svg>
                            โครงการที่เลือกสมัคร
                        </p>
                        <div class="flex flex-wrap gap-2">
                            ${choices.filter(c=>c).map((c,i) => `<span class="px-3 py-1.5 bg-white border border-gray-200 rounded-lg text-sm font-bold text-gray-600 flex items-center gap-2 shadow-sm"><span class="w-5 h-5 rounded-full ${i===0?'bg-lime-500 text-white':'bg-gray-200 text-gray-500'} flex items-center justify-center text-xs font-bold">${i+1}</span>${c}</span>`).join('')}
                        </div>
                    </div>
                </div>
            </div>

            ${passStatus && passStatus.type === 'real' ? `
            <div class="bg-gradient-to-r from-green-500 to-emerald-600 rounded-3xl p-1 shadow-lg shadow-green-200 mb-8 transform hover:scale-[1.02] transition-transform duration-300">
                <div class="bg-white rounded-[1.3rem] p-6 text-center relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-green-400 to-emerald-500"></div>
                    <div class="flex flex-col items-center justify-center">
                        <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mb-3 text-green-600 animate-bounce">
                            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        </div>
                        <h3 class="text-2xl font-black text-gray-800 mb-1">ยินดีด้วย! คุณผ่านการคัดเลือก</h3>
                        <p class="text-gray-500 text-sm mb-4">มีสิทธิ์เข้าศึกษาต่อในโครงการ</p>
                        <div class="text-3xl font-black text-transparent bg-clip-text bg-gradient-to-r from-green-600 to-teal-600 mb-2">
                            ${passStatus.program}
                        </div>
                        <span class="px-4 py-1 bg-green-50 text-green-700 rounded-full text-xs font-bold border border-green-100">ตัวจริง ลำดับที่ ${passStatus.rank}</span>
                    </div>
                </div>
            </div>
            ` : (passStatus && passStatus.type === 'reserve' ? `
            <div class="bg-gradient-to-r from-amber-400 to-orange-500 rounded-3xl p-1 shadow-lg shadow-amber-200 mb-8">
                <div class="bg-white rounded-[1.3rem] p-6 text-center">
                    <div class="w-16 h-16 bg-amber-100 rounded-full flex items-center justify-center mb-3 mx-auto text-amber-600">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    </div>
                    <h3 class="text-xl font-bold text-gray-800">ติดบัญชีสำรอง</h3>
                    <div class="text-2xl font-black text-amber-500 mt-2">${passStatus.program}</div>
                    <span class="mt-2 inline-block px-4 py-1 bg-amber-50 text-amber-700 rounded-full text-xs font-bold">ลำดับสำรองที่ ${passStatus.rank}</span>
                </div>
            </div>
            ` : '')}

            <h3 class="text-xl font-bold text-gray-700 mb-4 flex items-center gap-2 px-2">
                <svg class="w-6 h-6 text-lime-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                ผลคะแนนสอบ
            </h3>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div class="bg-gradient-to-br from-gray-800 to-gray-900 rounded-3xl p-6 text-white relative overflow-hidden shadow-lg">
                    <div class="absolute top-0 right-0 w-32 h-32 bg-white opacity-5 rounded-full -mr-10 -mt-10"></div>
                    <p class="text-gray-400 text-sm font-bold uppercase tracking-wider mb-4">คะแนนรวมสุทธิ</p>
                    <div class="flex items-baseline gap-2">
                        <span class="text-5xl font-black text-lime-400">${grandTotal.toFixed(2)}</span>
                        <span class="text-gray-400 text-sm">/ เต็ม ${maxScore}</span>
                    </div>
                    <div class="mt-4 w-full bg-gray-700 h-2 rounded-full overflow-hidden">
                        <div class="bg-gradient-to-r from-lime-400 to-green-500 h-full rounded-full" style="width: ${(grandTotal/maxScore)*100}%"></div>
                    </div>
                </div>

                <div class="bg-white rounded-3xl p-6 border border-gray-100 shadow-sm flex flex-col justify-center gap-4">
                    <div class="flex justify-between items-center pb-3 border-b border-gray-50">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-xl bg-blue-50 text-blue-500 flex items-center justify-center font-bold"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg></div>
                            <div><p class="font-bold text-gray-700">สอบข้อเขียน</p><p class="text-xs text-gray-400">3 วิชาหลัก</p></div>
                        </div>
                        <div class="text-right"><p class="text-xl font-black text-blue-600">${totalScore.toFixed(2)}</p><p class="text-[10px] text-gray-400">เต็ม 100</p></div>
                    </div>
                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-xl bg-purple-50 text-purple-500 flex items-center justify-center font-bold"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path></svg></div>
                            <div><p class="font-bold text-gray-700">สอบปฏิบัติ</p><p class="text-xs text-gray-400">สัมภาษณ์/ปฏิบัติ</p></div>
                        </div>
                        <div class="text-right"><p class="text-xl font-black text-purple-600">${practicalScore > 0 ? practicalScore.toFixed(2) : '-'}</p><p class="text-[10px] text-gray-400">เต็ม ${maxScore - 100}</p></div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-3 gap-2 md:gap-4 mb-8">
                <div class="bg-white p-4 rounded-2xl border border-gray-100 text-center shadow-sm">
                    <p class="text-xs text-gray-400 font-bold mb-1">วิทย์</p>
                    <p class="text-lg font-black text-gray-800">${s.science_score || 0}</p>
                </div>
                <div class="bg-white p-4 rounded-2xl border border-gray-100 text-center shadow-sm">
                    <p class="text-xs text-gray-400 font-bold mb-1">คณิต</p>
                    <p class="text-lg font-black text-gray-800">${s.math_score || 0}</p>
                </div>
                <div class="bg-white p-4 rounded-2xl border border-gray-100 text-center shadow-sm">
                    <p class="text-xs text-gray-400 font-bold mb-1">อังกฤษ</p>
                    <p class="text-lg font-black text-gray-800">${s.english_score || 0}</p>
                </div>
            </div>

        </div>
    </div>
    `;
}
  
function switchAddTab(tabName) { 
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active')); 
    document.getElementById(`tab-${tabName}`).classList.add('active'); 
    // เพิ่ม 'practical' ใน list นี้
    ['single','multiple','excel','score','practical'].forEach(v => document.getElementById(`view-${v}`).classList.add('hidden')); 
    document.getElementById(`view-${tabName}`).classList.remove('hidden'); 
    if(tabName==='multiple') { document.getElementById('multiple-tbody').innerHTML=''; addMultipleRow(); } 
}
function showAddStudentForm() { formMode = 'create'; document.getElementById('modal-title').textContent = 'เพิ่มผู้เข้าสอบใหม่'; document.getElementById('add-mode-tabs').classList.remove('hidden'); document.getElementById('score-section').classList.add('hidden'); switchAddTab('single'); document.getElementById('student-form').reset(); openModal(); }
function showEditForm(id) {
    formMode = 'update';
    document.getElementById('modal-title').textContent = 'แก้ไขข้อมูล';
    document.getElementById('add-mode-tabs').classList.add('hidden');
    ['single','multiple','excel','score'].forEach(v => document.getElementById(`view-${v}`).classList.add('hidden'));
    document.getElementById('view-single').classList.remove('hidden');
    document.getElementById('score-section').classList.remove('hidden');
    
    const s = studentsData.find(x => x.__backendId === id);
    if(!s) return;
    
    document.getElementById('student-backend-id').value = s.__backendId;
    document.getElementById('form-national-id').value = s.national_id || '';
    document.getElementById('form-exam-id').value = s.exam_id;
    document.getElementById('form-grade').value = s.grade_level;
    document.getElementById('form-name').value = s.full_name;
    document.getElementById('form-school').value = s.previous_school;
    
    // -- เพิ่มส่วนดึงข้อมูลโครงการ --
    document.getElementById('form-choice-1').value = s.choice_1 || '';
    document.getElementById('form-choice-2').value = s.choice_2 || '';
    document.getElementById('form-choice-3').value = s.choice_3 || '';
    // -------------------------

    document.getElementById('score-science').value = s.science_score;
    document.getElementById('score-math').value = s.math_score;
    document.getElementById('score-english').value = s.english_score;
    
    openModal();
}

function handleSingleSubmit(e) {
    e.preventDefault();
    const scores = [
        0, 
        parseFloat(document.getElementById('score-math').value)||0, 
        parseFloat(document.getElementById('score-science').value)||0, 
        parseFloat(document.getElementById('score-english').value)||0, 
        0
    ];
    
    const data = {
        exam_id: document.getElementById('form-exam-id').value,
        national_id: document.getElementById('form-national-id').value,
        grade_level: document.getElementById('form-grade').value,
        full_name: document.getElementById('form-name').value,
        previous_school: document.getElementById('form-school').value,
        // -- เพิ่มส่วนบันทึกข้อมูลโครงการ --
        choice_1: document.getElementById('form-choice-1').value,
        choice_2: document.getElementById('form-choice-2').value,
        choice_3: document.getElementById('form-choice-3').value,
        // -----------------------------
        thai_score: scores[0],
        math_score: scores[1],
        science_score: scores[2],
        english_score: scores[3],
        aptitude_score: scores[4],
        total_score: scores.reduce((a,b)=>a+b,0)
    };
    
    showLoading('กำลังบันทึก...');
    const action = formMode === 'create' ? window.dataSdk.create(data) : (data.__backendId = document.getElementById('student-backend-id').value, window.dataSdk.update(data));
    
    action.then(res => {
        setTimeout(() => {
            hideLoading();
            if(res.isOk) {
                closeModal();
                showAlert('สำเร็จ', 'บันทึกเรียบร้อย');
            } else {
                showAlert('ผิดพลาด', res.error.message);
            }
        }, 500);
    });
}
function addMultipleRow() { const tr = document.createElement('tr'); tr.className = 'bg-white border-b hover:bg-gray-50'; tr.innerHTML = `<td class="p-2"><input type="text" class="w-full border rounded px-2 py-1 multi-national-id text-xs" placeholder="บัตรฯ"></td><td class="p-2"><input type="text" class="w-full border rounded px-2 py-1 multi-exam-id text-xs" placeholder="รหัส"></td><td class="p-2"><input type="text" class="w-full border rounded px-2 py-1 multi-name text-xs" placeholder="ชื่อ"></td><td class="p-2"><select class="w-full border rounded px-2 py-1 multi-grade text-xs"><option value="p6">ป.6</option><option value="p5">ป.5</option><option value="p4">ป.4</option><option value="m3">ม.3</option></select></td><td class="p-2"><input type="text" class="w-full border rounded px-2 py-1 multi-school text-xs" placeholder="รร."></td><td class="p-2 text-center"><button type="button" onclick="this.closest('tr').remove()" class="text-red-500 font-bold">x</button></td>`; document.getElementById('multiple-tbody').appendChild(tr); }
function handleMultipleSubmit() { const rows = document.querySelectorAll('#multiple-tbody tr'); const bulkData = []; rows.forEach(row => { const nid = row.querySelector('.multi-national-id').value.trim(); const id = row.querySelector('.multi-exam-id').value.trim(); const name = row.querySelector('.multi-name').value.trim(); if(id && name) bulkData.push({ exam_id: id, national_id: nid, full_name: name, grade_level: row.querySelector('.multi-grade').value, previous_school: row.querySelector('.multi-school').value.trim(), thai_score:0, math_score:0, science_score:0, english_score:0, aptitude_score:0, total_score:0, rank:0 }); }); if(bulkData.length === 0) return showAlert('แจ้งเตือน', 'กรุณากรอกข้อมูลอย่างน้อย 1 รายการ'); showConfirm('ยืนยัน', `เพิ่ม ${bulkData.length} รายการ?`, () => { showLoading('กำลังบันทึก...'); window.dataSdk.createBulk(bulkData).then(res => { setTimeout(() => { hideLoading(); if(res.isOk) { closeModal(); showAlert('สำเร็จ', 'บันทึกเรียบร้อย'); } else { showAlert('ผิดพลาด', res.error.message); } }, 500); }); }); }
function handleExcelUpload(input, type) {
    if(!input.files[0]) return;
    const reader = new FileReader();
    reader.onload = (e) => {
        const workbook = XLSX.read(new Uint8Array(e.target.result), {type: 'array'});
        const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], {header: 1, raw: false, defval: ""});
        
        if(type === 'student') {
            // ... (โค้ดเดิม) ...
            excelDataCache = [];
            for(let i=1; i<jsonData.length; i++) {
                const row = jsonData[i];
                if(row[0] && row[2]) {
                    excelDataCache.push({
                        exam_id: String(row[0]),
                        national_id: String(row[1]||''),
                        full_name: String(row[2]),
                        grade_level: String(row[3]||'m3').toLowerCase(),
                        previous_school: String(row[4]||''),
                        choice_1: String(row[5]||'').trim(),
                        choice_2: String(row[6]||'').trim(),
                        choice_3: String(row[7]||'').trim(),
                        thai_score:0, math_score:0, science_score:0, english_score:0, aptitude_score:0, total_score:0, rank:0, practical_score:0
                    });
                }
            }
            document.getElementById('excel-count').textContent = excelDataCache.length;
            document.getElementById('excel-preview-area').classList.remove('hidden');
            document.getElementById('excel-preview-table').innerHTML = 
                `<thead><tr class="bg-gray-100"><th>รหัส</th><th>ชื่อ</th><th>เลือก 1</th></tr></thead><tbody>` + 
                excelDataCache.slice(0,5).map(p=>`<tr><td>${p.exam_id}</td><td>${p.full_name}</td><td>${p.choice_1}</td></tr>`).join('') + 
                `</tbody>`;
        
        } else if(type === 'score') {
            // ... (โค้ดเดิม) ...
            scoreDataCache = [];
            for(let i=1; i<jsonData.length; i++) {
                const row = jsonData[i];
                if(row[0]) scoreDataCache.push({ exam_id: String(row[0]), science_score: row[1]||0, math_score: row[2]||0, english_score: row[3]||0 });
            }
            document.getElementById('score-count').textContent = scoreDataCache.length;
            document.getElementById('score-preview-area').classList.remove('hidden');
            document.getElementById('score-preview-table').innerHTML = `<thead><tr class="bg-gray-100"><th>รหัส</th><th>วิทย์</th><th>คณิต</th><th>อังกฤษ</th></tr></thead><tbody>` + scoreDataCache.slice(0,5).map(p=>`<tr><td>${p.exam_id}</td><td>${p.science_score}</td><td>${p.math_score}</td><td>${p.english_score}</td></tr>`).join('') + `</tbody>`;
        
        } else if (type === 'practical') {
            // >>> ส่วนที่เพิ่มใหม่สำหรับคะแนนปฏิบัติ <<<
            practicalDataCache = [];
            for(let i=1; i<jsonData.length; i++) {
                const row = jsonData[i];
                const examId = String(row[0]).trim();
                const score = parseFloat(row[1]);

                // ตรวจสอบว่ามีรหัสนี้ในระบบจริงไหม
                const student = studentsData.find(s => String(s.exam_id) === examId);
                
                if(examId && !isNaN(score) && student) {
                    practicalDataCache.push({ 
                        __backendId: student.__backendId, // เก็บ ID จริงไว้ใช้อัปเดต
                        exam_id: examId, 
                        full_name: student.full_name,
                        practical_score: score,
                        original_data: student // เก็บข้อมูลเดิมไว้กันเหนียว
                    });
                }
            }
            document.getElementById('practical-count').textContent = practicalDataCache.length;
            document.getElementById('practical-preview-area').classList.remove('hidden');
            document.getElementById('practical-preview-table').innerHTML = 
                `<thead><tr class="bg-indigo-50 text-indigo-900"><th>รหัส</th><th>ชื่อ</th><th>คะแนนปฏิบัติ</th></tr></thead><tbody>` + 
                practicalDataCache.slice(0,5).map(p=>`<tr><td>${p.exam_id}</td><td>${p.full_name}</td><td class="font-bold text-indigo-700">${p.practical_score}</td></tr>`).join('') + 
                `</tbody>`;
        }
    };
    reader.readAsArrayBuffer(input.files[0]);
}
function confirmExcelImport(type) { 
    if(type === 'student' && excelDataCache.length > 0) { 
        showConfirm('ยืนยัน', `นำเข้า ${excelDataCache.length} รายการ?`, () => { 
            showLoading('กำลังนำเข้า...'); 
            window.dataSdk.createBulk(excelDataCache).then(res => { 
                setTimeout(() => { 
                    hideLoading(); 
                    if(res.isOk) { closeModal(); showAlert('สำเร็จ', 'เรียบร้อย'); } 
                    else { showAlert('ผิดพลาด', res.error.message); } 
                }, 500); 
            }); 
        }); 
    } else if(type === 'score' && scoreDataCache.length > 0) { 
        showConfirm('ยืนยัน', `อัปเดตคะแนน ${scoreDataCache.length} รายการ?`, () => { 
            showLoading('กำลังอัปเดตคะแนน...'); 
            window.dataSdk.updateScoresBulk(scoreDataCache).then(res => { 
                setTimeout(() => { 
                    hideLoading(); 
                    if(res.isOk) { closeModal(); showAlert('สำเร็จ', res.message); } 
                    else { showAlert('ผิดพลาด', res.error.message); } 
                }, 500); 
            }); 
        }); 
    } else if (type === 'practical' && practicalDataCache.length > 0) {
        // >>> ส่วนที่เพิ่มใหม่ <<<
        showConfirm('ยืนยัน', `นำเข้าคะแนนปฏิบัติ ${practicalDataCache.length} รายการ?`, () => {
            showLoading('กำลังบันทึกคะแนนปฏิบัติ... (ห้ามปิดหน้าจอ)');
            
            // เตรียมข้อมูลสำหรับส่ง (Merge ข้อมูลเดิม + คะแนนใหม่)
            const updates = practicalDataCache.map(item => ({
                ...item.original_data, // เอาข้อมูลเดิมทั้งหมด
                practical_score: item.practical_score // ทับด้วยคะแนนใหม่
            }));

            // ใช้ Promise.all ยิง update ทีละคน (ปลอดภัยสุด)
            const promises = updates.map(u => window.dataSdk.update(u));

            Promise.all(promises)
                .then(() => {
                    setTimeout(() => {
                        hideLoading();
                        closeModal();
                        showAlert('สำเร็จ', 'บันทึกคะแนนปฏิบัติเรียบร้อยแล้ว');
                        window.dataSdk.refresh().then(() => renderAdminDashboard());
                    }, 1500);
                })
                .catch(err => {
                    hideLoading();
                    showAlert('ผิดพลาด', 'เกิดข้อผิดพลาด: ' + err.message);
                });
        });
    }
}
function deleteStudent(id) { showConfirm('ยืนยันลบ', 'ลบข้อมูลนี้หรือไม่?', () => { showLoading('กำลังลบ...'); window.dataSdk.delete({__backendId: id}).then(res => { setTimeout(() => { hideLoading(); if(res.isOk) showAlert('สำเร็จ', 'ลบเรียบร้อย'); else showAlert('ผิดพลาด', res.error.message); }, 500); }); }); }
// --- ฟังก์ชันเปิด Modal ให้คะแนนรายบุคคล ---
function showInterviewForm(id, maxScore, programName) {
    const s = studentsData.find(x => x.__backendId === id);
    if (!s) return;

    const sci = parseFloat(s.science_score) || 0;
    const math = parseFloat(s.math_score) || 0;
    const eng = parseFloat(s.english_score) || 0;
    const written = parseFloat(s.total_score) || 0;
    const practical = parseFloat(s.practical_score) || 0;

    const modalHtml = `
    <div id="interview-modal" class="fixed inset-0 flex items-center justify-center z-[150] animate-fade-in px-4">
        
        <style>
            #input-score-modal::-webkit-outer-spin-button,
            #input-score-modal::-webkit-inner-spin-button {
                -webkit-appearance: none;
                margin: 0;
            }
            #input-score-modal {
                -moz-appearance: textfield; /* สำหรับ Firefox */
            }
        </style>

        <div class="absolute w-full h-full bg-gray-900/60 backdrop-blur-sm transition-opacity" onclick="closeInterviewModal()"></div>
        <div class="bg-white w-full max-w-lg rounded-[2rem] shadow-2xl z-[151] overflow-hidden transform scale-100 transition-all relative">
            
            <div class="bg-gradient-to-r from-lime-400 to-lime-500 p-6 pt-8 pb-10 text-white relative overflow-hidden">
                <div class="absolute top-0 right-0 w-32 h-32 bg-white opacity-10 rounded-full -mr-10 -mt-10"></div>
                <button onclick="closeInterviewModal()" class="absolute top-4 right-4 text-white/80 hover:text-white bg-black/10 hover:bg-black/20 rounded-full p-1 transition-all">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
                <div class="text-center relative z-10">
                    <div class="inline-block px-3 py-1 bg-white/20 rounded-full text-xs font-bold mb-2 border border-white/30">
                        โครงการ ${programName}
                    </div>
                    <h2 class="text-2xl font-bold mb-1 drop-shadow-md">${s.full_name}</h2>
                    <p class="text-lime-50 font-medium opacity-90">รหัสสอบ: <span class="font-mono font-bold text-white text-lg">${s.exam_id}</span></p>
                </div>
            </div>

            <div class="p-6 -mt-6 bg-white rounded-t-[2rem] relative z-20">
                <div class="mb-2 text-xs font-bold text-gray-400 uppercase tracking-wider ml-1">ผลคะแนนข้อเขียน</div>
                <div class="grid grid-cols-3 gap-3 mb-4">
                    <div class="bg-blue-50 p-3 rounded-xl text-center border border-blue-100"><div class="text-xs text-blue-400 font-bold mb-1">วิทยาศาสตร์</div><div class="text-xl font-black text-blue-600">${sci}</div></div>
                    <div class="bg-red-50 p-3 rounded-xl text-center border border-red-100"><div class="text-xs text-red-400 font-bold mb-1">คณิตศาสตร์</div><div class="text-xl font-black text-red-600">${math}</div></div>
                    <div class="bg-purple-50 p-3 rounded-xl text-center border border-purple-100"><div class="text-xs text-purple-400 font-bold mb-1">ภาษาอังกฤษ</div><div class="text-xl font-black text-purple-600">${eng}</div></div>
                </div>

                <div class="bg-gray-50 rounded-xl p-4 border border-gray-200 flex justify-between items-center mb-6 shadow-inner">
                    <span class="text-sm font-bold text-gray-500">คะแนนข้อเขียนรวม (100)</span>
                    <span class="text-2xl font-black text-gray-700">${written.toFixed(2)}</span>
                </div>

                <div class="border-t border-gray-100 my-4"></div>

                <label class="block text-sm font-bold text-lime-700 mb-2 pl-1">
                    กรอกคะแนนสอบปฏิบัติ <span class="text-gray-400 font-normal">(เต็ม ${maxScore})</span>
                </label>
                <div class="relative">
                    <input type="number" id="input-score-modal" 
                        class="w-full px-4 py-4 text-center text-3xl font-black text-lime-600 border-2 border-lime-200 rounded-2xl focus:border-lime-500 focus:ring-4 focus:ring-lime-100 outline-none transition-all bg-white"
                        value="${practical > 0 ? practical : ''}" 
                        placeholder="0"
                        min="0" max="${maxScore}" step="0.01"
                        oninput="if(parseFloat(this.value) > ${maxScore}) this.value = ${maxScore}; if(parseFloat(this.value) < 0) this.value = 0;"
                        onkeydown="if(event.key==='Enter') saveSingleInterviewScore('${id}', ${maxScore})"
                    >
                    <div class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 text-sm font-bold">คะแนน</div>
                </div>

                <button onclick="saveSingleInterviewScore('${id}', ${maxScore})" 
                    class="w-full mt-6 py-4 btn-primary text-yellow-900 rounded-2xl font-bold shadow-lg shadow-orange-200/50 active:scale-95 transition-all flex justify-center items-center gap-2 text-lg">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                    บันทึกข้อมูล
                </button>
            </div>
        </div>
    </div>
    `;

    const div = document.createElement('div');
    div.id = 'temp-interview-modal-wrapper';
    div.innerHTML = modalHtml;
    document.body.appendChild(div);
    
    setTimeout(() => document.getElementById('input-score-modal').focus(), 100);
}
function closeInterviewModal() {
    const el = document.getElementById('temp-interview-modal-wrapper');
    if (el) el.remove();
}

// ฟังก์ชันบันทึก (Logic เดิม แต่เปลี่ยนสี Spinner ให้เข้าธีม)
function saveSingleInterviewScore(id, maxScore) {
    const input = document.getElementById('input-score-modal');
    let score = parseFloat(input.value);
    
    if (isNaN(score)) score = 0;
    if (score < 0) score = 0;
    if (score > maxScore) {
        alert(`คะแนนห้ามเกิน ${maxScore} คะแนน`);
        return;
    }

    const studentIndex = studentsData.findIndex(s => s.__backendId === id);
    if (studentIndex === -1) return;

    // *** ส่งข้อมูลทั้งก้อนเพื่อป้องกันข้อมูลหาย ***
    const student = studentsData[studentIndex];
    const updateData = {
        ...student,             
        practical_score: score  
    };

    const btn = document.querySelector('#interview-modal button');
    const originalText = btn.innerHTML;
    // Spinner สีน้ำตาลเข้ม (เข้ากับปุ่มส้ม)
    btn.innerHTML = `<svg class="animate-spin h-5 w-5 text-yellow-900" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> กำลังบันทึก...`;
    btn.disabled = true;

    window.dataSdk.update(updateData).then(res => {
        if (res.isOk) {
            studentsData[studentIndex].practical_score = score;
            closeInterviewModal();
            renderAdminDashboard();
        } else {
            alert('เกิดข้อผิดพลาด: ' + res.error.message);
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    });
}

function closeInterviewModal() {
    const el = document.getElementById('temp-interview-modal-wrapper');
    if (el) el.remove();
}

function saveSingleInterviewScore(id, maxScore) {
    const input = document.getElementById('input-score-modal');
    let score = parseFloat(input.value);
    
    if (isNaN(score)) score = 0;
    if (score < 0) score = 0;
    if (score > maxScore) {
        alert(`คะแนนห้ามเกิน ${maxScore} คะแนน`);
        return;
    }

    const studentIndex = studentsData.findIndex(s => s.__backendId === id);
    if (studentIndex === -1) return;

    // 1. เตรียมข้อมูลสำหรับบันทึก (สำคัญ: ต้องส่งไปทั้งก้อนเพื่อป้องกันข้อมูลหาย)
    const student = studentsData[studentIndex];
    const updateData = {
        ...student,             // Copy ข้อมูลเดิมทั้งหมด (ชื่อ, รหัส, เกรด ฯลฯ)
        practical_score: score  // ทับด้วยคะแนนใหม่
    };

    // 2. แสดงสถานะกำลังบันทึกที่ปุ่ม
    const btn = document.querySelector('#interview-modal button');
    const originalText = btn.innerHTML;
    btn.innerHTML = `<svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> กำลังบันทึก...`;
    btn.disabled = true;

    // 3. ส่งไปบันทึก
    window.dataSdk.update(updateData).then(res => {
        if (res.isOk) {
            // อัปเดตข้อมูลใน Local State
            studentsData[studentIndex].practical_score = score;
            
            // ปิด Modal
            closeInterviewModal();
            
            // รีเฟรชหน้าจอหลักเพื่อเรียงลำดับใหม่
            renderAdminDashboard();
            
            // แจ้งเตือนเล็กๆ (Optional)
            // showAlert('สำเร็จ', 'บันทึกเรียบร้อย'); 
        } else {
            alert('เกิดข้อผิดพลาด: ' + res.error.message);
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    });
}
// --- ฟังก์ชัน Export Excel สำหรับหน้าประกาศผล/จัดลำดับ ---
function exportRankingToExcel() {
    // 1. คำนวณ Logic Clearing House
    const m1 = studentsData.filter(s => ['p4','p5','p6','m1'].includes(s.grade_level));
    const m4 = studentsData.filter(s => ['m3','m4'].includes(s.grade_level));
    const activeData = adminTab === 'm1' ? m1 : m4;

    const sortedAll = [...activeData].sort((a,b) => b.total_score - a.total_score);
    const currentQuotas = { ...quotas[adminTab] };
    const counts = {};
    Object.keys(currentQuotas).forEach(k => counts[k] = 0);
    const allocationResult = {}; 

    sortedAll.forEach(s => {
        let choices = adminTab === 'm4' ? [s.choice_1, s.choice_2].filter(c=>c) : [s.choice_1, s.choice_2, s.choice_3].filter(c=>c);
        for (const choiceName of choices) {
            if (currentQuotas[choiceName] !== undefined && counts[choiceName] < currentQuotas[choiceName]) {
                allocationResult[s.__backendId] = choiceName;
                counts[choiceName]++;
                break;
            }
        }
    });

    let dataList = [];
    const targetProgram = { 'sm': 'S&M', 'gate': 'GATE', 'eis': 'EIS', 'sme': 'SME' }[rankingTab];

    if (rankingTab === 'all') {
        dataList = sortedAll;
    } else {
        dataList = sortedAll.filter(s => {
            if (allocationResult[s.__backendId] === targetProgram) return true;
            const isSelectedHere = (s.choice_1 === targetProgram || s.choice_2 === targetProgram || (adminTab !== 'm4' && s.choice_3 === targetProgram));
            const gotOtherPlace = allocationResult[s.__backendId] !== undefined;
            return isSelectedHere && !gotOtherPlace;
        });
    }

    // 2. แปลงข้อมูลเป็น Format Excel (แก้ไขคำตรงนี้)
    const excelRows = dataList.map((s, i) => {
        let statusText = '';
        
        if (rankingTab === 'all') {
            // กรณีภาพรวม
            statusText = allocationResult[s.__backendId] 
                ? `ผ่านเกณฑ์ห้องเรียนโครงการ ${allocationResult[s.__backendId]}` 
                : 'ไม่ผ่านเกณฑ์';
        } else {
            // กรณีแยกโครงการ
            statusText = (allocationResult[s.__backendId] === targetProgram) 
                ? 'ผ่านเกณฑ์' 
                : 'ไม่ผ่านเกณฑ์';
        }

        return {
            'ลำดับ': i + 1,
            'เลขประจำตัวสอบ': s.exam_id,
            'ชื่อ-นามสกุล': s.full_name,
            'คะแนนรวม': s.total_score,
            'อันดับ 1': s.choice_1 || '-',
            'อันดับ 2': s.choice_2 || '-',
            'อันดับ 3': (adminTab === 'm1' ? s.choice_3 : '-') || '-',
            'ผลการคัดเลือก': statusText
        };
    });

    // 3. สร้างไฟล์
    const ws = XLSX.utils.json_to_sheet(excelRows);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Ranking");
    XLSX.writeFile(wb, `ประกาศผลสอบ_${adminTab}_${rankingTab}.xlsx`);
}
// --- ฟังก์ชัน Export Excel สำหรับหน้าบันทึกคะแนนปฏิบัติ ---
function exportInterviewToExcel() {
    // 1. Logic ดึงข้อมูลเหมือนหน้าจอ Interview
    const sortedForClearing = [...studentsData].sort((a,b) => (b.total_score||0) - (a.total_score||0));
    const currentQuotas = { ...quotas[adminTab] };
    const counts = {};
    Object.keys(currentQuotas).forEach(k => counts[k] = 0);
    const allocationResult = {}; 

    sortedForClearing.forEach(s => {
        let choices = adminTab === 'm4' ? [s.choice_1, s.choice_2].filter(c=>c) : [s.choice_1, s.choice_2, s.choice_3].filter(c=>c);
        for (const choiceName of choices) {
            if (currentQuotas[choiceName] !== undefined && counts[choiceName] < currentQuotas[choiceName]) {
                allocationResult[s.__backendId] = choiceName;
                counts[choiceName]++;
                break;
            }
        }
    });

    const targetProgramName = { 'sm': 'S&M', 'gate': 'GATE', 'eis': 'EIS', 'sme': 'SME' }[rankingTab];
    const finalRoundQuota = 40;

    let interviewList = studentsData.filter(s => allocationResult[s.__backendId] === targetProgramName);
    interviewList = interviewList.map(s => {
        const sci = parseFloat(s.science_score) || 0;
        const math = parseFloat(s.math_score) || 0;
        const eng = parseFloat(s.english_score) || 0;
        const written = parseFloat(s.total_score) || 0;
        const practical = parseFloat(s.practical_score) || 0;
        return { 
            ...s, sci, math, eng, written_score: written, 
            practical_score: practical, grand_total: written + practical 
        };
    }).sort((a, b) => b.grand_total - a.grand_total);

    // 2. แปลงข้อมูลเป็น Format Excel
    const excelRows = interviewList.map((s, i) => ({
        'ลำดับที่': i + 1,
        'รหัสสอบ': s.exam_id,
        'ชื่อ-สกุล': s.full_name,
        'วิทย์': s.sci,
        'คณิต': s.math,
        'อังกฤษ': s.eng,
        'รวมข้อเขียน': s.written_score,
        'คะแนนปฏิบัติ': s.practical_score,
        'รวมสุทธิ': s.grand_total,
        'สถานะ': i < finalRoundQuota ? 'ตัวจริง' : `สำรอง ${i - finalRoundQuota + 1}`
    }));

    // 3. สร้างไฟล์
    const ws = XLSX.utils.json_to_sheet(excelRows);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Scores");
    XLSX.writeFile(wb, `คะแนนสอบปฏิบัติ_${targetProgramName}_${adminTab}.xlsx`);
}
window.addEventListener('load', () => { window.dataSdk.init(dataHandler); render(); });
// --- ฟังก์ชันย่อย 3: หน้าบันทึกคะแนนปฏิบัติ/สัมภาษณ์ (ฉบับปรับปรุง: สวยงาม + โชว์คะแนนดิบ + แก้บั๊กชื่อหาย) ---
// --- ฟังก์ชันย่อย 3: หน้าตารางรายชื่อผู้มีสิทธิ์สอบปฏิบัติ (ธีมสีเขียว/ระบบหลัก) ---
function renderInterviewView(allStudents) {
    const sortedForClearing = [...allStudents].sort((a,b) => (b.total_score||0) - (a.total_score||0));
    const currentQuotas = { ...quotas[adminTab] };
    const counts = {};
    Object.keys(currentQuotas).forEach(k => counts[k] = 0);
    const allocationResult = {}; 

    sortedForClearing.forEach(s => {
        let choices = adminTab === 'm4' ? [s.choice_1, s.choice_2].filter(c=>c) : [s.choice_1, s.choice_2, s.choice_3].filter(c=>c);
        for (const choiceName of choices) {
            if (currentQuotas[choiceName] !== undefined && counts[choiceName] < currentQuotas[choiceName]) {
                allocationResult[s.__backendId] = choiceName;
                counts[choiceName]++;
                break;
            }
        }
    });

    const availablePrograms = adminTab === 'm1' ? ['sm', 'gate', 'eis'] : ['sme', 'gate'];
    if (rankingTab === 'all' || !availablePrograms.includes(rankingTab)) rankingTab = availablePrograms[0];

    const targetProgramName = { 'sm': 'S&M', 'gate': 'GATE', 'eis': 'EIS', 'sme': 'SME' }[rankingTab];
    const maxPractical = targetProgramName === 'S&M' ? 20 : 100;
    const maxTotal = 100 + maxPractical;
    const finalRoundQuota = 40; 

    let interviewList = allStudents.filter(s => allocationResult[s.__backendId] === targetProgramName);
    interviewList = interviewList.map(s => {
        const sci = parseFloat(s.science_score) || 0;
        const math = parseFloat(s.math_score) || 0;
        const eng = parseFloat(s.english_score) || 0;
        const written = parseFloat(s.total_score) || 0;
        const practical = parseFloat(s.practical_score) || 0;
        return { ...s, sci, math, eng, written_score: written, practical_score: practical, grand_total: written + practical };
    }).sort((a, b) => b.grand_total - a.grand_total);

    const tabs = adminTab === 'm1' 
        ? [{ id: 'sm', label: 'S&M' }, { id: 'gate', label: 'GATE' }, { id: 'eis', label: 'EIS' }]
        : [{ id: 'sme', label: 'SME' }, { id: 'gate', label: 'GATE' }];

    return `
    <div class="mb-6 flex flex-col md:flex-row justify-between items-start md:items-end gap-4">
        <div>
            <h1 class="text-2xl md:text-3xl font-bold text-gray-800 mb-2">บันทึกคะแนนปฏิบัติ ${adminTab==='m1'?'ม.1':'ม.4'}</h1>
            <div class="flex flex-wrap gap-2">
                ${tabs.map(t => `<button onclick="rankingTab='${t.id}';renderAdminDashboard();" class="px-5 py-2.5 rounded-xl text-sm font-bold transition-all border shadow-sm ${rankingTab===t.id ? 'bg-lime-500 text-white border-lime-500 shadow-lg shadow-lime-200' : 'bg-white text-gray-500 border-gray-200 hover:bg-gray-50'}">${t.label}</button>`).join('')}
            </div>
        </div>
        
        <div class="flex gap-2">
            <button onclick="exportInterviewToExcel()" class="flex items-center gap-2 px-4 py-3 bg-green-600 hover:bg-green-700 text-white rounded-xl font-bold shadow-lg shadow-green-200 transition-all active:scale-95">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                Excel
            </button>
            <button onclick="exportInterviewToWord()" class="flex items-center gap-2 px-4 py-3 bg-gradient-to-r from-lime-500 to-green-600 hover:from-lime-600 hover:to-green-700 text-white rounded-xl font-bold shadow-lg shadow-lime-200/50 transition-all active:scale-95">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                Word (.doc)
            </button>
        </div>
    </div>

    <div class="bg-white rounded-[2rem] shadow-sm border border-gray-100 overflow-hidden">
        <div class="p-6 bg-lime-50/50 border-b border-lime-100 flex justify-between items-center">
            <div>
                <h3 class="font-bold text-lime-800 text-lg flex items-center gap-2"><span class="w-2 h-6 bg-lime-500 rounded-full inline-block"></span> โครงการ ${targetProgramName}</h3>
                <p class="text-xs text-lime-600 mt-1 pl-4">คะแนนเต็ม: ข้อเขียน (100) + ปฏิบัติ (${maxPractical}) = ${maxTotal}</p>
            </div>
            <div class="text-sm font-bold text-gray-500 bg-white px-4 py-2 rounded-xl shadow-sm">จำนวนผู้มีสิทธิ์: <span class="text-lime-600 text-lg">${interviewList.length}</span> คน</div>
        </div>
        
        <div class="overflow-x-auto">
            <table class="w-full text-left border-collapse">
                <thead>
                    <tr class="bg-gray-50 text-gray-500 text-xs uppercase font-bold tracking-wider">
                        <th class="px-4 py-4 w-12 text-center border-b border-gray-100">ที่</th>
                        <th class="px-4 py-4 border-b border-gray-100">ผู้เข้าสอบ</th>
                        <th class="px-2 py-4 text-center border-b border-gray-100 text-blue-500">วิทย์<br>(40)</th>
                        <th class="px-2 py-4 text-center border-b border-gray-100 text-red-500">คณิต<br>(30)</th>
                        <th class="px-2 py-4 text-center border-b border-gray-100 text-purple-500">อังกฤษ<br>(30)</th>
                        <th class="px-4 py-4 text-center border-b border-gray-100 bg-gray-50">รวมข้อเขียน<br>(100)</th>
                        <th class="px-4 py-4 text-center border-b border-lime-100 bg-lime-50 text-lime-700">คะแนนปฏิบัติ<br>(เต็ม ${maxPractical})</th>
                        <th class="px-4 py-4 text-center border-b border-gray-100">รวมสุทธิ<br>(เต็ม ${maxTotal})</th>
                        <th class="px-4 py-4 text-center border-b border-gray-100">สถานะ</th>
                        <th class="px-4 py-4 text-center border-b border-gray-100">จัดการ</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-50 text-sm">
                    ${interviewList.length > 0 ? interviewList.map((s, i) => `
                    <tr class="hover:bg-lime-50/30 transition-colors group">
                        <td class="px-4 py-4 text-center font-bold text-gray-400 group-hover:text-lime-600">#${i+1}</td>
                        <td class="px-4 py-4">
                            <div class="font-bold text-gray-800">${s.full_name}</div>
                            <div class="text-xs text-gray-400 font-mono mt-0.5">${s.exam_id}</div>
                        </td>
                        <td class="px-2 py-4 text-center font-medium text-gray-500">${s.sci}</td>
                        <td class="px-2 py-4 text-center font-medium text-gray-500">${s.math}</td>
                        <td class="px-2 py-4 text-center font-medium text-gray-500">${s.eng}</td>
                        <td class="px-4 py-4 text-center font-bold text-gray-700 bg-gray-50 group-hover:bg-lime-50/20">${s.written_score.toFixed(2)}</td>
                        <td class="px-4 py-4 text-center font-bold text-lime-700 bg-lime-50/20">${s.practical_score > 0 ? s.practical_score.toFixed(2) : '-'}</td>
                        <td class="px-4 py-4 text-center font-black text-gray-800 text-lg">${s.grand_total.toFixed(2)}</td>
                        <td class="px-4 py-4 text-center">
                            ${i < finalRoundQuota ? `<span class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full bg-green-100 text-green-700 font-bold text-xs border border-green-200">ตัวจริง</span>` : `<span class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full bg-orange-50 text-orange-600 font-bold text-xs border border-orange-100">สำรอง #${i - finalRoundQuota + 1}</span>`}
                        </td>
                        <td class="px-4 py-4 text-center">
                            <button onclick="showInterviewForm('${s.__backendId}', ${maxPractical}, '${targetProgramName}')" class="px-4 py-2 bg-lime-100 hover:bg-lime-200 text-lime-700 rounded-xl text-xs font-bold shadow-sm active:scale-95 transition-all flex items-center justify-center gap-2 mx-auto border border-lime-200"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>ให้คะแนน</button>
                        </td>
                    </tr>`).join('') : `<tr><td colspan="10" class="text-center py-12 text-gray-400">ไม่มีข้อมูล</td></tr>`}
                </tbody>
            </table>
        </div>
    </div>
    <div id="interview-modal-container"></div>
    `;
}
// ฟังก์ชันบันทึกคะแนนปฏิบัติ (อัปเดตและเรียงลำดับใหม่ทันที)
function updatePracticalScore(id, value, max) {
    let score = parseFloat(value);
    if (isNaN(score)) score = 0;
    if (score < 0) score = 0;
    
    // ตรวจสอบค่าเกิน
    if (score > max) {
        alert(`คะแนนปฏิบัติห้ามเกิน ${max} คะแนน`);
        // รีเซ็ตค่าใน input ให้กลับมาเป็นค่า max (ต้องหา element ให้เจอ หรือปล่อยให้ render ใหม่จัดการ)
        score = max;
    }

    const studentIndex = studentsData.findIndex(s => s.__backendId === id);
    if (studentIndex !== -1) {
        // อัปเดตข้อมูลใน RAM
        studentsData[studentIndex].practical_score = score;
        
        // สั่งวาดหน้าจอใหม่ทันที (รายชื่อจะขยับขึ้นลงตามคะแนนใหม่)
        renderAdminDashboard(); 
        
        // ส่งข้อมูลไปบันทึกที่ Google Sheets (Backend)
        window.dataSdk.update({ 
            __backendId: id, 
            practical_score: score 
        }).then(res => {
            if(!res.isOk) console.error('Auto-save failed:', res.error);
        });
    }
}
// ฟังก์ชันบันทึกคะแนนปฏิบัติ (ทำงานทันทีเมื่อพิมพ์เสร็จ)
function updatePracticalScore(id, value, max) {
    let score = parseFloat(value);
    if (isNaN(score)) score = 0;
    if (score < 0) score = 0;
    if (score > max) {
        alert(`คะแนนปฏิบัติห้ามเกิน ${max} คะแนนครับ`);
        score = max;
    }

    // 1. อัปเดตข้อมูลในตัวแปรทันที (เพื่อให้หน้าจอขยับเปลี่ยนลำดับเลย)
    const studentIndex = studentsData.findIndex(s => s.__backendId === id);
    if (studentIndex !== -1) {
        studentsData[studentIndex].practical_score = score;
        
        // สั่งให้วาดหน้าจอใหม่ (Re-render) เพื่อเรียงลำดับคนที่ได้คะแนนเยอะขึ้นไปข้างบน
        renderAdminDashboard(); 
        
        // 2. ส่งข้อมูลไปเก็บที่ Server (Google Sheets)
        window.dataSdk.update({ 
            __backendId: id, 
            practical_score: score 
        }).then(res => {
            if(!res.isOk) console.error('บันทึกไม่สำเร็จ:', res.error);
        });
    }
}
    // คำนวณคะแนนรวมทันทีที่พิมพ์ (Frontend Only) ไม่ต้องโหลดหน้าใหม่
function calculateRow(input, maxTotal, maxScore) {
    let val = parseFloat(input.value);
    
    // ถ้าลบจนว่าง ให้ถือเป็น 0
    if (input.value === '') {
        val = 0;
    }

    if (isNaN(val)) val = 0;
    if (val < 0) {
        val = 0;
        input.value = 0;
    }

    // *** ตรวจสอบค่าเกิน (Logic ใหม่) ***
    if (val > maxScore) {
        // ไม่ต้อง Alert ให้รำคาญใจ แต่แก้ค่าให้เป็น Max ทันที
        val = maxScore;
        input.value = maxScore; 
    }

    const row = input.closest('tr');
    // ดึงคะแนนข้อเขียนจาก attribute data-written ที่ฝังไว้ (ถ้าไม่มีให้คำนวณจาก cell)
    // แต่ใน renderInterviewView เราไม่ได้ฝัง data-written ไว้ใน <td> 
    // ดังนั้นเราจะดึงจาก cell ที่ 5 (รวมข้อเขียน)
    // หมายเหตุ: เพื่อความแม่นยำ ผมแนะนำให้ใช้ data-written ใน tr ที่ผมใส่ไว้ในโค้ดก่อนหน้า
    // หรือดึงจาก innerText ของ cell ก็ได้
    
    // วิธีดึงจาก Cell รวมข้อเขียน (Column index 5 - เริ่มนับจาก 0)
    const cells = row.getElementsByTagName('td');
    const writtenText = cells[5].innerText; // ช่องรวมข้อเขียน
    const written = parseFloat(writtenText) || 0;
    
    const total = written + val;

    // อัปเดตตัวเลขรวมในตารางทันที
    // ช่องรวมสุทธิคือ cells[7]
    if(cells[7]) cells[7].textContent = total.toFixed(2);
}

// ฟังก์ชันบันทึกข้อมูล (ทำงานเมื่อกดปุ่มสีเขียว)
function savePracticalScores() {
    const inputs = document.querySelectorAll('.input-practical');
    const updates = [];
    
    // 1. วนลูปเก็บข้อมูลจากทุกช่องที่กรอก
    inputs.forEach(input => {
        const row = input.closest('tr');
        const id = row.dataset.id; // Backend ID
        let score = parseFloat(input.value);
        
        // Validation: ถ้าไม่ใช่ตัวเลข หรือติดลบ ให้เป็น 0
        if (isNaN(score)) score = 0;
        if (score < 0) score = 0;

        // ดึงข้อมูลนักเรียนคนนั้นจาก Memory (ข้อมูลเดิมที่ครบถ้วน)
        const originalStudent = studentsData.find(s => s.__backendId === id);
        
        if (originalStudent) {
            // อัปเดตคะแนนลงใน Memory
            originalStudent.practical_score = score;

            // *** จุดสำคัญที่แก้ไข ***
            // สร้าง Object ใหม่โดยคัดลอกข้อมูลเดิมทั้งหมด (...) แล้วทับด้วยคะแนนใหม่
            // เพื่อให้ Exam_ID, Name, Grade ฯลฯ ติดไปด้วย ไม่เป็น undefined
            const payload = {
                ...originalStudent,      // Copy ข้อมูลเดิมทั้งหมด (Exam ID, Name, etc.)
                practical_score: score   // เอาคะแนนใหม่ทับลงไป
            };

            updates.push(payload);
        }
    });

    if (updates.length === 0) {
        showAlert('แจ้งเตือน', 'ไม่พบข้อมูลที่ต้องบันทึก');
        return;
    }

    // 2. ส่งข้อมูลไป Google Apps Script (Batch Update)
    showLoading('กำลังบันทึกคะแนน... (กรุณารอสักครู่)');
    
    // ใช้ Promise.all เพื่อยิง Update ทีละคน (ปลอดภัยที่สุดสำหรับ Google Apps Script ทั่วไป)
    const promises = updates.map(u => window.dataSdk.update(u));

    Promise.all(promises)
        .then(() => {
            setTimeout(() => {
                hideLoading();
                showAlert('สำเร็จ', 'บันทึกข้อมูลและคะแนนสอบปฏิบัติเรียบร้อยแล้ว');
                // โหลดหน้าจอใหม่เพื่อให้มั่นใจว่าข้อมูลล่าสุดถูกต้อง
                window.dataSdk.refresh().then(() => {
                    renderAdminDashboard();
                });
            }, 1500);
        })
        .catch(err => {
            hideLoading();
            showAlert('ผิดพลาด', 'เกิดข้อผิดพลาดในการบันทึก: ' + err.message);
            console.error(err);
        });
}
    // --- ฟังก์ชันส่งออกรายงานคะแนนปฏิบัติเป็น Word (แบบละเอียด) ---
function exportInterviewToWord() {
    // 1. Logic ดึงข้อมูล (เหมือน renderInterviewView เป๊ะๆ เพื่อให้ข้อมูลตรงกัน)
    const sortedForClearing = [...studentsData].sort((a,b) => (b.total_score||0) - (a.total_score||0));
    const currentQuotas = { ...quotas[adminTab] };
    const counts = {};
    Object.keys(currentQuotas).forEach(k => counts[k] = 0);
    const allocationResult = {}; 

    sortedForClearing.forEach(s => {
        let choices = adminTab === 'm4' ? [s.choice_1, s.choice_2].filter(c=>c) : [s.choice_1, s.choice_2, s.choice_3].filter(c=>c);
        for (const choiceName of choices) {
            if (currentQuotas[choiceName] !== undefined && counts[choiceName] < currentQuotas[choiceName]) {
                allocationResult[s.__backendId] = choiceName;
                counts[choiceName]++;
                break;
            }
        }
    });

    const targetProgramName = { 'sm': 'S&M', 'gate': 'GATE', 'eis': 'EIS', 'sme': 'SME' }[rankingTab];
    const maxPractical = targetProgramName === 'S&M' ? 20 : 100;
    const maxTotal = 100 + maxPractical;
    const finalRoundQuota = 40;

    // กรองและเรียงลำดับ
    let interviewList = studentsData.filter(s => allocationResult[s.__backendId] === targetProgramName);
    interviewList = interviewList.map(s => {
        const sci = parseFloat(s.science_score) || 0;
        const math = parseFloat(s.math_score) || 0;
        const eng = parseFloat(s.english_score) || 0;
        const written = parseFloat(s.total_score) || 0;
        const practical = parseFloat(s.practical_score) || 0;
        return { 
            ...s, sci, math, eng, written_score: written, 
            practical_score: practical, grand_total: written + practical 
        };
    }).sort((a, b) => b.grand_total - a.grand_total);

    // 2. สร้างตาราง HTML สำหรับ Word
    const tableRows = interviewList.length > 0 ? interviewList.map((s, i) => `
        <tr>
            <td style="text-align:center;">${i+1}</td>
            <td style="text-align:center;">${s.exam_id}</td>
            <td>${s.full_name}</td>
            <td style="text-align:center;">${s.sci}</td>
            <td style="text-align:center;">${s.math}</td>
            <td style="text-align:center;">${s.eng}</td>
            <td style="text-align:center; font-weight:bold;">${s.written_score.toFixed(2)}</td>
            <td style="text-align:center; font-weight:bold;">${s.practical_score.toFixed(2)}</td>
            <td style="text-align:center; font-weight:bold; background-color:#f9f9f9;">${s.grand_total.toFixed(2)}</td>
            <td style="text-align:center;">
                ${i < finalRoundQuota ? 'ตัวจริง' : 'สำรองลำดับที่ ' + (i - finalRoundQuota + 1)}
            </td>
        </tr>
    `).join('') : `<tr><td colspan="10" style="text-align:center;">ไม่มีข้อมูล</td></tr>`;

    const title = `แบบบันทึกคะแนนสอบคัดเลือก (รอบปฏิบัติ/สัมภาษณ์) โครงการ ${targetProgramName} - ${adminTab==='m1'?'ม.1':'ม.4'}`;
    
    const docContent = `
        <html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'>
        <head><meta charset='utf-8'><title>${title}</title>
        <style>
            body { font-family: 'TH Sarabun New', 'Angsana New', sans-serif; font-size: 16pt; }
            table { border-collapse: collapse; width: 100%; margin-top: 15px; font-size: 14pt; }
            td, th { border: 1px solid #000; padding: 4px; vertical-align: middle; }
            th { background-color: #f0f0f0; text-align: center; font-weight: bold; }
            .header { text-align: center; margin-bottom: 20px; }
        </style>
        </head><body>
        
        <div class="header">
            <img src="https://img2.pic.in.th/pic/-69-1.png" width="70" height="auto"><br>
            <b>แบบสรุปผลคะแนนการสอบคัดเลือกนักเรียนห้องเรียนพิเศษ (รอบสัมภาษณ์/ปฏิบัติ)</b><br>
            โครงการ ${targetProgramName} ระดับชั้นมัธยมศึกษาปีที่ ${adminTab==='m1'?'๑':'๔'}<br>
            ประจำปีการศึกษา ${window.elementSdk?.config?.admission_year || '๒๕๖๙'}
        </div>

        <table>
            <thead>
                <tr>
                    <th rowspan="2" width="5%">ที่</th>
                    <th rowspan="2" width="10%">รหัสสอบ</th>
                    <th rowspan="2" width="20%">ชื่อ - สกุล</th>
                    <th colspan="4">คะแนนสอบข้อเขียน (100 คะแนน)</th>
                    <th rowspan="2" width="10%">ปฏิบัติ<br>(${maxPractical})</th>
                    <th rowspan="2" width="10%">รวมสุทธิ<br>(${maxTotal})</th>
                    <th rowspan="2" width="10%">ผลการ<br>คัดเลือก</th>
                </tr>
                <tr>
                    <th width="7%">วิทย์<br>(40)</th>
                    <th width="7%">คณิต<br>(30)</th>
                    <th width="7%">อังกฤษ<br>(30)</th>
                    <th width="8%">รวม</th>
                </tr>
            </thead>
            <tbody>${tableRows}</tbody>
        </table>

        <div style="margin-top: 40px; width: 100%; text-align: center;">
            <table style="border:none; width:100%">
                <tr style="border:none;">
                    <td style="border:none; text-align:center;">ลงชื่อ................................................กรรมการ<br>(................................................)</td>
                    <td style="border:none; text-align:center;">ลงชื่อ................................................กรรมการ<br>(................................................)</td>
                </tr>
                <tr style="border:none;">
                    <td colspan="2" style="border:none; text-align:center; padding-top: 30px;">
                        ลงชื่อ................................................ประธานกรรมการ<br>
                        (................................................)
                    </td>
                </tr>
            </table>
        </div>
        
        </body></html>
    `;

    const blob = new Blob(['\ufeff', docContent], { type: 'application/msword' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `${title}.doc`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}
</script>
</body>
</html>
